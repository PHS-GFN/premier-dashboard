<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier High School - Gallery North Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }
        
        .main-view, .advisor-view, .student-view {
            display: none;
        }
        
        .main-view.active, .advisor-view.active, .student-view.active {
            display: block;
        }
        
        .back-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: #5568d3;
            transform: translateX(-5px);
        }
        
        .wins-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .wins-banner h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wins-list {
            display: grid;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .win-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .win-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .metrics-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .metrics-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metrics-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .challenges h3 { color: #ef4444; }
        .celebrations h3 { color: #10b981; }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.95rem;
            color: #666;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .status-good { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-danger { color: #ef4444; }
        
        .advisor-spotlight {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .advisor-spotlight h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }
        
        .advisor-spotlight-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .spotlight-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .spotlight-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
        }
        
        .spotlight-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .spotlight-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .highlights-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .highlights-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .highlight-card {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .highlight-card h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .highlight-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .highlight-students {
            font-size: 0.9rem;
            color: #666;
        }
        
        .momentum-tracker-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .momentum-tracker-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .momentum-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .momentum-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .momentum-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .momentum-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .momentum-btn-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }
        
        .advisor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .advisor-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-top: 4px solid #667eea;
        }
        
        .advisor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .advisor-card-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .advisor-card-stats {
            display: grid;
            gap: 0.5rem;
        }
        
        .advisor-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        
        .advisor-stat-row:last-child {
            border-bottom: none;
        }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .controls-row {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .search-box {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .student-table {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        th.sortable:hover {
            background: #e2e8f0;
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        .student-name-link {
            color: #667eea;
            cursor: pointer;
            font-weight: 500;
        }
        
        .student-name-link:hover {
            text-decoration: underline;
        }
        
        .tier-1 { color: #ef4444; font-weight: bold; }
        .tier-2 { color: #f59e0b; font-weight: bold; }
        .tier-3 { color: #3b82f6; }
        .tier-4 { color: #10b981; }
        
        .trajectory-breakthrough { color: #10b981; }
        .trajectory-building { color: #059669; }
        .trajectory-stable { color: #3b82f6; }
        .trajectory-declining { color: #f59e0b; }
        .trajectory-rapid_decline { color: #ef4444; }
        
        .student-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .student-view-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .student-view-meta {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .student-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .student-metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .student-metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .student-metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .student-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .student-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .achievement-list, .concern-list {
            list-style: none;
            padding: 0;
        }
        
        .achievement-list li, .concern-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9ff;
        }
        
        .achievement-list li {
            border-left: 4px solid #10b981;
        }
        
        .concern-list li {
            border-left: 4px solid #ef4444;
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Premier High School - Gallery North</h1>
        <div class="subtitle">Student Progress Dashboard</div>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">
            üìä Loading data from Google Sheets...
        </div>

        <!-- Main Dashboard View -->
        <div id="mainView" class="main-view">
            <!-- Wins Banner -->
            <div class="wins-banner">
                <h2>üèÜ This Period's Wins</h2>
                <div class="wins-list" id="winsList"></div>
            </div>

            <!-- Advisor Spotlight -->
            <div class="advisor-spotlight" id="advisorSpotlight"></div>

            <!-- Metrics Split -->
            <div class="metrics-split">
                <div class="metrics-section challenges">
                    <h3>‚ö†Ô∏è Areas of Concern</h3>
                    <div class="metric-row">
                        <span class="metric-label">Crisis Students</span>
                        <span class="metric-value status-danger" id="crisisCount">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">High Risk Students</span>
                        <span class="metric-value status-warning" id="riskCount">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Students Below Target</span>
                        <span class="metric-value status-warning" id="belowTarget">-</span>
                    </div>
                </div>
                
                <div class="metrics-section celebrations">
                    <h3>‚ú® Celebrations</h3>
                    <div class="metric-row">
                        <span class="metric-label">Students On Track or Ahead</span>
                        <span class="metric-value status-good" id="onTrackCount">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Students Improving</span>
                        <span class="metric-value status-good" id="improvingCount">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Tier Promotions</span>
                        <span class="metric-value status-good" id="promotionsCount">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Average Attendance</span>
                        <span class="metric-value" id="avgAttendance">-</span>
                    </div>
                </div>
            </div>
            
            <!-- This Week's Stars -->
            <div class="highlights-section">
                <h2>‚≠ê This Week's Stars</h2>
                <div class="highlights-grid" id="highlightsGrid"></div>
            </div>
            
            <!-- Momentum Tracker -->
            <div class="momentum-tracker-section">
                <h2>üéØ Student Momentum Tracker</h2>
                <div class="momentum-buttons" id="momentumButtons"></div>
            </div>
            
            <!-- Momentum Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <span>üìä Student Momentum Direction Over Time</span>
                </div>
                <canvas id="momentumChart" height="100"></canvas>
            </div>
            
            <!-- Advisor Performance -->
            <div class="section-header">üë• Advisor Performance (Click to View Students)</div>
            <div class="advisor-grid" id="advisorGrid"></div>

            <!-- Main Student Dashboard -->
            <div class="section-header">üë®‚Äçüéì All Students Dashboard</div>
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search students by name...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">üî¥ Crisis</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">üü† High Risk</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">üü° Watch</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">üü¢ On Track</button>
                    </div>
                </div>
                <div class="controls-row">
                    <strong>Trajectory:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="trajectory">All</button>
                        <button class="filter-btn" data-filter="breakthrough" data-type="trajectory">üöÄ Breakthrough</button>
                        <button class="filter-btn" data-filter="building" data-type="trajectory">üìà Building</button>
                        <button class="filter-btn" data-filter="stable" data-type="trajectory">üü¢ Stable</button>
                        <button class="filter-btn" data-filter="declining" data-type="trajectory">üìâ Declining</button>
                        <button class="filter-btn" data-filter="rapid_decline" data-type="trajectory">üîª Rapid Decline</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="acceleration">Acceleration</th>
                                <th>Pattern</th>
                                <th>Badges</th>
                                <th class="sortable" data-sort="behind">Behind/Ahead</th>
                                <th class="sortable" data-sort="units">Units</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Advisor View -->
        <div id="advisorView" class="advisor-view">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Dashboard</button>
            <div class="advisor-view-header" id="advisorViewHeader"></div>
            
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="advisorSearchBox" placeholder="üîç Search students...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">üî¥ Crisis</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">üü† High Risk</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">üü° Watch</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">üü¢ On Track</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="advisorStudentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="acceleration">Acceleration</th>
                                <th>Pattern</th>
                                <th>Badges</th>
                                <th class="sortable" data-sort="behind">Behind/Ahead</th>
                                <th class="sortable" data-sort="units">Units</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="advisorStudentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Student View -->
        <div id="studentView" class="student-view">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Dashboard</button>
            <div class="student-view-header" id="studentViewHeader"></div>
            
            <div class="student-metrics-grid" id="studentMetricsGrid"></div>
            
            <div class="student-section">
                <div class="student-section-title">üìà Progress Over Semester</div>
                <div class="student-chart-container">
                    <canvas id="studentProgressChart"></canvas>
                </div>
            </div>
            
            <div class="student-section">
                <div class="student-section-title">üéØ Consistency Pattern</div>
                <div id="studentPatternDetail"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                <div class="student-section">
                    <div class="student-section-title">üèÜ Achievements</div>
                    <ul class="achievement-list" id="studentAchievements"></ul>
                </div>
                
                <div class="student-section">
                    <div class="student-section-title">‚ö†Ô∏è Concerns & Recommendations</div>
                    <ul class="concern-list" id="studentConcerns"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" id="lastUpdate">
        Last Updated: -
    </div>

    <script>
        // ================== CONFIGURATION ==================
        const SHEET_ID = '1QZIDSV1l7mee6WUTgjeuKr6drmp97pDBF68jYD00ieA';
        const SHEET_NAME = 'Dashboard_Data';
        const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        
        // ================== GLOBAL STATE ==================
        let dashboardData = null;
        let currentAdvisor = null;
        let currentStudent = null;
        let currentFilters = {
            tier: 'all',
            trajectory: 'all',
            search: ''
        };
        let currentSort = {
            column: 'velocity',
            direction: 'desc'
        };
        let momentumChart = null;
        let studentProgressChart = null;
        
        // ================== DATA LOADING ==================
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                const csvText = await response.text();
                const rawData = parseCSV(csvText);
                console.log(`Loaded ${rawData.length} rows from Google Sheets`);
                dashboardData = processData(rawData);
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    '‚ùå Error loading data. Please check your Google Sheets share settings.<br><small>Make sure "Anyone with the link can view" is enabled.</small>';
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (line[i] === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += line[i];
                }
            }
            result.push(current);
            return result;
        }
        
        // ================== DATA PROCESSING ==================
        function processData(data) {
            // Group data by student
            const studentMap = new Map();
            
            data.forEach(row => {
                const name = row['Student Name'];
                if (!name) return;
                
                if (!studentMap.has(name)) {
                    studentMap.set(name, []);
                }
                
                studentMap.get(name).push({
                    date: new Date(row.Week_Date),
                    week: row.Week_Date,
                    advisor: row.Advisor,
                    attendance: parseFloat(row['% Present']) || 0,
                    expected: parseFloat(row['Units Expected']) || 0,
                    completed: parseInt(row['# Units Completed']) || 0
                });
            });
            
            // Calculate metrics for each student
            const students = [];
            
            studentMap.forEach((records, name) => {
                records.sort((a, b) => a.date - b.date);
                
                if (records.length === 0) return;
                
                const latest = records[records.length - 1];
                const earliest = records[0];
                const firstRecord = records[0];
                
                // Calculate velocity
                const weeks = records.length > 1 ? records.length - 1 : 1;
                const unitsGained = latest.completed - earliest.completed;
                const velocity = weeks > 0 ? unitsGained / weeks : 0;
                
                // Calculate acceleration
                let acceleration = 0;
                let earlyVelocity = 0;
                let recentVelocity = 0;
                
                if (records.length >= 3) {
                    const midPoint = Math.floor(records.length / 2);
                    const firstHalf = records.slice(0, midPoint);
                    const secondHalf = records.slice(midPoint);
                    
                    earlyVelocity = firstHalf.length > 1 ? 
                        (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                    recentVelocity = secondHalf.length > 1 ?
                        (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                    
                    acceleration = recentVelocity - earlyVelocity;
                }
                
                // Calculate tracking
                const tracking = latest.completed - latest.expected;
                
                // Determine tier
                let tier = 4;
                let tierLabel = 'On Track';
                if (tracking < 0) {
                    tier = 3;
                    tierLabel = 'Watch';
                }
                if (tracking < -5) {
                    tier = 2;
                    tierLabel = 'High Risk';
                }
                if (tracking < -10) {
                    tier = 1;
                    tierLabel = 'Crisis';
                }
                
                // Determine first tier
                const firstTracking = firstRecord.completed - firstRecord.expected;
                let firstTier = 4;
                if (firstTracking < 0) firstTier = 3;
                if (firstTracking < -5) firstTier = 2;
                if (firstTracking < -10) firstTier = 1;
                
                const tierChange = tier - firstTier;
                
                // Determine trajectory
                let trajectory = 'stable';
                let trajectoryLabel = 'Stable';
                let trajectoryIcon = 'üü¢';
                
                if (acceleration > 1.5) {
                    trajectory = 'breakthrough';
                    trajectoryLabel = 'Breakthrough';
                    trajectoryIcon = 'üöÄ';
                } else if (acceleration > 0.5) {
                    trajectory = 'building';
                    trajectoryLabel = 'Building Momentum';
                    trajectoryIcon = 'üìà';
                } else if (acceleration < -1.5) {
                    trajectory = 'rapid_decline';
                    trajectoryLabel = 'Rapid Decline';
                    trajectoryIcon = 'üîª';
                } else if (acceleration < -0.5) {
                    trajectory = 'declining';
                    trajectoryLabel = 'Declining';
                    trajectoryIcon = 'üìâ';
                }
                
                // Average attendance
                const avgAttendance = records.reduce((sum, r) => sum + r.attendance, 0) / records.length;
                
                // Days since last activity
                const daysSince = Math.floor((new Date() - latest.date) / (1000 * 60 * 60 * 24));
                
                // Consistency pattern
                const activeWeeks = records.filter(r => r.completed > 0).length;
                const consistencyRatio = activeWeeks / records.length;
                let consistencyLabel = 'Steady';
                let consistencyIcon = 'üü¢';
                if (consistencyRatio < 0.5) {
                    consistencyLabel = 'Sporadic';
                    consistencyIcon = 'üü°';
                }
                if (consistencyRatio < 0.3) {
                    consistencyLabel = 'Inconsistent';
                    consistencyIcon = 'üî¥';
                }
                
                // Pattern display (dots)
                const patternDisplay = records.slice(-8).map(r => r.completed > 0 ? '‚óè' : '‚óã').join(' ');
                
                // Badges
                const badges = [];
                if (avgAttendance >= 95) badges.push('üíØ');
                if (tracking >= 5) badges.push('üéØ');
                if (velocity >= 3) badges.push('üî•');
                if (consistencyRatio >= 0.9) badges.push('‚≠ê');
                
                students.push({
                    name,
                    advisor: latest.advisor,
                    records,
                    latest,
                    velocity,
                    earlyVelocity,
                    recentVelocity,
                    acceleration,
                    tracking,
                    tier,
                    tierLabel,
                    firstTier,
                    tierChange,
                    trajectory,
                    trajectoryLabel,
                    trajectoryIcon,
                    avgAttendance,
                    unitsGained,
                    currentUnits: latest.completed,
                    currentBehind: tracking,
                    daysSince,
                    consistencyLabel,
                    consistencyIcon,
                    consistencyRatio,
                    patternDisplay,
                    badges
                });
            });
            
            // Calculate summary stats
            const summary = {
                totalStudents: students.length,
                avgVelocity: students.reduce((sum, s) => sum + s.velocity, 0) / students.length,
                avgAttendance: students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length,
                onTrack: students.filter(s => s.tier === 4).length,
                watch: students.filter(s => s.tier === 3).length,
                highRisk: students.filter(s => s.tier === 2).length,
                crisis: students.filter(s => s.tier === 1).length,
                improving: students.filter(s => s.acceleration > 0).length,
                declining: students.filter(s => s.acceleration < 0).length,
                stable: students.filter(s => s.acceleration === 0).length,
                tierPromotions: students.filter(s => s.tierChange > 0).length,
                breakthrough: students.filter(s => s.trajectory === 'breakthrough').length,
                building: students.filter(s => s.trajectory === 'building').length,
                stableTrajectory: students.filter(s => s.trajectory === 'stable').length,
                decliningTrajectory: students.filter(s => s.trajectory === 'declining').length,
                rapidDecline: students.filter(s => s.trajectory === 'rapid_decline').length
            };
            
            // Find highlights
            const topGainers = [...students].sort((a, b) => b.unitsGained - a.unitsGained).slice(0, 5);
            const topAccel = [...students].filter(s => s.acceleration > 0).sort((a, b) => b.acceleration - a.acceleration).slice(0, 5);
            const perfectWeek = students.filter(s => s.avgAttendance >= 95 && s.velocity >= 2);
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            // Advisor stats
            const advisorMap = new Map();
            students.forEach(s => {
                if (!advisorMap.has(s.advisor)) {
                    advisorMap.set(s.advisor, []);
                }
                advisorMap.get(s.advisor).push(s);
            });
            
            // Find top advisor
            let topAdvisor = null;
            let topAdvisorScore = -Infinity;
            advisorMap.forEach((students, name) => {
                const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
                const improving = students.filter(s => s.acceleration > 0).length / students.length;
                const score = avgVel + (improving * 2);
                
                if (score > topAdvisorScore) {
                    topAdvisorScore = score;
                    topAdvisor = {
                        name,
                        totalStudents: students.length,
                        improvingCount: students.filter(s => s.acceleration > 0).length,
                        improvingPercent: (students.filter(s => s.acceleration > 0).length / students.length * 100),
                        crisisCount: students.filter(s => s.tier === 1).length,
                        avgVelocity: avgVel,
                        avgAcceleration: students.reduce((sum, s) => sum + s.acceleration, 0) / students.length
                    };
                }
            });
            
            return {
                students,
                summary,
                highlights: {
                    topGainers,
                    topAccel,
                    perfectWeek,
                    tierPromotions
                },
                advisorSpotlight: topAdvisor,
                advisorMap,
                generated: new Date().toLocaleString()
            };
        }
        
        // ================== UI INITIALIZATION ==================
        function initializeDashboard() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            updateMetrics();
            renderAdvisorSpotlight();
            renderWinsBanner();
            renderHighlights();
            renderMomentumTracker();
            createMomentumChart();
            renderAdvisorCards();
            renderStudentTable();
            setupEventListeners();
            
            document.getElementById('lastUpdate').textContent = 
                `Last Updated: ${dashboardData.generated}`;
        }
        
        function updateMetrics() {
            const summary = dashboardData.summary;
            
            document.getElementById('crisisCount').textContent = summary.crisis;
            document.getElementById('riskCount').textContent = summary.highRisk;
            document.getElementById('belowTarget').textContent = summary.watch + summary.highRisk + summary.crisis;
            document.getElementById('onTrackCount').textContent = summary.onTrack;
            document.getElementById('improvingCount').textContent = summary.improving;
            document.getElementById('promotionsCount').textContent = summary.tierPromotions;
            document.getElementById('avgAttendance').textContent = summary.avgAttendance.toFixed(1) + '%';
        }
        
        function renderAdvisorSpotlight() {
            const spotlight = dashboardData.advisorSpotlight;
            if (!spotlight) return;
            
            document.getElementById('advisorSpotlight').innerHTML = `
                <h2>üåü Advisor Spotlight</h2>
                <div class="advisor-spotlight-name">${spotlight.name}</div>
                <div class="spotlight-stats">
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.improvingCount}/${spotlight.totalStudents}</div>
                        <div class="spotlight-stat-label">Students Improving (${spotlight.improvingPercent.toFixed(0)}%)</div>
                    </div>
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.crisisCount}</div>
                        <div class="spotlight-stat-label">Crisis Students</div>
                    </div>
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.avgVelocity.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Velocity (u/wk)</div>
                    </div>
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.avgAcceleration > 0 ? '+' : ''}${spotlight.avgAcceleration.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Acceleration</div>
                    </div>
                </div>
            `;
        }
        
        function renderWinsBanner() {
            const highlights = dashboardData.highlights;
            const summary = dashboardData.summary;
            
            const wins = [
                `‚úÖ ${summary.tierPromotions} students promoted to higher tier`,
                `‚úÖ ${summary.improving} students improving their velocity`,
                `‚úÖ ${highlights.topGainers.length} students with significant progress`,
                `‚úÖ ${highlights.perfectWeek.length} students achieved "Perfect Week"`,
                `‚úÖ Average velocity: ${summary.avgVelocity.toFixed(2)} units/week`
            ];
            
            document.getElementById('winsList').innerHTML = wins.map(w => 
                `<div class="win-item">${w}</div>`
            ).join('');
        }
        
        function renderHighlights() {
            const highlights = dashboardData.highlights;
            
            const cards = [
                {
                    title: 'Biggest Gains',
                    value: highlights.topGainers.length,
                    students: highlights.topGainers.map(s => `${s.name} (+${s.unitsGained} units)`).slice(0, 3).join('<br>')
                },
                {
                    title: 'Most Improved',
                    value: highlights.topAccel.length,
                    students: highlights.topAccel.map(s => `${s.name} (+${s.acceleration.toFixed(2)} accel)`).slice(0, 3).join('<br>')
                },
                {
                    title: 'Perfect Week',
                    value: highlights.perfectWeek.length,
                    students: highlights.perfectWeek.map(s => s.name).slice(0, 3).join('<br>')
                },
                {
                    title: 'Tier Promotions',
                    value: highlights.tierPromotions.length,
                    students: highlights.tierPromotions.map(s => `${s.name} (${s.tierChange > 0 ? '+' : ''}${s.tierChange})`).slice(0, 3).join('<br>')
                }
            ];
            
            document.getElementById('highlightsGrid').innerHTML = cards.map(card => `
                <div class="highlight-card">
                    <h4>${card.title}</h4>
                    <div class="highlight-value">${card.value}</div>
                    <div class="highlight-students">${card.students || 'None'}</div>
                </div>
            `).join('');
        }
        
        function renderMomentumTracker() {
            const summary = dashboardData.summary;
            
            const categories = [
                { icon: 'üöÄ', label: 'Breakthrough', count: summary.breakthrough, filter: 'breakthrough' },
                { icon: 'üìà', label: 'Building Momentum', count: summary.building, filter: 'building' },
                { icon: 'üü¢', label: 'Stable', count: summary.stableTrajectory, filter: 'stable' },
                { icon: 'üìâ', label: 'Declining', count: summary.decliningTrajectory, filter: 'declining' },
                { icon: 'üîª', label: 'Rapid Decline', count: summary.rapidDecline, filter: 'rapid_decline' }
            ];
            
            document.getElementById('momentumButtons').innerHTML = categories.map(cat => `
                <div class="momentum-btn" onclick="filterByMomentum('${cat.filter}')">
                    <div class="momentum-btn-icon">${cat.icon}</div>
                    <div class="momentum-btn-label">${cat.label}</div>
                    <div class="momentum-btn-count">${cat.count}</div>
                </div>
            `).join('');
        }
        
        function filterByMomentum(trajectory) {
            currentFilters.trajectory = trajectory;
            document.querySelectorAll('[data-type="trajectory"]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === trajectory) {
                    btn.classList.add('active');
                }
            });
            renderStudentTable();
        }
        
        function createMomentumChart() {
            // Get all unique dates
            const allDates = [...new Set(dashboardData.students.flatMap(s => s.records.map(r => r.week)))].sort();
            
            // Calculate trajectory counts for each date
            const trajectoryData = {
                'Breakthrough': [],
                'Building': [],
                'Stable': [],
                'Declining': [],
                'Rapid Decline': []
            };
            
            allDates.forEach(date => {
                const counts = {
                    'Breakthrough': 0,
                    'Building': 0,
                    'Stable': 0,
                    'Declining': 0,
                    'Rapid Decline': 0
                };
                
                dashboardData.students.forEach(student => {
                    // For this simplified version, we'll use current trajectory
                    // In production, you'd calculate trajectory at each point in time
                    const label = student.trajectoryLabel;
                    if (counts[label] !== undefined) {
                        counts[label]++;
                    }
                });
                
                trajectoryData['Breakthrough'].push(counts['Breakthrough']);
                trajectoryData['Building'].push(counts['Building']);
                trajectoryData['Stable'].push(counts['Stable']);
                trajectoryData['Declining'].push(counts['Declining']);
                trajectoryData['Rapid Decline'].push(counts['Rapid Decline']);
            });
            
            const ctx = document.getElementById('momentumChart');
            
            if (momentumChart) {
                momentumChart.destroy();
            }
            
            momentumChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Breakthrough',
                            data: trajectoryData['Breakthrough'],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Building',
                            data: trajectoryData['Building'],
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Stable',
                            data: trajectoryData['Stable'],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Declining',
                            data: trajectoryData['Declining'],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Rapid Decline',
                            data: trajectoryData['Rapid Decline'],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    }
                }
            });
        }
        
        function renderAdvisorCards() {
            const advisorMap = dashboardData.advisorMap;
            
            const advisorCards = [];
            advisorMap.forEach((students, name) => {
                const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
                const improving = students.filter(s => s.acceleration > 0).length;
                const crisis = students.filter(s => s.tier === 1).length;
                const highRisk = students.filter(s => s.tier === 2).length;
                
                advisorCards.push({
                    name,
                    totalStudents: students.length,
                    avgVelocity: avgVel,
                    improving,
                    improvingPercent: (improving / students.length * 100).toFixed(0),
                    crisis,
                    highRisk,
                    students
                });
            });
            
            // Sort by performance
            advisorCards.sort((a, b) => {
                const scoreA = a.avgVelocity + (a.improving / a.totalStudents * 2);
                const scoreB = b.avgVelocity + (b.improving / b.totalStudents * 2);
                return scoreB - scoreA;
            });
            
            document.getElementById('advisorGrid').innerHTML = advisorCards.map(advisor => `
                <div class="advisor-card" onclick='showAdvisorView("${advisor.name.replace(/'/g, "\\'")}") '>
                    <div class="advisor-card-name">${advisor.name}</div>
                    <div class="advisor-card-stats">
                        <div class="advisor-stat-row">
                            <span>Students</span>
                            <strong>${advisor.totalStudents}</strong>
                        </div>
                        <div class="advisor-stat-row">
                            <span>Avg Velocity</span>
                            <strong>${advisor.avgVelocity.toFixed(2)} u/wk</strong>
                        </div>
                        <div class="advisor-stat-row">
                            <span>Improving</span>
                            <strong>${advisor.improving} (${advisor.improvingPercent}%)</strong>
                        </div>
                        <div class="advisor-stat-row">
                            <span>Crisis/Risk</span>
                            <strong class="status-danger">${advisor.crisis}/${advisor.highRisk}</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAdvisorView(advisorName) {
            currentAdvisor = advisorName;
            const students = dashboardData.advisorMap.get(advisorName);
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.add('active');
            
            const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
            const improving = students.filter(s => s.acceleration > 0).length;
            
            document.getElementById('advisorViewHeader').innerHTML = `
                <div class="student-view-header">
                    <div class="student-view-name">${advisorName}</div>
                    <div class="student-view-meta">
                        ${students.length} Students ‚Ä¢ Avg Velocity: ${avgVel.toFixed(2)} u/wk ‚Ä¢ ${improving} Improving
                    </div>
                </div>
            `;
            
            renderAdvisorStudentTable();
        }
        
        function renderStudentTable() {
            let filtered = dashboardData.students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            if (currentFilters.trajectory !== 'all') {
                filtered = filtered.filter(s => s.trajectory === currentFilters.trajectory);
            }
            if (currentFilters.search) {
                const search = currentFilters.search.toLowerCase();
                filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'name': aVal = a.name; bVal = b.name; break;
                    case 'tier': aVal = a.tier; bVal = b.tier; break;
                    case 'velocity': aVal = a.velocity; bVal = b.velocity; break;
                    case 'acceleration': aVal = a.acceleration; bVal = b.acceleration; break;
                    case 'behind': aVal = a.tracking; bVal = b.tracking; break;
                    case 'units': aVal = a.currentUnits; bVal = b.currentUnits; break;
                    case 'days_since': aVal = a.daysSince; bVal = b.daysSince; break;
                    case 'attendance': aVal = a.avgAttendance; bVal = b.avgAttendance; break;
                    default: aVal = a.velocity; bVal = b.velocity;
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            document.getElementById('studentTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentView('${s.name.replace(/'/g, "\\'")}')">${s.name}</span></td>
                    <td class="tier-${s.tier}">${s.tierLabel}</td>
                    <td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>${s.velocity.toFixed(2)}</td>
                    <td>${s.acceleration > 0 ? '+' : ''}${s.acceleration.toFixed(2)}</td>
                    <td>${s.consistencyIcon} ${s.patternDisplay}</td>
                    <td>${s.badges.join(' ')}</td>
                    <td>${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.currentUnits}</td>
                    <td>${s.daysSince} days</td>
                    <td>${s.avgAttendance.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function renderAdvisorStudentTable() {
            const students = dashboardData.advisorMap.get(currentAdvisor);
            let filtered = students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            
            document.getElementById('advisorStudentTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentView('${s.name.replace(/'/g, "\\'")}')">${s.name}</span></td>
                    <td class="tier-${s.tier}">${s.tierLabel}</td>
                    <td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>${s.velocity.toFixed(2)}</td>
                    <td>${s.acceleration > 0 ? '+' : ''}${s.acceleration.toFixed(2)}</td>
                    <td>${s.consistencyIcon} ${s.patternDisplay}</td>
                    <td>${s.badges.join(' ')}</td>
                    <td>${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.currentUnits}</td>
                    <td>${s.daysSince} days</td>
                    <td>${s.avgAttendance.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function showStudentView(studentName) {
            const student = dashboardData.students.find(s => s.name === studentName);
            if (!student) return;
            
            currentStudent = student;
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.add('active');
            
            renderStudentView(student);
        }
        
        function renderStudentView(student) {
            // Header
            document.getElementById('studentViewHeader').innerHTML = `
                <div class="student-view-name">${student.name}</div>
                <div class="student-view-meta">
                    ${student.tierLabel} ‚Ä¢ ${student.advisor}
                </div>
            `;
            
            // Metrics Grid
            const metrics = [
                { label: 'Current Units', value: student.currentUnits },
                { label: 'Behind/Ahead', value: (student.tracking > 0 ? '+' : '') + student.tracking },
                { label: 'Velocity', value: student.velocity.toFixed(2) + ' u/wk' },
                { label: 'Acceleration', value: (student.acceleration > 0 ? '+' : '') + student.acceleration.toFixed(2) },
                { label: 'Attendance', value: student.avgAttendance.toFixed(1) + '%' },
                { label: 'Consistency', value: student.consistencyLabel },
                { label: 'Days Since Activity', value: student.daysSince },
                { label: 'Badges', value: student.badges.join(' ') || 'None' }
            ];
            
            document.getElementById('studentMetricsGrid').innerHTML = metrics.map(m => `
                <div class="student-metric-card">
                    <div class="student-metric-label">${m.label}</div>
                    <div class="student-metric-value">${m.value}</div>
                </div>
            `).join('');
            
            // Progress Chart
            createStudentProgressChart(student);
            
            // Consistency Pattern
            document.getElementById('studentPatternDetail').innerHTML = `
                <p><strong>Pattern:</strong> ${student.patternDisplay}</p>
                <p><strong>Consistency Ratio:</strong> ${(student.consistencyRatio * 100).toFixed(0)}%</p>
                <p><strong>Status:</strong> ${student.consistencyIcon} ${student.consistencyLabel}</p>
            `;
            
            // Achievements
            const achievements = [];
            if (student.avgAttendance >= 95) achievements.push('Perfect attendance (95%+)');
            if (student.tracking >= 5) achievements.push('Significantly ahead of target');
            if (student.velocity >= 3) achievements.push('High velocity (3+ units/week)');
            if (student.consistencyRatio >= 0.9) achievements.push('Excellent consistency');
            if (student.acceleration > 1) achievements.push('Strong positive acceleration');
            
            document.getElementById('studentAchievements').innerHTML = achievements.length > 0 ?
                achievements.map(a => `<li>${a}</li>`).join('') :
                '<li>Working towards achievements</li>';
            
            // Concerns
            const concerns = [];
            if (student.tier === 1) concerns.push('Crisis tier - immediate intervention needed');
            if (student.tier === 2) concerns.push('High risk - requires close monitoring');
            if (student.avgAttendance < 70) concerns.push('Low attendance - major concern');
            if (student.velocity < 1) concerns.push('Low velocity - may need additional support');
            if (student.acceleration < -1) concerns.push('Rapid decline in performance');
            if (student.daysSince > 14) concerns.push('No recent activity - follow up needed');
            
            document.getElementById('studentConcerns').innerHTML = concerns.length > 0 ?
                concerns.map(c => `<li>${c}</li>`).join('') :
                '<li>No major concerns at this time</li>';
        }
        
        function createStudentProgressChart(student) {
            const ctx = document.getElementById('studentProgressChart');
            
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
            
            const dates = student.records.map(r => new Date(r.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const completed = student.records.map(r => r.completed);
            const expected = student.records.map(r => r.expected);
            
            studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Units Completed',
                            data: completed,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Expected Units',
                            data: expected,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units'
                            }
                        }
                    }
                }
            });
        }
        
        function backToMain() {
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('mainView').classList.add('active');
            currentAdvisor = null;
            currentStudent = null;
            currentFilters = { tier: 'all', trajectory: 'all', search: '' };
        }
        
        function setupEventListeners() {
            // Search box
            document.getElementById('searchBox').addEventListener('input', (e) => {
                currentFilters.search = e.target.value;
                renderStudentTable();
            });
            
            // Filter buttons - main view
            document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#mainView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderStudentTable();
                });
            });
            
            // Filter buttons - advisor view
            document.querySelectorAll('#advisorView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#advisorView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderAdvisorStudentTable();
                });
            });
            
            // Sortable columns
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    if (currentAdvisor) {
                        renderAdvisorStudentTable();
                    } else {
                        renderStudentTable();
                    }
                });
            });
        }
        
        // ================== INITIALIZE ==================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
