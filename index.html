<!DOCTYPE html>
<!--
========================================
PHS DASHBOARD v7.5 (Advisor Cross-Reference + Refresh Recovery)
Date: December 10, 2024
NEW in v7.5:
- Advisor Cross-Reference: Corrects Tableau attendance-taker vs actual advisor mismatch
  (Eden → Ortiz, Ortiz → Berranger, Berranger → Eden, Larry → Ortiz)
- Easy-edit configuration object for future advisor changes (no coding required)
- Refresh Recovery: When viewing a student scorecard and hitting refresh,
  dashboard now returns to that student instead of main page
- Uses sessionStorage to remember current student across page refreshes
Previous v7.4: Teacher/Advisor Notes Integration
Previous v7.3.2: Calendar-aware expected units calculation
Previous v7.3.1: Bug fix attempt for calendar integration
Previous v7.3: Rotating wins + calendar notifications
========================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier High School - Gallery North Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        
        h1 { font-size: 2.25rem; line-height: 1.2; }
        h2 { font-size: 1.75rem; line-height: 1.3; }
        h3 { font-size: 1.35rem; line-height: 1.4; }
        h4 { font-size: 1.15rem; line-height: 1.5; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            padding-right: 2rem;
        }
        
        .header select option {
            background: #667eea;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        
        /* Print styles for PDF export */
        @media print {
            body {
                background: white;
            }
            
            .header {
                background: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide all interactive elements */
            .no-print,
            .back-button,
            .action-buttons,
            .controls,
            button,
            select {
                display: none !important;
            }
            
            /* Optimize page margins for print */
            @page {
                margin: 0.5in;
            }
            
            /* Use full width in print */
            .container {
                max-width: 100% !important;
                padding: 0.5rem !important;
            }
            
            /* Control page breaks for major sections */
            .dashboard-gauges,
            .wins-banner,
            .metrics-split,
            .advisor-spotlight,
            .highlights-section,
            .advisor-grid,
            .momentum-tracker-section,
            .waterfall-section,
            .table-wrapper,
            .student-section,
            .student-metrics-grid,
            .student-view-header,
            .perfect-week-card,
            .perfect-week-student-card,
            .perfect-week-description,
            .perfect-week-banner,
            .new-students-section,
            .chart-container,
            .student-chart-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Ensure grid items don't break */
            .perfect-week-students-grid > div,
            .advisor-grid > div,
            .highlights-grid > div {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Prevent headers from being orphaned */
            h2, h3, .section-header, .student-section-title {
                page-break-after: avoid;
            }
            
            /* Prevent orphans and widows */
            p, li {
                orphans: 3;
                widows: 3;
            }
            
            /* If Perfect Week section would start near bottom, push to next page */
            .student-section:last-of-type {
                page-break-before: auto;
            }
            
            /* Optimize grid layouts for print */
            .perfect-week-students-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .perfect-week-student-card {
                margin-top: 0.5rem !important;
            }
            
            .student-metrics-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .advisor-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            /* Better footer for print */
            .footer {
                position: relative !important;
                page-break-before: avoid;
                margin-top: 2rem;
                padding: 1rem;
            }
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }
        
        .main-view, .advisor-view, .student-view, .filtered-list-view {
            display: none;
        }
        
        .main-view.active, .advisor-view.active, .student-view.active, .filtered-list-view.active {
            display: block;
        }
        
        .back-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .back-button:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6537a8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* Action buttons container */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border: none;
        }
        
        .action-buttons button:hover {
            transform: translateY(-2px);
        }
        
        .btn-recommendations {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-export-pdf {
            background: #10b981;
            color: white;
        }
        
        .btn-achievements {
            background: #6366f1;
            color: white;
        }
        
        .btn-log-note {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .wins-banner {
            background: linear-gradient(135deg, #0d4d3d 0%, #1a6b55 50%, #0f5e4a 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(13, 77, 61, 0.4);
            border: 1px solid rgba(26, 107, 85, 0.3);
        }
        
        .wins-banner h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wins-list {
            display: grid;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .win-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .win-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        .metrics-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .metrics-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .metrics-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .challenges h3 { color: #941b1f; }
        .celebrations h3 { color: #10b981; }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.95rem;
            color: #666;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .status-good { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-danger { color: #941b1f; }
        
        .advisor-spotlight {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .advisor-spotlight h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .spotlight-reason {
            font-size: 1rem;
            color: white;
            opacity: 0.9;
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .advisor-spotlight-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
        }
        
        .spotlight-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .spotlight-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .spotlight-stat:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        .spotlight-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .spotlight-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .highlights-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .highlights-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        .highlight-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .highlight-card.blue { border-left: 4px solid #3b82f6; background: #eff6ff; }
        .highlight-card.teal { border-left: 4px solid #14b8a6; background: #f0fdfa; }
        .highlight-card.yellow { border-left: 4px solid #f59e0b; background: #fffbeb; }
        
        .highlight-card h4 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #333;
        }
        
        .highlight-students {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .highlight-student {
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #667eea;
        }
        
        .highlight-student:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .highlight-student-meta {
            font-size: 0.85rem;
            color: #666;
            font-weight: normal;
        }
        
        .momentum-tracker-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .momentum-tracker-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .momentum-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .momentum-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .momentum-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .momentum-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .momentum-btn-change {
            font-size: 0.9rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }
        
        .momentum-btn-change.positive { color: #10b981; }
        .momentum-btn-change.negative { color: #941b1f; }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }
        
        .advisor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .advisor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        
        .advisor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .advisor-card-border {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }
        
        .advisor-card-border.grade-a { background: #10b981; }
        .advisor-card-border.grade-b { background: #3b82f6; }
        .advisor-card-border.grade-c { background: #f59e0b; }
        .advisor-card-border.grade-d { background: #941b1f; }
        .advisor-card-border.grade-f { background: #7f1d1d; }
        
        .advisor-card-content {
            padding: 1.5rem;
            padding-left: 2rem;
        }
        
        .advisor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .advisor-card-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .advisor-card-grade {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
        
        .advisor-card-grade.grade-a { background: #10b981; }
        .advisor-card-grade.grade-b { background: #3b82f6; }
        .advisor-card-grade.grade-c { background: #f59e0b; }
        .advisor-card-grade.grade-d { background: #941b1f; }
        .advisor-card-grade.grade-f { background: #7f1d1d; }
        
        .advisor-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .advisor-stat-item {
            padding: 0.5rem;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .advisor-stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .advisor-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .heatmap-very-good { background: #d1fae5 !important; color: #065f46; }
        .heatmap-good { background: #a7f3d0 !important; color: #047857; }
        .heatmap-neutral { background: #f3f4f6 !important; color: #374151; }
        .heatmap-warning { background: #fef3c7 !important; color: #92400e; }
        .heatmap-bad { background: #fecaca !important; color: #991b1b; }
        .heatmap-very-bad { background: #fca5a5 !important; color: #7f1d1d; }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }
        
        .controls-row {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .search-box {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .student-table {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1050px;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #667eea;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        th.sortable:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        
        /* Specific column widths for better fit */
        th:nth-child(1), td:nth-child(1) { 
            width: 160px; 
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        } /* Student Name */
        th:nth-child(2), td:nth-child(2) { width: 95px; text-align: center; } /* Risk Tier */
        th:nth-child(3), td:nth-child(3) { width: 75px; } /* Velocity */
        th:nth-child(4), td:nth-child(4) { width: 110px; } /* Trajectory */
        th:nth-child(5), td:nth-child(5) { width: 85px; } /* Acceleration */
        th:nth-child(6), td:nth-child(6) { width: 140px; text-align: center; } /* Pattern */
        th:nth-child(7), td:nth-child(7) { width: 60px; text-align: center; } /* Badges */
        th:nth-child(8), td:nth-child(8) { width: 80px; text-align: center; } /* Units */
        th:nth-child(9), td:nth-child(9) { width: 95px; text-align: center; } /* Ahead/Behind */
        th:nth-child(10), td:nth-child(10) { width: 90px; } /* Last Activity */
        th:nth-child(11), td:nth-child(11) { width: 85px; text-align: center; } /* Attendance */
        
        tbody tr {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        tbody tr:nth-child(odd) {
            background: rgba(102, 126, 234, 0.02);
        }
        
        tbody tr:hover {
            background: linear-gradient(90deg, 
                rgba(102, 126, 234, 0.08) 0%, 
                rgba(102, 126, 234, 0.05) 100%);
            border-left-color: #667eea;
            transform: translateX(2px);
        }
        
        .student-name-link {
            color: #667eea;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            max-width: 100%;
        }
        
        .student-name-link:hover {
            text-decoration: underline;
        }
        
        .advisor-spotlight-name,
        .advisor-card-name,
        .student-view-name {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tier-badge.tier-1 { 
            background: linear-gradient(135deg, #941b1f 0%, #611718 100%);
            color: white;
            border: 2px solid #611718;
        }
        .tier-badge.tier-2 { 
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            color: white;
        }
        .tier-badge.tier-3 { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
        }
        .tier-badge.tier-4 { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .tier-badge.tier-5 { 
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            border: 2px solid #a78bfa;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .trajectory-breakthrough { color: #10b981; font-weight: bold; }
        .trajectory-building { color: #059669; font-weight: 600; }
        .trajectory-stable { color: #3b82f6; }
        .trajectory-declining { color: #f59e0b; font-weight: 600; }
        .trajectory-rapid_decline { color: #941b1f; font-weight: bold; }
        
        .consistency-dots {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        
        .dots-row {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .consistency-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        .consistency-dot.filled {
            background: #333;
        }
        
        .consistency-dot.empty {
            background: white;
        }
        
        /* Smart Calendar-Aware Pattern Dots */
        .pattern-dots-container {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            align-items: center;
            position: relative;
        }
        
        .pattern-dots-row {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .pattern-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }
        
        .pattern-dot:hover {
            transform: scale(1.3);
            z-index: 10;
        }
        
        /* Green: Met standard goal (≥2.0 units) */
        .pattern-dot.strong {
            background: #10b981;
            border-color: #059669;
        }
        
        /* Blue: Met adjusted goal on short week */
        .pattern-dot.adjusted {
            background: #3b82f6;
            border-color: #2563eb;
        }
        
        /* Hollow: Below goal */
        .pattern-dot.below {
            background: white;
            border-color: #333;
        }
        
        /* Black: Break week */
        .pattern-dot.break {
            background: #1f2937;
            border-color: #111827;
            opacity: 0.6;
        }
        
        /* Gray: Missing data on school week (historical only) */
        .pattern-dot.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        /* Tooltip for pattern dots */
        .pattern-dot-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            line-height: 1.4;
        }
        
        .pattern-dot:hover .pattern-dot-tooltip {
            opacity: 1;
        }
        
        .pattern-dot-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        .pattern-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .pattern-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .pattern-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        .pattern-legend-dot.strong {
            background: #10b981;
            border-color: #059669;
        }
        
        .pattern-legend-dot.adjusted {
            background: #3b82f6;
            border-color: #2563eb;
        }
        
        .pattern-legend-dot.below {
            background: white;
            border-color: #333;
        }
        
        .pattern-legend-dot.break {
            background: #1f2937;
            border-color: #111827;
            opacity: 0.6;
        }
        
        .pattern-legend-dot.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        .consistency-label {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            white-space: nowrap;
        }
        
        /* Pattern Header Tooltip */
        .pattern-header-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .pattern-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            font-size: 0.65rem;
            cursor: help;
            transition: all 0.2s;
        }
        
        .pattern-info-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .pattern-header-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .pattern-header-wrapper:hover .pattern-header-tooltip {
            opacity: 1;
        }
        
        .pattern-header-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.95);
        }
        
        .pattern-legend-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        
        .pattern-legend-row:last-child {
            margin-bottom: 0;
        }
        
        .pattern-legend-dot-inline {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
        }
        
        .pattern-legend-dot-inline.strong {
            background: #10b981;
            border-color: #059669;
        }
        
        .pattern-legend-dot-inline.adjusted {
            background: #3b82f6;
            border-color: #2563eb;
        }
        
        .pattern-legend-dot-inline.below {
            background: white;
            border-color: #333;
        }
        
        .pattern-legend-dot-inline.break {
            background: #1f2937;
            border-color: #111827;
            opacity: 0.6;
        }
        
        .pattern-legend-dot-inline.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        /* Pattern Descriptor Label */
        .pattern-descriptor {
            display: block;
            margin-top: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        
        .pattern-descriptor.steady {
            color: #10b981;
        }
        
        .pattern-descriptor.bursty {
            color: #f59e0b;
        }
        
        .pattern-descriptor.inconsistent {
            color: #ef4444;
        }
        
        .student-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .student-view-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .student-view-meta {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .deadline-countdown-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .deadline-countdown-box.on-track {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .deadline-countdown-box.needs-attention {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .deadline-countdown-box.urgent {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .deadline-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .deadline-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .deadline-stat {
            text-align: center;
        }
        
        .deadline-stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .deadline-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .deadline-message {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 0.95rem;
        }
        
        .week-indicator-banner {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .week-indicator-banner strong {
            font-weight: 600;
        }
        
        .student-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .student-metric-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 120px;
        }
        
        .student-metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        
        .student-metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            line-height: 1.2;
        }
        
        .student-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .student-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .semester-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .semester-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .semester-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .semester-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .achievement-list, .concern-list {
            list-style: none;
            padding: 0;
        }
        
        .achievement-list li, .concern-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .achievement-list li {
            border-left: 4px solid #10b981;
        }
        
        .concern-list li {
            border-left: 4px solid #941b1f;
        }
        
        .badge-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .badge-icon {
            font-size: 1.5rem;
        }
        
        .badge-text {
            font-size: 0.9rem;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-size: 0.9rem;
        }
        
        /* Click-and-Hold Grade Reveal */
        .grade-reveal-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .grade-reveal-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .grade-reveal-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .grade-reveal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .grade-reveal-btn:active {
            transform: translateY(0px);
        }
        
        .grade-reveal-btn.revealing {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.6);
        }
        
        .grade-hidden {
            display: none;
        }
        
        .grade-visible {
            display: block;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        /* New Student Alert Banner */
        .new-students-alert {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            border: 2px solid #60a5fa;
        }
        
        .new-students-alert h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .new-students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .new-student-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .new-student-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .new-student-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .new-student-meta {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Perfect Week Printable Page */
        .perfect-week-printable {
            display: none;
            padding: 2rem;
            background: white;
        }
        
        .perfect-week-printable.active {
            display: block;
        }
        
        .perfect-week-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
        }
        
        .perfect-week-banner h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .perfect-week-banner .subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
        }
        
        .perfect-week-description {
            background: #fffbeb;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
            margin-bottom: 2rem;
            color: #78350f;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .perfect-week-students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .perfect-week-student-card {
            background: white;
            border: 3px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .perfect-week-student-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1rem;
            border: 3px solid #fbbf24;
        }
        
        .perfect-week-student-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .perfect-week-student-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f3f4f6;
        }
        
        .perfect-week-stat {
            text-align: center;
        }
        
        .perfect-week-stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f59e0b;
        }
        
        .perfect-week-stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }
        
        @media print {
            .perfect-week-printable.active {
                display: block !important;
            }
            
            .perfect-week-printable:not(.active) {
                display: none !important;
            }
            
            .back-button {
                display: none;
            }
        }
        
        /* Responsive Design for Chromebooks and Mobile */
        @media screen and (max-width: 1366px) {
            /* Chromebook optimization */
            .container {
                padding: 1.5rem;
            }
            
            table {
                min-width: 950px;
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
            
            .tier-badge {
                padding: 0.3rem 0.7rem;
                font-size: 0.7rem;
            }
        }
        
        @media screen and (max-width: 1024px) {
            /* Tablet landscape */
            .header h1 {
                font-size: 1.5rem;
            }
            
            .metrics-split {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .advisor-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            table {
                font-size: 0.8rem;
            }
            
            .highlights-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 768px) {
            /* Mobile - Stack everything */
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 800px;
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.5rem 0.35rem;
            }
            
            .wins-banner {
                padding: 1rem;
            }
            
            .wins-banner h2 {
                font-size: 1.25rem;
            }
            
            .advisor-grid {
                grid-template-columns: 1fr;
            }
            
            .back-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
                width: 100%;
            }
            
            .student-view-name {
                font-size: 1.75rem;
            }
            
            .student-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .student-metric-card {
                min-height: 100px;
                padding: 1rem;
            }
            
            .student-metric-value {
                font-size: 1.5rem;
            }
            
            .advisor-spotlight-name {
                font-size: 2rem;
            }
        }
        
        @media screen and (max-width: 480px) {
            /* Small mobile */
            .header h1 {
                font-size: 1.1rem;
            }
            
            table {
                font-size: 0.7rem;
            }
            
            .tier-badge {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
            
            .consistency-dot {
                width: 8px;
                height: 8px;
            }
            
            .student-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .student-metric-card {
                min-height: 90px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h1>🎓 Premier High School - Gallery North <span style="font-size: 0.6rem; background: #10b981; padding: 0.25rem 0.75rem; border-radius: 12px; vertical-align: middle; margin-left: 0.5rem; font-weight: 600; letter-spacing: 0.5px;">v7.4</span></h1>
                <div class="subtitle">Student Progress Dashboard</div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                <select id="weekSelector" onchange="switchWeek()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem; cursor: pointer; background: rgba(255,255,255,0.2); color: white; font-weight: 500;">
                    <!-- Populated dynamically -->
                </select>
                <div id="dateRange" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.8); white-space: nowrap;"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">
            📊 Loading data from Google Sheets...
        </div>

        <!-- Main Dashboard View -->
        <div id="mainView" class="main-view">
            <!-- Week Indicator Banner -->
            <div id="weekIndicatorBanner" class="week-indicator-banner" style="display: none;"></div>
            
            <!-- Wins Banner -->
            <div class="wins-banner">
                <h2>🏆 This Period's Wins</h2>
                <div class="wins-list" id="winsList"></div>
            </div>

            <!-- This Week's Stars -->
            <div class="highlights-section">
                <h2>⭐ This Week's Stars</h2>
                <div class="highlights-grid" id="highlightsGrid"></div>
            </div>

            <!-- New Students Alert -->
            <div class="new-students-alert" id="newStudentsAlert" style="display: none;">
                <h3>🎉 Welcome New Students!</h3>
                <div class="new-students-grid" id="newStudentsGrid"></div>
            </div>

            <!-- Celebrations & Challenges -->
            <div class="metrics-split">
                <div class="metrics-section celebrations">
                    <h3>✨ Celebrations</h3>
                    <div id="celebrationsContent"></div>
                </div>
                
                <div class="metrics-section challenges">
                    <h3>⚠️ Challenges</h3>
                    <div id="challengesContent"></div>
                </div>
            </div>

            <!-- Advisor Spotlight -->
            <div class="advisor-spotlight" id="advisorSpotlight"></div>

            <!-- Advisor Performance -->
            <div class="section-header">👥 Advisor Performance (Click to View Students)</div>
            <div class="advisor-grid" id="advisorGrid"></div>
            
            <!-- Momentum Tracker -->
            <div class="momentum-tracker-section">
                <h2>🎯 Student Momentum Tracker</h2>
                <div class="momentum-buttons" id="momentumButtons"></div>
            </div>
            
            <!-- Waterfall Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <span>📊 Campus Health Check</span>
                    <small style="display: block; font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">On-track (green) vs. struggling (red) students over time</small>
                </div>
                <canvas id="waterfallChart" height="100"></canvas>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons no-print">
                <button class="btn-recommendations" onclick="generateAIRecommendations()">
                    🎯 Get Smart Recommendations
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    📄 Export to PDF
                </button>
                <button class="btn-achievements" onclick="showAchievementsLegend()">
                    🏆 Achievement Legend
                </button>
            </div>

            <!-- Main Student Dashboard -->
            <div class="section-header">👨‍🎓 All Students Dashboard</div>
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search students by name...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="5" data-type="tier">⭐ Superstars</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">🟢 On Track</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">🟡 Watch</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">🟠 High Risk</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">🔴 Crisis</button>
                    </div>
                </div>
                <div class="controls-row">
                    <strong>Trajectory:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="trajectory">All</button>
                        <button class="filter-btn" data-filter="breakthrough" data-type="trajectory">🚀 Breakthrough</button>
                        <button class="filter-btn" data-filter="building" data-type="trajectory">📈 Building</button>
                        <button class="filter-btn" data-filter="stable" data-type="trajectory">🟢 Stable</button>
                        <button class="filter-btn" data-filter="declining" data-type="trajectory">📉 Declining</button>
                        <button class="filter-btn" data-filter="rapid_decline" data-type="trajectory">🔻 Rapid Decline</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                
                                <th style="text-align: center;">
                                    <div class="pattern-header-wrapper">
                                        <span>Pattern</span>
                                        <span class="pattern-info-icon">ⓘ</span>
                                        <div class="pattern-header-tooltip">
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline strong"></div>
                                                <span>🟢 Met Minimum (≥2.0 u/wk)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline adjusted"></div>
                                                <span>🔵 Met Adjusted Goal (short week)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline below"></div>
                                                <span>⚪ Below Goal</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline break"></div>
                                                <span>⚫ Break Week (no school)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline missing"></div>
                                                <span>⚫ No Data (no update that week)</span>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-sort="badges">Badges</th>
                                
                                <th class="sortable" data-sort="behind">Ahead/Behind</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Advisor View -->
        <div id="advisorView" class="advisor-view">
            <button class="back-button" onclick="backToMain()">← Back to Dashboard</button>
            <div class="advisor-view-header" id="advisorViewHeader"></div>
            
            <!-- Action Buttons for Advisor View -->
            <div class="action-buttons no-print">
                <button class="btn-recommendations" onclick="generateAdvisorRecommendations()">
                    🎯 Advisor Priorities
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    📄 Export to PDF
                </button>
                <button class="btn-achievements" onclick="showAchievementsLegend()">
                    🏆 Achievement Legend
                </button>
            </div>
            
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="advisorSearchBox" placeholder="🔍 Search students...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group" id="advisorTierFilters">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">🔴 Crisis</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">🟠 High Risk</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">🟡 Watch</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">🟢 On Track</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="advisorStudentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                
                                <th style="text-align: center;">
                                    <div class="pattern-header-wrapper">
                                        <span>Pattern</span>
                                        <span class="pattern-info-icon">ⓘ</span>
                                        <div class="pattern-header-tooltip">
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline strong"></div>
                                                <span>🟢 Met Minimum (≥2.0 u/wk)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline adjusted"></div>
                                                <span>🔵 Met Adjusted Goal (short week)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline below"></div>
                                                <span>⚪ Below Goal</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline break"></div>
                                                <span>⚫ Break Week (no school)</span>
                                            </div>
                                            <div class="pattern-legend-row">
                                                <div class="pattern-legend-dot-inline missing"></div>
                                                <span>⚫ No Data (no update that week)</span>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-sort="badges">Badges</th>
                                
                                <th class="sortable" data-sort="behind">Ahead/Behind</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="advisorStudentTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Bottom Back Button -->
            <button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">← Back to Dashboard</button>
        </div>
        
        <!-- Student View -->
        <div id="studentView" class="student-view">
            <button class="back-button" onclick="backToMain()">← Back to Dashboard</button>
            <div class="student-view-header" id="studentViewHeader"></div>
            
            <!-- Action Buttons for Student View -->
            <div class="action-buttons no-print">
                <button class="btn-recommendations" onclick="generateStudentRecommendations()">
                    🎯 Student Action Plan
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    📄 Export to PDF
                </button>
                <button class="btn-achievements" onclick="showAchievementsLegend()">
                    🏆 Achievement Legend
                </button>
            </div>
            
            <!-- Deadline Countdown Box -->
            <div id="deadlineCountdownBox"></div>
            
            <div class="student-metrics-grid" id="studentMetricsGrid"></div>
            
            <div class="student-section">
                <div class="student-section-title">📈 Progress Over Time</div>
                <div class="semester-filters">
                    <button class="semester-btn active" data-semester="ytd">School Year to Date</button>
                    <button class="semester-btn" data-semester="fall">Fall Semester</button>
                    <button class="semester-btn" data-semester="spring">Spring Semester</button>
                </div>
                <div class="student-chart-container">
                    <canvas id="studentProgressChart"></canvas>
                </div>
            </div>
            
            <div class="student-section">
                <div class="student-section-title">🎯 Consistency Pattern</div>
                <div id="studentPatternDetail"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                <div class="student-section">
                    <div class="student-section-title">🏆 Achievements</div>
                    <ul class="achievement-list" id="studentAchievements"></ul>
                </div>
                
                <div class="student-section">
                    <div class="student-section-title">⚠️ Concerns & Recommendations</div>
                    <ul class="concern-list" id="studentConcerns"></ul>
                </div>
            </div>
            
            <!-- Advisor Notes Section -->
            <div class="student-section">
                <div class="student-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>📝 Advisor Notes & Interactions</span>
                    <button class="btn-log-note no-print" onclick="openNoteLogger()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                        📝 Log Note
                    </button>
                </div>
                <div id="studentNotesDisplay"></div>
            </div>
            
            <!-- Bottom Back Button -->
            <button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">← Back to Dashboard</button>
        </div>

        <!-- Filtered List View -->
        <div id="filteredListView" class="filtered-list-view">
            <button class="back-button" onclick="backToMain()">← Back to Dashboard</button>
            <div class="student-view-header" id="filteredListHeader"></div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="filteredTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Risk Tier</th>
                                <th>Trajectory</th>
                                <th>Velocity</th>
                                <th>Ahead/Behind</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="filteredTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Bottom Back Button -->
            <button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">← Back to Dashboard</button>
        </div>

        <!-- Perfect Week Printable -->
        <div id="perfectWeekPrintable" class="perfect-week-printable">
            <div class="no-print" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="back-button" onclick="backToMain()">← Back to Dashboard</button>
                <button class="back-button" onclick="exportPerfectWeekToPDF()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    📄 Export to PDF
                </button>
            </div>
            
            <div class="perfect-week-banner">
                <h1>🏆 Perfect Week Club</h1>
                <div class="subtitle" id="perfectWeekDate"></div>
            </div>
            
            <div class="perfect-week-description">
                <strong>🌟 What is the Perfect Week Club?</strong><br>
                Students who achieve 95%+ attendance AND complete 2+ units in the week earn this elite recognition. 
                These students demonstrate the winning combination of showing up and doing the work!
            </div>
            
            <div class="perfect-week-students-grid" id="perfectWeekStudentsGrid"></div>
        </div>
    </div>

    <div class="footer" id="lastUpdate">
        Last Updated: -<br>
        <small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>
    </div>

    <script>
        // ================== CONFIGURATION ==================
        const SHEET_ID = '1QZIDSV1l7mee6WUTgjeuKr6drmp97pDBF68jYD00ieA';
        const SHEET_NAME = 'Dashboard_Data';
        // Using published CSV URL (no authentication required)
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRblGmJIUf9mg1U_TksUymYPmCJeXEzmDzgfT7LBydy3xozyAYCfRhY55wvPGB3LXFJ4CuNvzJKWuRo/pub?gid=0&single=true&output=csv';
        // Advisor Notes - REPLACE ADVISOR_LOGS_GID with the actual GID of your Advisor_Logs sheet
        // To get GID: Open Google Sheets → Click on Advisor_Logs tab → Look at URL → gid=XXXXXXXX
        const NOTES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRblGmJIUf9mg1U_TksUymYPmCJeXEzmDzgfT7LBydy3xozyAYCfRhY55wvPGB3LXFJ4CuNvzJKWuRo/pub?gid=182508265&single=true&output=csv';
        // Google Form pre-fill URL for logging notes
        const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfUVJLrRW_Giqt9aIim8VMlAAhMpIaqvUiqVb0QcEMZBxnfrA/viewform?usp=pp_url';
        const FORM_ENTRIES = {
            studentId: 'entry.64851177',
            studentName: 'entry.1416326187',
            advisor: 'entry.1682062957',
            date: 'entry.1432220341'
        };
        // Calendar file hosted in same directory as HTML (GitHub Pages)
        const CALENDAR_URL = './school_calendar_2025_26.json';
        
        // ================== GLOBAL STATE ==================
        let dashboardData = null;
        let schoolCalendar = null;
        let previousData = null;
        let currentAdvisor = null;
        let currentStudent = null;
        let advisorNotes = [];
        let currentSemester = 'ytd';
        let currentFilters = {
            tier: 'all',
            trajectory: 'all',
            search: ''
        };
        let currentSort = {
            column: 'velocity',
            direction: 'desc'
        };
        let waterfallChart = null;
        let studentProgressChart = null;
        
        // ================== ACHIEVEMENT DEFINITIONS ==================
        const ACHIEVEMENTS = [
            { id: 'first_10', icon: '🎯', name: 'First 10 Units', check: s => s.currentUnits >= 10 },
            { id: '25_club', icon: '🔥', name: '25 Units Club', check: s => s.currentUnits >= 25 },
            { id: '50_club', icon: '⭐', name: '50 Units Club', check: s => s.currentUnits >= 50 },
            { id: '75_club', icon: '💎', name: '75 Units Club', check: s => s.currentUnits >= 75 },
            { id: '100_club', icon: '👑', name: '100 Units Club', check: s => s.currentUnits >= 100 },
            { id: 'speed_demon', icon: '🚀', name: 'Speed Demon', check: s => s.velocity >= 3 },
            { id: 'consistent_climber', icon: '📈', name: 'Consistent Climber', check: s => s.acceleration > 0.5 && s.consistencyRatio > 0.75 },
            { id: 'sprint_finish', icon: '⚡', name: 'Sprint Finish', check: s => s.records.some((r, i) => i > 0 && (r.completed - s.records[i-1].completed) >= 5) },
            { id: 'perfect_attendance', icon: '💯', name: 'Perfect Attendance', check: s => s.avgAttendance >= 99.5 },
            { id: 'excellent_attendance', icon: '⭐', name: 'Excellent Attendance', check: s => s.avgAttendance >= 95 },
            { id: 'strong_attendance', icon: '🎯', name: 'Strong Attendance', check: s => s.avgAttendance >= 90 },
            { id: 'rock_solid', icon: '🟢', name: 'Rock Solid', check: s => s.consistencyRatio >= 0.9 },
            { id: 'steady_progress', icon: '⭐', name: 'Steady Progress', check: s => s.consistencyRatio >= 0.75 },
            { id: 'tier_promotion', icon: '🏆', name: 'Tier Promotion', check: s => s.tierChange > 0 },
            { id: 'comeback_kid', icon: '💪', name: 'Comeback Kid', check: s => s.trajectory === 'breakthrough' && s.tierChange > 0 },
            { id: 'on_target', icon: '🎯', name: 'On Target', check: s => Math.abs(s.tracking) <= 2 },
            { id: 'ahead_of_pace', icon: '🔥', name: 'Ahead of Pace', check: s => s.tracking >= 5 },
            { id: 'sustained_improvement', icon: '📈', name: 'Sustained Improvement', check: s => s.acceleration > 0 && s.velocity > 2 }
        ];
        
        // ================== ACHIEVEMENT LEGEND ==================
        function showAchievementsLegend() {
            const modal = document.createElement('div');
            modal.id = 'achievementLegendModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Group achievements by category
            const categories = {
                'Unit Milestones': [
                    { icon: '🎯', name: 'First 10 Units', desc: 'Complete 10 units' },
                    { icon: '🔥', name: '25 Units Club', desc: 'Complete 25 units' },
                    { icon: '⭐', name: '50 Units Club', desc: 'Complete 50 units' },
                    { icon: '💎', name: '75 Units Club', desc: 'Complete 75 units' },
                    { icon: '👑', name: '100 Units Club', desc: 'Complete 100 units' }
                ],
                'Attendance Excellence': [
                    { icon: '💯', name: 'Perfect Attendance', desc: '99.5%+ attendance rate' },
                    { icon: '⭐', name: 'Excellent Attendance', desc: '95%+ attendance rate' },
                    { icon: '🎯', name: 'Strong Attendance', desc: '90%+ attendance rate' }
                ],
                'Performance Achievements': [
                    { icon: '🚀', name: 'Speed Demon', desc: '3+ units per week velocity' },
                    { icon: '📈', name: 'Consistent Climber', desc: 'Steady improvement + high consistency' },
                    { icon: '⚡', name: 'Sprint Finish', desc: 'Complete 5+ units in one week' },
                    { icon: '🔥', name: 'Ahead of Pace', desc: '5+ units ahead of schedule' },
                    { icon: '🎯', name: 'On Target', desc: 'Within 2 units of expected pace' }
                ],
                'Progress & Growth': [
                    { icon: '🏆', name: 'Tier Promotion', desc: 'Move up to better risk tier' },
                    { icon: '💪', name: 'Comeback Kid', desc: 'Breakthrough trajectory + tier promotion' },
                    { icon: '📈', name: 'Sustained Improvement', desc: 'Positive acceleration + 2+ u/wk velocity' }
                ],
                'Consistency Awards': [
                    { icon: '🟢', name: 'Rock Solid', desc: '90%+ consistency ratio' },
                    { icon: '⭐', name: 'Steady Progress', desc: '75%+ consistency ratio' }
                ]
            };
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 1000px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem;">
                        <h2 style="margin: 0;">🏆 Achievement Legend</h2>
                        <button onclick="document.getElementById('achievementLegendModal').remove()" style="background: #941b1f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    
                    <div style="display: grid; gap: 2rem;">
                        ${Object.entries(categories).map(([category, achievements]) => `
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 1rem; font-size: 1.2rem; border-left: 4px solid #667eea; padding-left: 1rem;">${category}</h3>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${achievements.map(a => `
                                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #667eea;">
                                            <div style="font-size: 2rem; min-width: 40px; text-align: center;">${a.icon}</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${a.name}</div>
                                                <div style="font-size: 0.85rem; color: #6b7280;">${a.desc}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <strong style="color: #1e40af;">📌 Note:</strong>
                        <span style="color: #1e3a8a; font-size: 0.9rem;"> Achievements shown reflect your current performance. Keep pushing towards new milestones!</span>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ================== DATA LOADING ==================
        // ================== CALENDAR FUNCTIONS ==================
        async function loadCalendar() {
            try {
                const response = await fetch(CALENDAR_URL);
                if (!response.ok) {
                    console.log('📅 Calendar file not found - using default weekly goals');
                    console.log('   Make sure school_calendar_2025_26.json is in the same folder as index.html');
                    return null;
                }
                schoolCalendar = await response.json();
                console.log(`✅ Calendar loaded successfully for ${schoolCalendar.schoolYear}`);
                return schoolCalendar;
            } catch (error) {
                console.log('📅 Calendar not loaded - using default weekly goals');
                console.log('   Error:', error.message);
                return null;
            }
        }
        
        function getWeekInfo(date) {
            if (!schoolCalendar) return { schoolDays: 5, goal: 2.0, isBreak: false };
            
            const dateStr = date.toISOString().split('T')[0];
            
            // Check breaks
            for (const breakPeriod of schoolCalendar.breaks) {
                if (dateStr >= breakPeriod.start && dateStr <= breakPeriod.end) {
                    return { schoolDays: 0, goal: 0, isBreak: true, name: breakPeriod.name };
                }
            }
            
            // Find week
            const week = schoolCalendar.weeks.find(w => dateStr >= w.start && dateStr <= w.end);
            if (week) {
                return { 
                    schoolDays: week.schoolDays, 
                    goal: week.schoolDays * 0.4,
                    isBreak: false,
                    weekNum: week.weekNum,
                    semester: week.semester
                };
            }
            
            return { schoolDays: 5, goal: 2.0, isBreak: false };
        }
        
        function getDeadlineInfo(student) {
            if (!schoolCalendar) {
                return {
                    deadline: 'May 27, 2026',
                    weeksRemaining: 17,
                    unitsRequired: 60,
                    unitsCompleted: student.currentUnits,
                    unitsNeeded: Math.max(0, 60 - student.currentUnits),
                    paceNeeded: 2.0,
                    currentPace: student.velocity,
                    projectedUnits: student.currentUnits + (student.velocity * 17),
                    onTrack: true
                };
            }
            
            const now = new Date();
            const deadline = new Date(schoolCalendar.unitDeadline);
            const weeksRemaining = schoolCalendar.weeks.filter(w => {
                const weekStart = new Date(w.start);
                return weekStart > now && weekStart <= deadline;
            }).length;
            
            // Calculate prorated goal based on when student enrolled
            let unitsRequired = schoolCalendar.totalUnitsRequired; // Default to 60
            let enrollmentNote = '';
            
            if (student.records && student.records.length > 0) {
                const firstWeek = new Date(student.records[0].week);
                const schoolStart = new Date(schoolCalendar.yearStart);
                
                // Count weeks from enrollment to deadline (including break weeks)
                const weeksEnrolled = schoolCalendar.weeks.filter(w => {
                    const weekStart = new Date(w.start);
                    return weekStart >= firstWeek && weekStart <= deadline;
                }).length;
                
                // If student enrolled mid-year, prorate their goal
                // Standard expectation: 2.0 units per week
                if (firstWeek > schoolStart) {
                    unitsRequired = Math.round(weeksEnrolled * 2.0);
                    const enrollDate = firstWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    enrollmentNote = ` (enrolled ${enrollDate}, ${weeksEnrolled} weeks)`;
                }
            }
            
            const unitsCompleted = student.currentUnits;
            const unitsNeeded = Math.max(0, unitsRequired - unitsCompleted);
            const paceNeeded = weeksRemaining > 0 ? unitsNeeded / weeksRemaining : 0;
            const projectedUnits = unitsCompleted + (student.velocity * weeksRemaining);
            
            return {
                deadline: deadline.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                weeksRemaining,
                unitsRequired,
                unitsCompleted,
                unitsNeeded,
                paceNeeded: Math.max(0, paceNeeded),
                currentPace: student.velocity,
                projectedUnits: Math.round(projectedUnits),
                onTrack: projectedUnits >= unitsRequired,
                enrollmentNote
            };
        }
        
        // ================== DATA LOADING ==================
        // Helper function to normalize dates to YYYY-MM-DD format for consistent comparison
        function normalizeDate(dateInput) {
            if (!dateInput) return null;
            
            // If already a Date object, format it
            if (dateInput instanceof Date) {
                if (isNaN(dateInput.getTime())) return null;
                const year = dateInput.getFullYear();
                const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                const day = String(dateInput.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Handle string input
            if (typeof dateInput === 'string') {
                const trimmed = dateInput.trim();
                
                // Check if already in YYYY-MM-DD format (e.g., "2025-09-15")
                if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                    return trimmed;
                }
                
                // Check if in MM-DD-YYYY format (e.g., "09-15-2025")
                const mmddyyyyMatch = trimmed.match(/^(\d{2})-(\d{2})-(\d{4})$/);
                if (mmddyyyyMatch) {
                    const [, month, day, year] = mmddyyyyMatch;
                    return `${year}-${month}-${day}`;
                }
                
                // Check if in MM/DD/YYYY format (e.g., "09/15/2025")
                const mmddyyyySlashMatch = trimmed.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (mmddyyyySlashMatch) {
                    const [, month, day, year] = mmddyyyySlashMatch;
                    const paddedMonth = month.padStart(2, '0');
                    const paddedDay = day.padStart(2, '0');
                    return `${year}-${paddedMonth}-${paddedDay}`;
                }
                
                // Try parsing as Date object
                const date = new Date(trimmed);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            
            return null;
        }
        
        async function loadData() {
            try {
                // Load calendar first (optional - non-blocking)
                if (!schoolCalendar) {
                    try {
                        await loadCalendar();
                    } catch (calError) {
                        console.log('Calendar not available, continuing without it');
                    }
                }
                
                // Fetch Google Sheets data
                const response = await fetch(DATA_URL);
                
                // Check if fetch was successful
                if (!response.ok) {
                    throw new Error(`Google Sheets returned ${response.status}: Check sharing settings`);
                }
                
                const csvText = await response.text();
                const csvData = parseCSV(csvText);
                
                // Validate we got data
                if (!csvData || csvData.length === 0) {
                    throw new Error('No data received from Google Sheets');
                }
                
                console.log(`✅ Loaded ${csvData.length} rows from Google Sheets`);
                
                // Store raw CSV data globally for week switching
                window.rawCSVData = csvData;
                
                // Store previous week's data for comparison
                if (dashboardData) {
                    previousData = JSON.parse(JSON.stringify(dashboardData));
                }
                
                dashboardData = processData(csvData);
                
                // Store processed raw data for week switching
                rawData = {};
                csvData.forEach(row => {
                    const name = row['Student Name'];
                    if (!name) return;
                    if (!rawData[name]) rawData[name] = [];
                    
                    // First normalize the advisor name, then apply cross-reference correction
                    const normalizedAdvisor = normalizeAdvisorName(row.Advisor);
                    const correctedAdvisor = applyAdvisorCrossReference(normalizedAdvisor);
                    
                    rawData[name].push({
                        date: new Date(row.Week_Date),
                        week: row.Week_Date,
                        advisor: correctedAdvisor,
                        attendance: parseFloat(row['% Present']) || 0,
                        expected: parseFloat(row['Units Expected']) || 0,
                        completed: parseInt(row['# Units Completed']) || 0
                    });
                });
                
                // Load advisor notes
                await loadNotes();
                
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    '❌ Error loading data. Please check your Google Sheets share settings.<br><small>Make sure "Anyone with the link can view" is enabled.</small>';
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (line[i] === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += line[i];
                }
            }
            result.push(current);
            return result;
        }
        
        // ================== ADVISOR NOTES LOADING ==================
        async function loadNotes() {
            try {
                // Check if NOTES_URL has been configured with actual GID
                if (NOTES_URL.includes('ADVISOR_LOGS_GID')) {
                    console.log('⚠️ Advisor notes not configured - replace ADVISOR_LOGS_GID in NOTES_URL');
                    return;
                }
                
                const response = await fetch(NOTES_URL);
                
                if (!response.ok) {
                    console.log('⚠️ Could not load advisor notes - check sheet sharing settings');
                    return;
                }
                
                const csvText = await response.text();
                const csvData = parseCSV(csvText);
                
                if (!csvData || csvData.length === 0) {
                    console.log('📝 No advisor notes found yet');
                    return;
                }
                
                // Parse notes - expected columns: Timestamp, Student ID, Student Name, Advisor/Teacher Name, Note Type, Note Details, Date
                advisorNotes = csvData.map(row => ({
                    timestamp: row['Timestamp'] || '',
                    studentId: row['Student ID'] || '',
                    studentName: row['Student Name'] || '',
                    advisor: row['Advisor/Teacher Name'] || '',
                    noteType: row['Note Type'] || '',
                    noteDetails: row['Note Details'] || '',
                    date: row['Date'] || '',
                    email: row['Email Address'] || '' // Auto-captured by Google Forms
                })).filter(note => note.studentId && note.studentName); // Only keep valid notes
                
                console.log(`✅ Loaded ${advisorNotes.length} advisor notes`);
            } catch (error) {
                console.log('⚠️ Error loading advisor notes:', error.message);
            }
        }
        
        // ================== NAME FORMATTING SYSTEM ==================
        
        // Advisor display name mapping
        const advisorDisplayNames = {
            'DUCKWORTH, EDEN': 'Ms. Eden',
            'ORTIZ, AMMIE N': 'Mrs. Ortiz',
            'KUIMI, LARRY CHRIS': 'Coach K',
            'BERRANGER, CARLOTTA': 'Berranger',
            'BERRANGER, CARLOTTA HENNIG': 'Berranger',  // Handle full name variation
            'DOKYI, MAHOGANY JADE': 'Dokyi',
            'WRIGHT, JILL': 'Mrs. Wright',
            'KEENER, TIM': 'Mr. Tim',
            // Staff who can log notes but aren't advisors
            'ARRAMBIDE': 'Arrambide',
            'CORLEY': 'Corley',
            'CRUZ': 'Cruz',
            'KEENER': 'Mr. Tim',
            'MUNOZ': 'Munoz',
            'WRIGHT': 'Mrs. Wright'
        };
        
        // ⚠️ ADVISOR CROSS-REFERENCE MAPPING ⚠️
        // Tableau report shows WRONG advisor (attendance taker, not actual advisor)
        // This mapping corrects: "If CSV says X, it should actually be Y"
        // EASY TO EDIT: Just update this object if teacher assignments change!
        const advisorCrossReference = {
            'DUCKWORTH, EDEN': 'ORTIZ, AMMIE N',      // Eden's students → Actually Ortiz's
            'ORTIZ, AMMIE N': 'BERRANGER, CARLOTTA',   // Ortiz's students → Actually Berranger's
            'BERRANGER, CARLOTTA': 'DUCKWORTH, EDEN',  // Berranger's students → Actually Eden's
            'KUIMI, LARRY CHRIS': 'ORTIZ, AMMIE N'     // Larry's old students → Now Ortiz's
        };
        
        // Normalize advisor names to canonical form (handles variations in CSV data)
        function normalizeAdvisorName(name) {
            if (!name) return '';
            
            const upperName = name.toUpperCase().trim();
            
            // Check if it matches any known advisor exactly
            if (advisorDisplayNames[upperName]) {
                return upperName; // Already in canonical form
            }
            
            // Check if it's a last-name-only variation
            // Extract last name from canonical forms and see if we have a match
            for (const canonicalName in advisorDisplayNames) {
                const lastName = canonicalName.split(',')[0].trim();
                if (upperName === lastName || upperName === lastName.toLowerCase()) {
                    return canonicalName; // Return canonical form
                }
            }
            
            // Check for partial matches (handles "Berranger" → "BERRANGER, CARLOTTA")
            for (const canonicalName in advisorDisplayNames) {
                if (canonicalName.includes(upperName) || upperName.includes(canonicalName.split(',')[0].trim())) {
                    return canonicalName;
                }
            }
            
            // Return original if no match found (new advisor not in mapping)
            return name;
        }
        
        // Apply advisor cross-reference to correct Tableau attendance-taker errors
        function applyAdvisorCrossReference(normalizedAdvisorName) {
            // If this advisor is in the cross-reference map, return the CORRECT advisor
            if (advisorCrossReference[normalizedAdvisorName]) {
                return advisorCrossReference[normalizedAdvisorName];
            }
            // Otherwise, return as-is
            return normalizedAdvisorName;
        }
        
        // Format student name: "LAST, FIRST" → "First Last" (drops middle names)
        function formatStudentName(name) {
            if (!name) return '';
            
            // Handle "LAST, FIRST" or "LAST, FIRST MIDDLE" format
            if (name.includes(',')) {
                const [last, firstPart] = name.split(',').map(s => s.trim());
                // Only take the FIRST word from the first part (drop middle names)
                const firstName = firstPart.split(' ')[0];
                return titleCase(firstName) + ' ' + titleCase(last);
            }
            
            // Already in correct format, just title case it
            return titleCase(name);
        }
        
        // Format advisor name with custom mappings
        function formatAdvisorName(name) {
            if (!name) return '';
            
            // Check if we have a custom display name
            const upperName = name.toUpperCase().trim();
            
            // Try exact match first
            if (advisorDisplayNames[upperName]) {
                return advisorDisplayNames[upperName];
            }
            
            // Try without comma (for single last names like "BARRINGER")
            const lastName = upperName.split(',')[0].trim();
            if (advisorDisplayNames[lastName]) {
                return advisorDisplayNames[lastName];
            }
            
            // Default: format as "First Last"
            return formatStudentName(name);
        }
        
        // Convert "JOHN SMITH" → "John Smith"
        function titleCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // ================== DATA PROCESSING ==================
        // ================== WEEK SELECTOR ==================
        let isViewingHistoricalData = false;
        let currentSelectedWeek = null;
        
        function switchWeek() {
            const selector = document.getElementById('weekSelector');
            const selectedDate = selector.value;
            currentSelectedWeek = selectedDate;
            
            // Get all available dates
            const allDates = Array.from(new Set(window.rawCSVData.map(row => row.Week_Date))).sort();
            const isLatest = selectedDate === allDates[allDates.length - 1];
            
            isViewingHistoricalData = !isLatest;
            
            // Filter data up to selected week
            const maxDate = new Date(selectedDate);
            const filteredData = window.rawCSVData.filter(row => {
                const rowDate = new Date(row.Week_Date);
                return rowDate <= maxDate;
            });
            
            console.log(`Switched to ${selectedDate}: ${filteredData.length} rows`);
            dashboardData = processData(filteredData);
            
            // Re-render dashboard content (but don't reinitialize everything)
            renderDashboardContent();
            
            // Show/hide historical data warning
            updateHistoricalWarning();
        }
        
        function updateHistoricalWarning() {
            let warningDiv = document.getElementById('historicalWarning');
            
            if (isViewingHistoricalData) {
                if (!warningDiv) {
                    warningDiv = document.createElement('div');
                    warningDiv.id = 'historicalWarning';
                    warningDiv.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; font-weight: 600;';
                    warningDiv.innerHTML = '⚠️ Viewing historical data. Select "Latest" to return to current period.';
                    
                    const mainView = document.getElementById('mainView');
                    const firstChild = mainView.firstElementChild.nextElementSibling; // After week selector
                    mainView.insertBefore(warningDiv, firstChild);
                }
            } else {
                if (warningDiv) {
                    warningDiv.remove();
                }
            }
        }
        
        function renderDashboardContent() {
            // Update date range in header (compact format)
            const firstDate = new Date(dashboardData.sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('dateRange').textContent = `${firstDate} - ${lastDate}`;
            
            // Week Indicator Banner
            if (schoolCalendar) {
                const currentWeek = getWeekInfo(new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]));
                if (currentWeek && !currentWeek.isBreak) {
                    const banner = document.getElementById('weekIndicatorBanner');
                    const weekDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]);
                    const weekStr = weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const dayLabel = currentWeek.schoolDays === 5 ? 'Full week' : `${currentWeek.schoolDays}-day week`;
                    banner.innerHTML = `📅 <strong>Current Week:</strong> ${weekStr} • ${dayLabel} • <strong>Goal:</strong> ${currentWeek.goal.toFixed(1)} units`;
                    banner.style.display = 'block';
                } else {
                    document.getElementById('weekIndicatorBanner').style.display = 'none';
                }
            }
            
            // Re-render all content
            renderDynamicWinsBanner();
            renderChallengesCelebrations();
            renderAdvisorSpotlight();
            renderHighlights();
            renderNewStudentsAlert();
            renderAdvisorCards();
            renderMomentumTracker();
            createWaterfallChart();
            renderStudentTable();
            
            // Update footer
            document.getElementById('lastUpdate').innerHTML = 
                `Last Updated: ${dashboardData.generated}<br><small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>`;
        }
        
        function populateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            const dates = dashboardData.sortedDates;
            
            // Create options (newest first)
            const options = dates.map((date, idx) => {
                const dateObj = new Date(date);
                const formatted = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isLatest = idx === dates.length - 1;
                return `<option value="${date}" ${isLatest ? 'selected' : ''}>${formatted}${isLatest ? ' (Current)' : ''}</option>`;
            }).reverse(); // Reverse so newest is first in dropdown
            
            selector.innerHTML = options.join('');
        }
        
        function processData(data) {
            // Group data by student
            const studentMap = new Map();
            const allDates = new Set();
            
            data.forEach(row => {
                const name = row['Student Name'];
                if (!name) return;
                
                const weekDate = row.Week_Date;
                allDates.add(weekDate);
                
                if (!studentMap.has(name)) {
                    studentMap.set(name, []);
                }
                
                studentMap.get(name).push({
                    date: new Date(weekDate),
                    week: weekDate,
                    advisor: normalizeAdvisorName(row.Advisor),
                    attendance: parseFloat(row['% Present']) || 0,
                    expected: parseFloat(row['Units Expected']) || 0,
                    completed: parseInt(row['# Units Completed']) || 0
                });
            });
            
            const sortedDates = Array.from(allDates).sort();
            const weekNumber = sortedDates.length;
            const spotlightWeek = ((weekNumber - 1) % 5) + 1;
            
            // Identify new and dropped students
            const recentDates = sortedDates.slice(-2); // Last 2 uploads
            const activeStudents = new Set();
            const newStudents = new Set();
            
            // Find students in recent data
            data.forEach(row => {
                const name = row['Student Name'];
                const weekDate = row.Week_Date;
                if (name && recentDates.includes(weekDate)) {
                    activeStudents.add(name);
                }
            });
            
            // Mark new students (first appearance is recent)
            studentMap.forEach((records, name) => {
                const firstAppearance = records[0].week;
                const firstAppearanceIndex = sortedDates.indexOf(firstAppearance);
                // New if appeared in last 3 uploads
                if (firstAppearanceIndex >= sortedDates.length - 3) {
                    newStudents.add(name);
                }
            });
            
            // Calculate metrics for each student
            const students = [];
            let studentProcessingIndex = 0; // Track which student we're processing
            
            studentMap.forEach((records, name) => {
                records.sort((a, b) => a.date - b.date);
                
                if (records.length === 0) return;
                
                // Skip dropped students (not in last 2 uploads)
                if (!activeStudents.has(name)) return;
                
                const latest = records[records.length - 1];
                const earliest = records[0];
                const firstRecord = records[0];
                
                // Mark if this is a new student
                const isNew = newStudents.has(name);
                
                // Calculate calendar-aware expected units
                // Must iterate through CALENDAR WEEKS, not upload records
                let adjustedExpected = 0;
                
                if (!schoolCalendar) {
                    // Fallback: use flat 2.0/week if no calendar
                    adjustedExpected = (records.length - 1) * 2.0;
                } else {
                    const enrollmentDate = new Date(records[0].week);
                    const latestDate = new Date(latest.week);
                    
                    // Iterate through calendar weeks from enrollment to latest record
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after latest record
                        if (weekStart < enrollmentDate || weekStart > latestDate) {
                            return;
                        }
                        
                        // Check if this is a break week
                        let isBreak = false;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (calWeek.start >= breakPeriod.start && calWeek.start <= breakPeriod.end) {
                                isBreak = true;
                                break;
                            }
                        }
                        
                        // Add goal for this week (0 if break, otherwise schoolDays * 0.4)
                        if (!isBreak) {
                            adjustedExpected += (calWeek.schoolDays * 0.4);
                        }
                    });
                }
                
                // Calculate velocity
                const weeks = records.length > 1 ? records.length - 1 : 1;
                const unitsGained = latest.completed - earliest.completed;
                const velocity = weeks > 0 ? unitsGained / weeks : 0;
                
                // Calculate acceleration
                let acceleration = 0;
                let earlyVelocity = 0;
                let recentVelocity = 0;
                
                if (records.length >= 3) {
                    const midPoint = Math.floor(records.length / 2);
                    const firstHalf = records.slice(0, midPoint);
                    const secondHalf = records.slice(midPoint);
                    
                    earlyVelocity = firstHalf.length > 1 ? 
                        (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                    recentVelocity = secondHalf.length > 1 ?
                        (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                    
                    acceleration = recentVelocity - earlyVelocity;
                }
                
                // Calculate tracking (ahead/behind using calendar-aware expected)
                const tracking = Math.round(latest.completed - adjustedExpected);
                
                // Average attendance - MUST calculate before tier determination
                const avgAttendance = records.reduce((sum, r) => sum + r.attendance, 0) / records.length;
                
                // Determine tier (5 levels now)
                let tier = 4; // On Track (default)
                let tierLabel = 'On Track';
                
                // Check for Superstar first (highest tier)
                if (velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90) {
                    tier = 5;
                    tierLabel = 'Superstar';
                }
                // On Track
                else if (tracking >= -1 && avgAttendance >= 80) {
                    tier = 4;
                    tierLabel = 'On Track';
                }
                // Watch - slightly behind OR inconsistent attendance
                else if (tracking >= -4 || (tracking < -1 && avgAttendance >= 80)) {
                    tier = 3;
                    tierLabel = 'Watch';
                }
                // High Risk - moderately behind OR rapid decline
                else if (tracking >= -9 || (acceleration < -1.5 && tracking < 0)) {
                    tier = 2;
                    tierLabel = 'High Risk';
                }
                // Crisis - severely behind
                else {
                    tier = 1;
                    tierLabel = 'Crisis';
                }
                
                // Determine first tier for comparison
                const firstTracking = firstRecord.completed - firstRecord.expected;
                const firstAttendance = records[0].attendance;
                let firstTier = 4;
                
                if (velocity >= 2.5 && firstTracking >= 3 && firstAttendance >= 90) {
                    firstTier = 5;
                } else if (firstTracking >= -1 && firstAttendance >= 80) {
                    firstTier = 4;
                } else if (firstTracking >= -4) {
                    firstTier = 3;
                } else if (firstTracking >= -9) {
                    firstTier = 2;
                } else {
                    firstTier = 1;
                }
                
                const tierChange = tier - firstTier;
                
                // Determine trajectory - consider both acceleration AND current position
                let trajectory = 'stable';
                let trajectoryLabel = 'Stable';
                let trajectoryIcon = '➡️';
                
                // Strong positive trajectory
                if (acceleration > 1.5 && velocity >= 1.5) {
                    trajectory = 'breakthrough';
                    trajectoryLabel = 'BLAST OFF!';
                    trajectoryIcon = '🚀';
                } 
                // Building momentum
                else if (acceleration > 0.5) {
                    trajectory = 'building';
                    trajectoryLabel = 'Building';
                    trajectoryIcon = '📈';
                } 
                // Critical decline - only if behind or losing ground fast
                else if (acceleration < -1.5 && (tracking < -3 || velocity < 1.5)) {
                    trajectory = 'rapid_decline';
                    trajectoryLabel = 'URGENT!';
                    trajectoryIcon = '⚠️';
                } 
                // Regular decline
                else if (acceleration < -0.5) {
                    trajectory = 'declining';
                    trajectoryLabel = 'Declining';
                    trajectoryIcon = '📉';
                }
                // Otherwise stable
                
                // Days since last activity
                let daysSince = Math.floor((new Date() - latest.date) / (1000 * 60 * 60 * 24));
                
                // Check for last activity (when units actually changed)
                for (let i = records.length - 1; i > 0; i--) {
                    if (records[i].completed !== records[i - 1].completed) {
                        daysSince = Math.floor((new Date() - records[i].date) / (1000 * 60 * 60 * 24));
                        break;
                    }
                }
                
                // Consistency pattern (2+ units = goal hit)
                const consistencyPattern = records.map(r => {
                    const weeklyGain = r.completed - (records[records.indexOf(r) - 1]?.completed || 0);
                    return weeklyGain >= 2;
                });
                const activeWeeks = consistencyPattern.filter(Boolean).length;
                const consistencyRatio = activeWeeks / records.length;
                
                let consistencyLabel = 'Steady';
                let consistencyIcon = '🟢';
                if (consistencyRatio < 0.5) {
                    consistencyLabel = 'Inconsistent';
                    consistencyIcon = '🔴';
                } else if (consistencyRatio < 0.75) {
                    consistencyLabel = 'Bursty';
                    consistencyIcon = '🟡';
                }
                
                // Pattern display (dots) - show current semester or last 12 weeks
                const now = new Date();
                const currentYear = now.getFullYear();
                
                // Determine current semester
                const fallStart = new Date(currentYear, 7, 12); // Aug 12
                const fallEnd = new Date(currentYear, 11, 19); // Dec 19
                const springStart = new Date(currentYear, 0, 6); // Jan 6
                const springEnd = new Date(currentYear, 5, 4); // Jun 4
                
                let semesterRecords = records;
                if (now >= fallStart && now <= fallEnd) {
                    // Fall semester
                    semesterRecords = records.filter(r => r.date >= fallStart && r.date <= fallEnd);
                } else if (now >= springStart && now <= springEnd) {
                    // Spring semester
                    semesterRecords = records.filter(r => r.date >= springStart && r.date <= springEnd);
                }
                
                // Generate calendar-based pattern dots (ALL weeks from enrollment to present)
                const patternDisplay = (() => {
                    const enrollmentDate = new Date(records[0].week);
                    const presentDate = new Date(records[records.length - 1].week);
                    const patterns = [];
                    
                    // If no calendar, fall back to records-based (legacy behavior)
                    if (!schoolCalendar) {
                        return records.map((r, i) => {
                            const weeklyGain = i === 0 ? r.completed : r.completed - records[i - 1].completed;
                            return {
                                type: weeklyGain >= 2.0 ? 'strong' : 'below',
                                week: r.week,
                                units: weeklyGain,
                                weekType: '5-day',
                                goal: 2.0
                            };
                        });
                    }
                    
                    // Iterate through ALL calendar weeks from enrollment to present
                    let previousUnits = 0;
                    let isFirstRecord = true; // Track if this is the first week with data
                    
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after present
                        if (weekStart < enrollmentDate || weekStart > presentDate) {
                            return;
                        }
                        
                        const weekInfo = {
                            schoolDays: calWeek.schoolDays,
                            goal: calWeek.schoolDays * 0.4,
                            isBreak: false,
                            weekNum: calWeek.weekNum,
                            semester: calWeek.semester
                        };
                        
                        // Check if this week is in a break period
                        const weekDateStr = calWeek.start;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (weekDateStr >= breakPeriod.start && weekDateStr <= breakPeriod.end) {
                                weekInfo.isBreak = true;
                                weekInfo.name = breakPeriod.name;
                                break;
                            }
                        }
                        
                        // Find ALL uploads that fall within this calendar week's date range
                        const uploadsThisWeek = records.filter(r => {
                            const uploadDate = new Date(r.week);
                            return uploadDate >= weekStart && uploadDate <= weekEnd;
                        });
                        
                        // Use the LATEST upload from this week (if multiple uploads)
                        const studentRecord = uploadsThisWeek.length > 0 ? 
                            uploadsThisWeek[uploadsThisWeek.length - 1] : null;
                        
                        if (!studentRecord) {
                            // No data for this week
                            if (weekInfo.isBreak) {
                                // Break week with no data - show black dot
                                patterns.push({
                                    type: 'break',
                                    week: calWeek.start,
                                    units: 0,
                                    weekType: weekInfo.name || 'break',
                                    goal: 0
                                });
                            } else {
                                // School week with no data - show gray dot (rare, historical only)
                                patterns.push({
                                    type: 'missing',
                                    week: calWeek.start,
                                    units: 0,
                                    weekType: `${weekInfo.schoolDays}-day`,
                                    goal: weekInfo.goal
                                });
                            }
                            // Don't update previousUnits since no progress was made
                            return;
                        }
                        
                        // Student has data for this week
                        let weeklyGain;
                        
                        if (isFirstRecord) {
                            // First week: use actual completed value or assume 2.0 if reasonable
                            // This handles students who start with existing units
                            weeklyGain = studentRecord.completed > 0 ? 
                                Math.min(studentRecord.completed, 10) : 0; // Cap at 10 for first week display
                            isFirstRecord = false;
                        } else {
                            weeklyGain = studentRecord.completed - previousUnits;
                        }
                        
                        previousUnits = studentRecord.completed;
                        
                        let dotType;
                        let weekType;
                        let goal;
                        
                        if (weekInfo.isBreak) {
                            // Break week with data (student worked during break)
                            dotType = 'break';
                            weekType = weekInfo.name || 'break';
                            goal = 0;
                        } else {
                            weekType = `${weekInfo.schoolDays}-day`;
                            goal = weekInfo.goal;
                            
                            // Check short weeks FIRST before checking 2.0
                            if (weekInfo.schoolDays < 5 && weeklyGain >= weekInfo.goal) {
                                // Met adjusted goal on short week (e.g., 1.6 on 4-day, 1.2 on 3-day)
                                dotType = 'adjusted';
                            } else if (weeklyGain >= 2.0) {
                                // Met standard goal (2.0 units on 5-day week)
                                dotType = 'strong';
                            } else {
                                // Below goal
                                dotType = 'below';
                            }
                        }
                        
                        patterns.push({
                            type: dotType,
                            week: calWeek.start,
                            units: weeklyGain,
                            weekType,
                            goal
                        });
                    });
                    
                    return patterns;
                })();
                
                // DIAGNOSTIC: Log pattern generation details for first student only
                if (studentProcessingIndex === 0) {
                    console.log('=== PATTERN DOT DIAGNOSTIC (First Student) ===');
                    console.log('Student:', name);
                    console.log('Calendar loaded:', !!schoolCalendar);
                    console.log('Total patterns generated:', patternDisplay.length);
                    console.log('Pattern types:', {
                        strong: patternDisplay.filter(p => p.type === 'strong').length,
                        adjusted: patternDisplay.filter(p => p.type === 'adjusted').length,
                        below: patternDisplay.filter(p => p.type === 'below').length,
                        break: patternDisplay.filter(p => p.type === 'break').length,
                        missing: patternDisplay.filter(p => p.type === 'missing').length
                    });
                    console.log('First 3 patterns:', patternDisplay.slice(0, 3));
                    console.log('Last 3 patterns:', patternDisplay.slice(-3));
                }
                
                // Calculate superstars (high performers) - matches tier 5 criteria
                const isSuperstar = velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90;
                
                const student = {
                    name,
                    advisor: normalizeAdvisorName(latest.advisor),
                    records,
                    latest,
                    velocity,
                    earlyVelocity,
                    recentVelocity,
                    acceleration,
                    tracking,
                    tier,
                    tierLabel,
                    firstTier,
                    tierChange,
                    trajectory,
                    trajectoryLabel,
                    trajectoryIcon,
                    avgAttendance,
                    unitsGained,
                    currentUnits: latest.completed,
                    currentBehind: tracking,
                    daysSince,
                    consistencyLabel,
                    consistencyIcon,
                    consistencyRatio,
                    patternDisplay,
                    isSuperstar,
                    isNew
                };
                
                // Calculate badges/achievements
                student.badges = ACHIEVEMENTS.filter(a => a.check(student));
                
                students.push(student);
                studentProcessingIndex++; // Increment for next student
            });
            
            // Calculate summary stats
            const summary = {
                totalStudents: students.length,
                avgVelocity: students.reduce((sum, s) => sum + s.velocity, 0) / students.length,
                avgAttendance: students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length,
                superstars: students.filter(s => s.tier === 5).length,
                onTrack: students.filter(s => s.tier === 4).length,
                watch: students.filter(s => s.tier === 3).length,
                highRisk: students.filter(s => s.tier === 2).length,
                crisis: students.filter(s => s.tier === 1).length,
                improving: students.filter(s => s.acceleration > 0).length,
                declining: students.filter(s => s.acceleration < 0).length,
                stable: students.filter(s => s.acceleration === 0).length,
                tierPromotions: students.filter(s => s.tierChange > 0).length,
                breakthrough: students.filter(s => s.trajectory === 'breakthrough').length,
                building: students.filter(s => s.trajectory === 'building').length,
                stableTrajectory: students.filter(s => s.trajectory === 'stable').length,
                decliningTrajectory: students.filter(s => s.trajectory === 'declining').length,
                rapidDecline: students.filter(s => s.trajectory === 'rapid_decline').length
            };
            
            // Find highlights
            const topGainers = [...students].sort((a, b) => b.unitsGained - a.unitsGained).slice(0, 3);
            const topAccel = [...students].filter(s => s.acceleration > 0).sort((a, b) => b.acceleration - a.acceleration).slice(0, 3);
            const perfectWeek = students.filter(s => s.avgAttendance >= 95 && s.velocity >= 2);
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            // Advisor stats with grading
            const advisorMap = new Map();
            students.forEach(s => {
                if (!advisorMap.has(s.advisor)) {
                    advisorMap.set(s.advisor, []);
                }
                advisorMap.get(s.advisor).push(s);
            });
            
            // Calculate advisor grades
            const advisorStats = [];
            advisorMap.forEach((students, name) => {
                const totalStudents = students.length;
                const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / totalStudents;
                const improving = students.filter(s => s.acceleration > 0).length;
                const crisis = students.filter(s => s.tier === 1).length;
                const highRisk = students.filter(s => s.tier === 2).length;
                const superstars = students.filter(s => s.isSuperstar).length;
                const avgAccel = students.reduce((sum, s) => sum + s.acceleration, 0) / totalStudents;
                const avgAtt = students.reduce((sum, s) => sum + s.avgAttendance, 0) / totalStudents;
                
                const crisisRatio = crisis / totalStudents;
                const superstarRatio = superstars / totalStudents;
                
                // Calculate score (0-100)
                let score = 0;
                score += (1 - Math.min(crisisRatio, 0.3) / 0.3) * 30; // 30% weight on low crisis
                score += Math.min(avgVel / 3, 1) * 25; // 25% weight on velocity (cap at 3)
                score += superstarRatio * 20; // 20% weight on superstars
                score += (avgAccel > 0 ? Math.min(avgAccel / 2, 1) : 0) * 15; // 15% weight on positive accel
                score += Math.min(avgAtt / 100, 1) * 10; // 10% weight on attendance
                
                advisorStats.push({
                    name,
                    students,
                    totalStudents,
                    avgVelocity: avgVel,
                    improving,
                    improvingPercent: (improving / totalStudents * 100),
                    crisis,
                    highRisk,
                    superstars,
                    avgAcceleration: avgAccel,
                    avgAttendance: avgAtt,
                    score
                });
            });
            
            // Assign grades based on percentile
            advisorStats.sort((a, b) => b.score - a.score);
            advisorStats.forEach((advisor, index) => {
                const percentile = index / advisorStats.length;
                if (percentile < 0.2) advisor.grade = 'A';
                else if (percentile < 0.5) advisor.grade = 'B';
                else if (percentile < 0.8) advisor.grade = 'C';
                else if (percentile < 0.95) advisor.grade = 'D';
                else advisor.grade = 'F';
            });
            
            // Rotating spotlight
            const spotlightCriteria = [
                { name: 'Fastest Progress Team', sort: (a, b) => b.avgVelocity - a.avgVelocity, reason: 'Highest average velocity' },
                { name: 'Most Stable Team', sort: (a, b) => (a.crisis / a.totalStudents) - (b.crisis / b.totalStudents), reason: 'Lowest crisis percentage' },
                { name: 'Most Improving Team', sort: (a, b) => b.avgAcceleration - a.avgAcceleration, reason: 'Best acceleration' },
                { name: 'Excellence Champion', sort: (a, b) => (b.superstars / b.totalStudents) - (a.superstars / a.totalStudents), reason: 'Highest percentage of high performers' },
                { name: 'Momentum Leader', sort: (a, b) => (b.improving / b.totalStudents) - (a.improving / a.totalStudents), reason: 'Most students improving' }
            ];
            
            const criterion = spotlightCriteria[spotlightWeek - 1];
            const sortedAdvisors = [...advisorStats].sort(criterion.sort);
            const topAdvisor = sortedAdvisors[0];
            topAdvisor.spotlightReason = criterion.reason;
            topAdvisor.spotlightTitle = criterion.name;
            
            return {
                students,
                summary,
                highlights: {
                    topGainers,
                    topAccel,
                    perfectWeek,
                    tierPromotions
                },
                advisorSpotlight: topAdvisor,
                advisorStats,
                advisorMap,
                weekNumber,
                sortedDates,
                generated: new Date().toLocaleString()
            };
        }
        
        // ================== NEW FEATURES ==================
        
        // Click-and-Hold Grade Reveal
        let gradeRevealTimer = null;
        
        function revealGrade(event, index) {
            event.stopPropagation();
            const gradeElement = document.getElementById(`grade-${index}`);
            const iconElement = document.getElementById(`grade-icon-${index}`);
            const btn = event.currentTarget;
            
            btn.classList.add('revealing');
            
            gradeRevealTimer = setTimeout(() => {
                gradeElement.classList.remove('grade-hidden');
                gradeElement.classList.add('grade-visible');
                iconElement.classList.add('grade-hidden');
            }, 2000); // 2 second delay
        }
        
        function hideGrade(event, index) {
            event.stopPropagation();
            const gradeElement = document.getElementById(`grade-${index}`);
            const iconElement = document.getElementById(`grade-icon-${index}`);
            const btn = event.currentTarget;
            
            btn.classList.remove('revealing');
            
            if (gradeRevealTimer) {
                clearTimeout(gradeRevealTimer);
                gradeRevealTimer = null;
            }
            
            gradeElement.classList.remove('grade-visible');
            gradeElement.classList.add('grade-hidden');
            iconElement.classList.remove('grade-hidden');
        }
        
        // New Students Alert (4 weeks)
        function renderNewStudentsAlert() {
            const NEW_STUDENT_WEEKS = 4;
            const sortedDates = dashboardData.sortedDates;
            const cutoffWeekIndex = Math.max(0, sortedDates.length - NEW_STUDENT_WEEKS);
            const cutoffDate = sortedDates[cutoffWeekIndex];
            
            const newStudents = dashboardData.students.filter(s => {
                const firstAppearance = s.records[0].week;
                return firstAppearance >= cutoffDate;
            });
            
            if (newStudents.length === 0) {
                document.getElementById('newStudentsAlert').style.display = 'none';
                return;
            }
            
            document.getElementById('newStudentsAlert').style.display = 'block';
            document.getElementById('newStudentsGrid').innerHTML = newStudents.map(s => {
                const weeksHere = s.records.length;
                const firstDate = new Date(s.records[0].week).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                // Use student name directly - more reliable than index
                const escapedName = s.name.replace(/'/g, "\\'");
                
                // Tier color mapping
                const tierColors = {
                    1: '#941b1f', 2: '#f59e0b', 3: '#fbbf24', 4: '#10b981', 5: '#8b5cf6'
                };
                const tierColor = tierColors[s.tier] || '#667eea';
                
                return `
                    <div class="new-student-card" onclick="showStudentByName('${escapedName}')" style="border: 3px solid ${tierColor};">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="
                                width: 60px; 
                                height: 60px; 
                                border-radius: 50%; 
                                background: linear-gradient(135deg, ${tierColor} 0%, rgba(59, 130, 246, 0.7) 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 1.8rem;
                                border: 3px solid rgba(255, 255, 255, 0.3);
                            ">🎓</div>
                            <div style="flex: 1;">
                                <div class="new-student-name" style="font-size: 1.1rem; margin-bottom: 0.25rem;">${formatStudentName(s.name)}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Started ${firstDate}</div>
                            </div>
                        </div>
                        <div class="new-student-meta" style="
                            background: rgba(255, 255, 255, 0.25);
                            padding: 0.75rem;
                            border-radius: 6px;
                            line-height: 1.6;
                        ">
                            <strong>${s.tierLabel}</strong> • Week ${weeksHere} with us<br>
                            ${s.velocity.toFixed(2)} u/wk velocity • ${s.avgAttendance.toFixed(0)}% attendance<br>
                            <span style="font-size: 0.85rem; opacity: 0.9;">🏅 ${s.badges.length} badge${s.badges.length !== 1 ? 's' : ''} earned</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Dynamic Wins Banner
        function renderDynamicWinsBanner() {
            const highlights = dashboardData.highlights;
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            
            // Get calendar-based heads up notifications
            const calendarNotifications = [];
            if (schoolCalendar) {
                const today = new Date();
                const twoWeeksOut = new Date(today.getTime() + (14 * 24 * 60 * 60 * 1000));
                
                // Check for upcoming breaks
                schoolCalendar.breaks.forEach(breakPeriod => {
                    const breakStart = new Date(breakPeriod.start);
                    const daysUntil = Math.ceil((breakStart - today) / (24 * 60 * 60 * 1000));
                    
                    if (daysUntil > 0 && daysUntil <= 14) {
                        calendarNotifications.push({
                            text: () => `📅 Heads up: ${breakPeriod.name} starts in ${daysUntil} day${daysUntil === 1 ? '' : 's'}`,
                            students: () => [],
                            filter: 'calendar',
                            significance: () => 100 + (14 - daysUntil) * 10, // More urgent = higher score
                            isNotification: true
                        });
                    }
                });
                
                // Check for upcoming short weeks
                schoolCalendar.weeks.forEach(week => {
                    const weekStart = new Date(week.start);
                    const daysUntil = Math.ceil((weekStart - today) / (24 * 60 * 60 * 1000));
                    
                    if (daysUntil > 0 && daysUntil <= 7 && week.schoolDays < 5 && week.schoolDays > 0) {
                        calendarNotifications.push({
                            text: () => `📅 Heads up: ${week.schoolDays}-day week coming up (adjusted goal: ${(week.schoolDays * 0.4).toFixed(1)} units)`,
                            students: () => [],
                            filter: 'calendar',
                            significance: () => 90,
                            isNotification: true
                        });
                    }
                });
            }
            
            // Define all possible win topics with significance calculation
            const winTopics = [
                ...calendarNotifications,
                {
                    text: () => `✅ ${summary.tierPromotions} students promoted to higher tier`,
                    students: () => highlights.tierPromotions.map(s => s.name),
                    filter: 'tierPromotions',
                    significance: () => (summary.tierPromotions / summary.totalStudents) * 200 // Promotions are big deals
                },
                {
                    text: () => `✅ ${summary.improving} students improving their velocity`,
                    students: () => students.filter(s => s.acceleration > 0).map(s => s.name),
                    filter: 'improving',
                    significance: () => (summary.improving / summary.totalStudents) * 120
                },
                {
                    text: () => `✅ ${highlights.topGainers.length} students with 10+ unit gains`,
                    students: () => highlights.topGainers.filter(s => s.unitsGained >= 10).map(s => s.name),
                    filter: 'topGainers',
                    significance: () => highlights.topGainers.filter(s => s.unitsGained >= 10).length * 30
                },
                {
                    text: () => `✅ ${highlights.perfectWeek.length} students achieved "Perfect Week"`,
                    students: () => highlights.perfectWeek.map(s => s.name),
                    filter: 'perfectWeek',
                    significance: () => (highlights.perfectWeek.length / summary.totalStudents) * 150
                },
                {
                    text: () => `✅ ${summary.superstars} high-performing students (Tier 5)`,
                    students: () => students.filter(s => s.isSuperstar).map(s => s.name),
                    filter: 'superstars',
                    significance: () => (summary.superstars / summary.totalStudents) * 180
                },
                {
                    text: () => `✅ ${summary.breakthrough} students with breakthrough momentum`,
                    students: () => students.filter(s => s.trajectory === 'breakthrough').map(s => s.name),
                    filter: 'breakthrough',
                    significance: () => (summary.breakthrough / summary.totalStudents) * 140
                },
                {
                    text: () => `✅ Average velocity increased to ${summary.avgVelocity.toFixed(2)} u/wk`,
                    students: () => students.filter(s => s.velocity >= 2.0).map(s => s.name),
                    filter: 'highVelocity',
                    significance: () => summary.avgVelocity >= 2.0 ? (summary.avgVelocity - 1.5) * 100 : 0
                },
                {
                    text: () => `✅ ${summary.onTrack + summary.superstars} students on track or ahead`,
                    students: () => students.filter(s => s.tier >= 4).map(s => s.name),
                    filter: 'onTrack',
                    significance: () => ((summary.onTrack + summary.superstars) / summary.totalStudents) * 100
                },
                {
                    text: () => `✅ Class attendance average: ${summary.avgAttendance.toFixed(1)}%`,
                    students: () => students.filter(s => s.avgAttendance >= 90).map(s => s.name),
                    filter: 'attendance',
                    significance: () => summary.avgAttendance >= 85 ? (summary.avgAttendance - 80) * 5 : 0
                },
                {
                    text: () => {
                        const badges = students.reduce((sum, s) => sum + s.badges.length, 0);
                        return `✅ ${badges} total achievements earned by students`;
                    },
                    students: () => students.filter(s => s.badges.length >= 3).map(s => s.name),
                    filter: 'badges',
                    significance: () => {
                        const avgBadges = students.reduce((sum, s) => sum + s.badges.length, 0) / summary.totalStudents;
                        return avgBadges * 40;
                    }
                },
                {
                    text: () => `✅ ${students.filter(s => s.consistencyRatio >= 0.75).length} students with 75%+ consistency`,
                    students: () => students.filter(s => s.consistencyRatio >= 0.75).map(s => s.name),
                    filter: 'consistent',
                    significance: () => (students.filter(s => s.consistencyRatio >= 0.75).length / summary.totalStudents) * 110
                },
                {
                    text: () => {
                        const ahead = students.filter(s => s.tracking >= 5).length;
                        return `✅ ${ahead} students 5+ units ahead of pace`;
                    },
                    students: () => students.filter(s => s.tracking >= 5).map(s => s.name),
                    filter: 'aheadOfPace',
                    significance: () => (students.filter(s => s.tracking >= 5).length / summary.totalStudents) * 160
                },
                {
                    text: () => `✅ Crisis tier reduced to ${summary.crisis} students (${(summary.crisis/summary.totalStudents*100).toFixed(0)}%)`,
                    students: () => students.filter(s => s.tier === 1).map(s => s.name),
                    filter: 'crisis',
                    significance: () => summary.crisis <= summary.totalStudents * 0.1 ? (0.15 - (summary.crisis/summary.totalStudents)) * 300 : 0
                }
            ];
            
            // Calculate significance for each topic
            const evaluatedTopics = winTopics.map(topic => ({
                ...topic,
                calculatedSignificance: topic.significance(),
                evaluatedText: topic.text(),
                evaluatedStudents: topic.students()
            })).filter(topic => {
                // Calendar notifications always show if they exist
                if (topic.isNotification) return true;
                // Regular wins need positive significance and students
                return topic.calculatedSignificance > 0 && topic.evaluatedStudents.length > 0;
            });
            
            // Sort by significance and take top 7 candidates
            const topCandidates = evaluatedTopics
                .sort((a, b) => b.calculatedSignificance - a.calculatedSignificance)
                .slice(0, 7);
            
            // Add rotation: randomly select 4 from top 7 for variety
            // This ensures wins rotate while still prioritizing important items
            let selectedWins;
            if (topCandidates.length <= 4) {
                selectedWins = topCandidates;
            } else {
                // Always include calendar notifications
                const notifications = topCandidates.filter(w => w.isNotification).slice(0, 1);
                const nonNotifications = topCandidates.filter(w => !w.isNotification);
                
                // Randomly shuffle non-notifications and take needed amount
                const shuffled = nonNotifications.sort(() => Math.random() - 0.5);
                const slotsRemaining = 4 - notifications.length;
                selectedWins = [...notifications, ...shuffled.slice(0, slotsRemaining)];
            }
            
            // Store wins data globally for access
            window.winsData = selectedWins.map(w => ({
                text: w.evaluatedText,
                students: w.evaluatedStudents,
                filter: w.filter,
                isNotification: w.isNotification || false
            }));
            
            document.getElementById('winsList').innerHTML = window.winsData.map((w, idx) => {
                const clickHandler = w.isNotification ? '' : `onclick="showWinsList(${idx})"`;
                const cursorStyle = w.isNotification ? 'style="cursor: default;"' : '';
                return `<div class="win-item" ${clickHandler} ${cursorStyle}>${w.text}</div>`;
            }).join('');
        }
        
        // Perfect Week Club Printable Page
        function showPerfectWeekPrintable() {
            const perfectWeekStudents = dashboardData.highlights.perfectWeek;
            
            if (perfectWeekStudents.length === 0) {
                alert('No students in Perfect Week Club this period!');
                return;
            }
            
            // Hide other views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            
            // Show perfect week printable
            document.getElementById('perfectWeekPrintable').classList.add('active');
            
            // Set date
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]);
            document.getElementById('perfectWeekDate').textContent = 
                `Week of ${lastDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            
            // Render students
            document.getElementById('perfectWeekStudentsGrid').innerHTML = perfectWeekStudents.map(s => `
                <div class="perfect-week-student-card">
                    <div class="perfect-week-student-avatar">⭐</div>
                    <div class="perfect-week-student-name">${formatStudentName(s.name)}</div>
                    <div class="perfect-week-student-stats">
                        <div class="perfect-week-stat">
                            <div class="perfect-week-stat-value">${s.velocity.toFixed(1)}</div>
                            <div class="perfect-week-stat-label">Velocity</div>
                        </div>
                        <div class="perfect-week-stat">
                            <div class="perfect-week-stat-value">${s.avgAttendance.toFixed(0)}%</div>
                            <div class="perfect-week-stat-label">Attendance</div>
                        </div>
                        <div class="perfect-week-stat">
                            <div class="perfect-week-stat-value">${s.badges.length}</div>
                            <div class="perfect-week-stat-label">Badges</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ================== UI INITIALIZATION ==================
        function initializeDashboard() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            // Update date range in header (compact format)
            const firstDate = new Date(dashboardData.sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('dateRange').textContent = `${firstDate} - ${lastDate}`;
            
            // Populate week selector dropdown
            populateWeekSelector();
            
            renderDynamicWinsBanner();
            renderChallengesCelebrations();
            renderAdvisorSpotlight();
            renderHighlights();
            renderNewStudentsAlert();
            renderAdvisorCards();
            renderMomentumTracker();
            createWaterfallChart();
            renderStudentTable();
            setupEventListeners();
            
            // Check if we should restore a student view after refresh
            const savedStudentName = sessionStorage.getItem('currentStudentName');
            if (savedStudentName) {
                // Give the dashboard a moment to fully render, then restore student view
                setTimeout(() => {
                    showStudentByName(savedStudentName);
                }, 100);
            }
            
            document.getElementById('lastUpdate').innerHTML = 
                `Last Updated: ${dashboardData.generated}<br><small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>`;
        }
        
        function showWinsList(index) {
            const win = window.winsData[index];
            const showTierChanges = win.filter === 'tierPromotions';
            showFilteredList(win.students, win.text, showTierChanges);
        }
        
        function renderChallengesCelebrations() {
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            const avgVel = summary.avgVelocity;
            const avgAtt = summary.avgAttendance;
            const crisisPercent = (summary.crisis / summary.totalStudents * 100);
            const highRiskPercent = (summary.highRisk / summary.totalStudents * 100);
            const onTrackPercent = (summary.onTrack / summary.totalStudents * 100);
            const improvingPercent = (summary.improving / summary.totalStudents * 100);
            
            // Build challenge candidates with significance scores
            const challengeCandidates = [
                { 
                    label: 'Crisis Students', 
                    value: summary.crisis + ` (${crisisPercent.toFixed(0)}%)`,
                    score: crisisPercent * 2,
                    students: students.filter(s => s.tier === 1).map(s => s.name)
                },
                { 
                    label: 'High Risk Students', 
                    value: summary.highRisk + ` (${highRiskPercent.toFixed(0)}%)`,
                    score: highRiskPercent * 1.5,
                    students: students.filter(s => s.tier === 2).map(s => s.name)
                },
                { 
                    label: 'Students Below Target', 
                    value: summary.watch + summary.highRisk + summary.crisis,
                    score: ((summary.watch + summary.highRisk + summary.crisis) / summary.totalStudents) * 100,
                    students: students.filter(s => s.tier <= 3).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel < 1.6 ? (2.0 - avgVel) * 50 : 0,
                    students: students.filter(s => s.velocity < 1.6).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt < 80 ? (85 - avgAtt) * 3 : 0,
                    students: students.filter(s => s.avgAttendance < 80).map(s => s.name)
                },
                { 
                    label: 'Students Declining', 
                    value: summary.declining + summary.rapidDecline,
                    score: ((summary.declining + summary.rapidDecline) / summary.totalStudents) * 80,
                    students: students.filter(s => s.acceleration < -0.5).map(s => s.name)
                },
                { 
                    label: 'Rapid Decline Students', 
                    value: summary.rapidDecline,
                    score: (summary.rapidDecline / summary.totalStudents) * 120,
                    students: students.filter(s => s.trajectory === 'rapid_decline').map(s => s.name)
                }
            ];
            
            // Build celebration candidates with significance scores
            const celebrationCandidates = [
                { 
                    label: 'Students On Track or Ahead', 
                    value: summary.onTrack,
                    score: onTrackPercent,
                    students: students.filter(s => s.tier === 4).map(s => s.name)
                },
                { 
                    label: 'Students Improving', 
                    value: summary.improving + ` (${improvingPercent.toFixed(0)}%)`,
                    score: improvingPercent * 1.5,
                    students: students.filter(s => s.acceleration > 0).map(s => s.name)
                },
                { 
                    label: 'Tier Promotions', 
                    value: summary.tierPromotions,
                    score: (summary.tierPromotions / summary.totalStudents) * 150,
                    students: students.filter(s => s.tierChange > 0).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel >= 2.0 ? (avgVel - 1.5) * 80 : 0,
                    students: students.filter(s => s.velocity >= 2.0).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt >= 85 ? (avgAtt - 80) * 3 : 0,
                    students: students.filter(s => s.avgAttendance >= 85).map(s => s.name)
                },
                { 
                    label: 'High Performers', 
                    value: summary.superstars + ` (${(summary.superstars/summary.totalStudents*100).toFixed(0)}%)`,
                    score: (summary.superstars / summary.totalStudents) * 120,
                    students: students.filter(s => s.isSuperstar).map(s => s.name)
                },
                { 
                    label: 'Breakthrough Students', 
                    value: summary.breakthrough,
                    score: (summary.breakthrough / summary.totalStudents) * 100,
                    students: students.filter(s => s.trajectory === 'breakthrough').map(s => s.name)
                }
            ];
            
            // Sort and pick top 4 with score > 0
            const topChallenges = challengeCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            const topCelebrations = celebrationCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            // Store for click handling
            window.challengesData = topChallenges;
            window.celebrationsData = topCelebrations;
            
            document.getElementById('challengesContent').innerHTML = topChallenges.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showChallengeDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-danger">${c.value}</span>
                </div>
            `).join('');
            
            document.getElementById('celebrationsContent').innerHTML = topCelebrations.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showCelebrationDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-good">${c.value}</span>
                </div>
            `).join('');
        }
        
        function showChallengeDetail(index) {
            const item = window.challengesData[index];
            if (item.students.length > 0) {
                showFilteredList(item.students, item.label);
            }
        }
        
        function showCelebrationDetail(index) {
            const item = window.celebrationsData[index];
            if (item.students.length > 0) {
                const showTierChanges = item.label.includes('Tier Promotions');
                showFilteredList(item.students, item.label, showTierChanges);
            }
        }
        
        function renderAdvisorSpotlight() {
            const spotlight = dashboardData.advisorSpotlight;
            if (!spotlight) return;
            
            // Determine featured stat based on spotlight type
            let featuredStat = '';
            let featuredValue = '';
            
            if (spotlight.spotlightTitle.includes('Fastest Progress')) {
                featuredStat = 'Avg Velocity';
                featuredValue = spotlight.avgVelocity.toFixed(2) + ' u/wk';
            } else if (spotlight.spotlightTitle.includes('Most Stable')) {
                featuredStat = 'Crisis Rate';
                featuredValue = ((spotlight.crisis / spotlight.totalStudents) * 100).toFixed(1) + '%';
            } else if (spotlight.spotlightTitle.includes('Most Improving')) {
                featuredStat = 'Avg Acceleration';
                featuredValue = (spotlight.avgAcceleration > 0 ? '+' : '') + spotlight.avgAcceleration.toFixed(2);
            } else if (spotlight.spotlightTitle.includes('Excellence')) {
                featuredStat = 'High Performers';
                featuredValue = spotlight.superstars + ' (' + ((spotlight.superstars / spotlight.totalStudents) * 100).toFixed(0) + '%)';
            } else if (spotlight.spotlightTitle.includes('Momentum')) {
                featuredStat = 'Students Improving';
                featuredValue = spotlight.improving + ' (' + spotlight.improvingPercent.toFixed(0) + '%)';
            }
            
            // Store spotlight data globally
            window.spotlightData = {
                improvingStudents: spotlight.students.filter(s => s.acceleration > 0).map(s => s.name),
                crisisStudents: spotlight.students.filter(s => s.tier === 1).map(s => s.name)
            };
            
            document.getElementById('advisorSpotlight').innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <h2 style="margin: 0; font-size: 1.5rem;">🌟 Advisor Spotlight</h2>
                </div>
                <div style="display: flex; gap: 2rem; align-items: center; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <div class="spotlight-reason">${spotlight.spotlightTitle}</div>
                        <div class="advisor-spotlight-name">${formatAdvisorName(spotlight.name)}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 0.9rem; margin-top: 0.5rem;">${spotlight.spotlightReason}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; min-width: 200px; text-align: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Featured Stat</div>
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.25rem;">${featuredValue}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${featuredStat}</div>
                    </div>
                </div>
                <div class="spotlight-stats">
                    <div class="spotlight-stat" onclick="showSpotlightImproving()">
                        <div class="spotlight-stat-value">${spotlight.improving}/${spotlight.totalStudents}</div>
                        <div class="spotlight-stat-label">Students Improving (${spotlight.improvingPercent.toFixed(0)}%)</div>
                    </div>
                    <div class="spotlight-stat" onclick="showSpotlightCrisis()">
                        <div class="spotlight-stat-value">${spotlight.crisis}</div>
                        <div class="spotlight-stat-label">Crisis Students</div>
                    </div>
                    <div class="spotlight-stat" onclick="showVelocityTrend()">
                        <div class="spotlight-stat-value">${spotlight.avgVelocity.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Velocity (u/wk)</div>
                    </div>
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.avgAcceleration > 0 ? '+' : ''}${spotlight.avgAcceleration.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Acceleration</div>
                    </div>
                </div>
            `;
        }
        
        function showSpotlightImproving() {
            showFilteredList(window.spotlightData.improvingStudents, dashboardData.advisorSpotlight.improving + " Students Improving");
        }
        
        function showSpotlightCrisis() {
            showFilteredList(window.spotlightData.crisisStudents, "Crisis Students");
        }
        
        function renderHighlights() {
            const highlights = dashboardData.highlights;
            
            // Store highlights data globally
            window.highlightsData = {
                topGainers: highlights.topGainers,
                topAccel: highlights.topAccel,
                perfectWeek: highlights.perfectWeek
            };
            
            document.getElementById('highlightsGrid').innerHTML = `
                <div class="highlight-card blue">
                    <h4>🏅 Biggest Gains</h4>
                    <div class="highlight-students">
                        ${highlights.topGainers.map((s, idx) => `
                            <div class="highlight-student" data-category="topGainers" data-index="${idx}">
                                ${formatStudentName(s.name)}<br>
                                <span class="highlight-student-meta">${s.unitsGained} units this period!</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card teal">
                    <h4>🚀 Most Improved</h4>
                    <div class="highlight-students">
                        ${highlights.topAccel.map((s, idx) => `
                            <div class="highlight-student" data-category="topAccel" data-index="${idx}">
                                ${formatStudentName(s.name)}<br>
                                <span class="highlight-student-meta">${s.earlyVelocity.toFixed(1)} → ${s.recentVelocity.toFixed(1)} u/wk (+${s.acceleration.toFixed(1)})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card yellow">
                    <h4>💯 Perfect Week Club</h4>
                    <div class="highlight-students">
                        <div style="padding: 1rem; text-align: center; background: white; border-radius: 6px; border: 2px solid #f59e0b; cursor: pointer; transition: all 0.2s;" 
                             onclick="showPerfectWeekPrintable()"
                             onmouseover="this.style.background='#fffbeb'"
                             onmouseout="this.style.background='white'">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${highlights.perfectWeek.length}</div>
                            <div style="font-size: 0.85rem; color: #666;">students with great<br>units + perfect attendance!<br><small style="color: #f59e0b; font-weight: 600;">Click to view printable</small></div>
                        </div>
                        ${highlights.perfectWeek.slice(0, 3).map((s, idx) => `
                            <div class="highlight-student" data-category="perfectWeek" data-index="${idx}">
                                ${formatStudentName(s.name)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add event listeners using delegation
            document.getElementById('highlightsGrid').addEventListener('click', function(e) {
                const highlightStudent = e.target.closest('.highlight-student');
                if (highlightStudent) {
                    const category = highlightStudent.dataset.category;
                    const index = parseInt(highlightStudent.dataset.index);
                    if (category && !isNaN(index)) {
                        showStudentFromHighlight(category, index);
                    }
                }
            });
        }
        
        function showStudentFromHighlight(category, index) {
            const student = window.highlightsData[category][index];
            showStudentView(student.name);
        }
        
        function renderAdvisorCards() {
            const advisorStats = dashboardData.advisorStats;
            
            document.getElementById('advisorGrid').innerHTML = advisorStats.map((advisor, idx) => `
                <div class="advisor-card"> 
                    <div class="advisor-card-border grade-${advisor.grade.toLowerCase()}"></div>
                    <div class="advisor-card-content" onclick="showAdvisorByIndex(${idx})">
                        <div class="advisor-card-header">
                            <div class="advisor-card-name">${formatAdvisorName(advisor.name)}</div>
                            <div class="grade-reveal-container">
                                <div class="grade-reveal-label">Grade</div>
                                <div class="grade-reveal-btn" 
                                     onmousedown="revealGrade(event, ${idx})" 
                                     onmouseup="hideGrade(event, ${idx})" 
                                     onmouseleave="hideGrade(event, ${idx})"
                                     onclick="event.stopPropagation()"
                                     id="grade-btn-${idx}">
                                    <span class="grade-hidden" id="grade-${idx}">${advisor.grade}</span>
                                    <span class="grade-icon" id="grade-icon-${idx}">Hold</span>
                                </div>
                            </div>
                        </div>
                        <div class="advisor-card-stats">
                            <div class="advisor-stat-item">
                                <div class="advisor-stat-label">Students</div>
                                <div class="advisor-stat-value">${advisor.totalStudents}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgVelocity, 'velocity')}">
                                <div class="advisor-stat-label">Avg Velocity</div>
                                <div class="advisor-stat-value">${advisor.avgVelocity.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.crisis, 'crisis', advisor.totalStudents)}">
                                <div class="advisor-stat-label">Crisis Students</div>
                                <div class="advisor-stat-value">${advisor.crisis} (${(advisor.crisis/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.superstars / advisor.totalStudents, 'superstars')}">
                                <div class="advisor-stat-label">High Performers</div>
                                <div class="advisor-stat-value">${advisor.superstars} (${(advisor.superstars/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAcceleration, 'acceleration')}">
                                <div class="advisor-stat-label">Avg Acceleration</div>
                                <div class="advisor-stat-value">${advisor.avgAcceleration > 0 ? '+' : ''}${advisor.avgAcceleration.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAttendance, 'attendance')}">
                                <div class="advisor-stat-label">Avg Attendance</div>
                                <div class="advisor-stat-value">${advisor.avgAttendance.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAdvisorByIndex(index) {
            const advisor = dashboardData.advisorStats[index];
            showAdvisorView(advisor.name);
        }
        
        function getHeatmapClass(value, metric, total = null) {
            switch(metric) {
                case 'velocity':
                    if (value >= 2.5) return 'heatmap-very-good';
                    if (value >= 2.0) return 'heatmap-good';
                    if (value >= 1.5) return 'heatmap-neutral';
                    if (value >= 1.0) return 'heatmap-warning';
                    if (value >= 0.5) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'crisis':
                    const ratio = value / total;
                    if (ratio === 0) return 'heatmap-very-good';
                    if (ratio < 0.05) return 'heatmap-good';
                    if (ratio < 0.10) return 'heatmap-neutral';
                    if (ratio < 0.15) return 'heatmap-warning';
                    if (ratio < 0.25) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'superstars':
                    if (value >= 0.3) return 'heatmap-very-good';
                    if (value >= 0.2) return 'heatmap-good';
                    if (value >= 0.1) return 'heatmap-neutral';
                    if (value >= 0.05) return 'heatmap-warning';
                    if (value >= 0.02) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'acceleration':
                    if (value >= 1.0) return 'heatmap-very-good';
                    if (value >= 0.5) return 'heatmap-good';
                    if (value >= -0.2) return 'heatmap-neutral';
                    if (value >= -0.5) return 'heatmap-warning';
                    if (value >= -1.0) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'attendance':
                    if (value >= 95) return 'heatmap-very-good';
                    if (value >= 90) return 'heatmap-good';
                    if (value >= 80) return 'heatmap-neutral';
                    if (value >= 70) return 'heatmap-warning';
                    if (value >= 60) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                default:
                    return 'heatmap-neutral';
            }
        }
        
        function renderMomentumTracker() {
            const summary = dashboardData.summary;
            
            // Calculate changes from previous week by comparing last two dates in current data
            let changes = {};
            if (dashboardData.sortedDates.length >= 2) {
                const lastDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 1];
                const prevDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 2];
                
                // Calculate trajectory counts for previous date
                const prevCounts = {
                    breakthrough: 0, building: 0, stable: 0, declining: 0, rapidDecline: 0
                };
                
                dashboardData.students.forEach(student => {
                    const recordsUpToPrev = student.records.filter(r => r.week <= prevDate);
                    if (recordsUpToPrev.length >= 2) {
                        const earliest = recordsUpToPrev[0];
                        const latest = recordsUpToPrev[recordsUpToPrev.length - 1];
                        const midPoint = Math.floor(recordsUpToPrev.length / 2);
                        const firstHalf = recordsUpToPrev.slice(0, midPoint);
                        const secondHalf = recordsUpToPrev.slice(midPoint);
                        
                        const earlyVel = firstHalf.length > 1 ? 
                            (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                        const recentVel = secondHalf.length > 1 ?
                            (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                        
                        const accel = recentVel - earlyVel;
                        
                        if (accel > 1.5) prevCounts.breakthrough++;
                        else if (accel > 0.5) prevCounts.building++;
                        else if (accel < -1.5) prevCounts.rapidDecline++;
                        else if (accel < -0.5) prevCounts.declining++;
                        else prevCounts.stable++;
                    }
                });
                
                changes = {
                    breakthrough: summary.breakthrough - prevCounts.breakthrough,
                    building: summary.building - prevCounts.building,
                    stable: summary.stableTrajectory - prevCounts.stable,
                    declining: summary.decliningTrajectory - prevCounts.declining,
                    rapidDecline: summary.rapidDecline - prevCounts.rapidDecline
                };
            }
            
            const categories = [
                { icon: '🚀', label: 'Breakthrough', count: summary.breakthrough, filter: 'breakthrough', change: changes.breakthrough, isGood: true },
                { icon: '📈', label: 'Building', count: summary.building, filter: 'building', change: changes.building, isGood: true },
                { icon: '➡️', label: 'Stable', count: summary.stableTrajectory, filter: 'stable', change: changes.stable, isGood: null },
                { icon: '📉', label: 'Declining', count: summary.decliningTrajectory, filter: 'declining', change: changes.declining, isGood: false },
                { icon: '⚠️', label: 'Rapid Decline', count: summary.rapidDecline, filter: 'rapid_decline', change: changes.rapidDecline, isGood: false }
            ];
            
            document.getElementById('momentumButtons').innerHTML = categories.map(cat => {
                let changeClass = '';
                let changeHTML = '';
                
                if (cat.change !== undefined && cat.change !== 0) {
                    // For good trajectories: increase = good (green), decrease = bad (red)
                    // For bad trajectories: increase = bad (red), decrease = good (green)
                    // For neutral: no color
                    if (cat.isGood === true) {
                        changeClass = cat.change > 0 ? 'positive' : 'negative';
                    } else if (cat.isGood === false) {
                        changeClass = cat.change > 0 ? 'negative' : 'positive'; // INVERTED!
                    }
                    changeHTML = `<div class="momentum-btn-change ${changeClass}">${cat.change > 0 ? '+' : ''}${cat.change}</div>`;
                }
                
                return `
                    <div class="momentum-btn" onclick="filterByMomentum('${cat.filter}')">
                        <div class="momentum-btn-icon">${cat.icon}</div>
                        <div class="momentum-btn-label">${cat.label}</div>
                        <div class="momentum-btn-count">${cat.count}</div>
                        ${changeHTML}
                    </div>
                `;
            }).join('');
        }
        
        function filterByMomentum(trajectory) {
            const students = dashboardData.students.filter(s => s.trajectory === trajectory);
            const labels = {
                'breakthrough': 'Breakthrough Students',
                'building': 'Building Momentum Students',
                'stable': 'Stable Students',
                'declining': 'Declining Students',
                'rapid_decline': 'Rapid Decline Students'
            };
            showFilteredList(students.map(s => s.name), labels[trajectory]);
        }
        
        function createWaterfallChart() {
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            
            // Calculate for each date
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const onTrackData = [];
            const strugglingData = [];
            const netLine = [];
            
            sortedDates.forEach(date => {
                let onTrack = 0;
                let struggling = 0;
                
                students.forEach(student => {
                    const record = student.records.find(r => r.week === date);
                    if (record) {
                        const tracking = record.completed - record.expected;
                        if (tracking >= 0) {
                            onTrack++;
                        } else {
                            struggling++;
                        }
                    }
                });
                
                onTrackData.push(onTrack);
                strugglingData.push(struggling);
                netLine.push(onTrack - struggling); // Net difference
            });
            
            const ctx = document.getElementById('waterfallChart');
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }
            
            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'On Track or Ahead',
                            data: onTrackData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            label: 'Below Target',
                            data: strugglingData.map(v => -v), // Negative for stacking
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#941b1f',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            type: 'line',
                            label: 'Net Balance',
                            data: netLine,
                            borderColor: '#333',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#333',
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Number of Students (Net Balance)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.type === 'line') {
                                        const val = context.parsed.y;
                                        label += (val > 0 ? '+' : '') + val + ' net';
                                    } else {
                                        label += Math.abs(context.parsed.y) + ' students';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showAdvisorView(advisorName) {
            currentAdvisor = advisorName;
            const students = dashboardData.advisorMap.get(advisorName);
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
            const improving = students.filter(s => s.acceleration > 0).length;
            
            document.getElementById('advisorViewHeader').innerHTML = `
                <div class="student-view-header">
                    <div class="student-view-name">${formatAdvisorName(advisorName)}</div>
                    <div class="student-view-meta">
                        ${students.length} Students • Avg Velocity: ${avgVel.toFixed(2)} u/wk • ${improving} Improving
                    </div>
                </div>
            `;
            
            renderAdvisorStudentTable();
        }
        
        function renderStudentTable() {
            let filtered = dashboardData.students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            if (currentFilters.trajectory !== 'all') {
                filtered = filtered.filter(s => s.trajectory === currentFilters.trajectory);
            }
            if (currentFilters.search) {
                const search = currentFilters.search.toLowerCase();
                filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'name': aVal = a.name; bVal = b.name; break;
                    case 'tier': aVal = a.tier; bVal = b.tier; break;
                    case 'velocity': aVal = a.velocity; bVal = b.velocity; break;
                    case 'trajectory': 
                        // Sort by trajectory quality: breakthrough(5) > building(4) > stable(3) > declining(2) > rapid_decline(1)
                        const trajectoryOrder = { 'breakthrough': 5, 'building': 4, 'stable': 3, 'declining': 2, 'rapid_decline': 1 };
                        aVal = trajectoryOrder[a.trajectory] || 0;
                        bVal = trajectoryOrder[b.trajectory] || 0;
                        break;
                    case 'acceleration': aVal = a.acceleration; bVal = b.acceleration; break;
                    case 'badges': aVal = a.badges.length; bVal = b.badges.length; break;
                    case 'behind': aVal = a.tracking; bVal = b.tracking; break;
                    case 'units': aVal = a.currentUnits; bVal = b.currentUnits; break;
                    case 'days_since': aVal = a.daysSince; bVal = b.daysSince; break;
                    case 'attendance': aVal = a.avgAttendance; bVal = b.avgAttendance; break;
                    default: aVal = a.velocity; bVal = b.velocity;
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            document.getElementById('studentTableBody').innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${formatStudentName(s.name)}${s.isNew ? ' <span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: #667eea; font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#941b1f'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showStudentByIndex(index) {
            const student = dashboardData.students[index];
            if (student) showStudentView(student.name);
        }
        
        function showStudentByName(name) {
            // More reliable than index - finds student by exact name match
            const student = dashboardData.students.find(s => s.name === name);
            if (student) {
                showStudentView(student.name);
            } else {
                console.error('Student not found:', name);
            }
        }
        
        function renderAdvisorStudentTable() {
            const students = dashboardData.advisorMap.get(currentAdvisor);
            let filtered = students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            
            document.getElementById('advisorStudentTableBody').innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${formatStudentName(s.name)}${s.isNew ? ' <span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: #667eea; font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#941b1f'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showStudentView(studentName) {
            const student = dashboardData.students.find(s => s.name === studentName);
            if (!student) return;
            
            currentStudent = student;
            
            // Save current student to sessionStorage for refresh recovery
            sessionStorage.setItem('currentStudentName', studentName);
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('studentView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            renderStudentView(student);
        }
        
        function renderStudentView(student) {
            // Header
            document.getElementById('studentViewHeader').innerHTML = `
                <div class="student-view-name">${formatStudentName(student.name)}</div>
                <div class="student-view-meta">
                    ${student.tierLabel} • ${formatAdvisorName(student.advisor)}
                </div>
            `;
            
            // Deadline Countdown
            const deadlineInfo = getDeadlineInfo(student);
            let statusClass = 'on-track';
            let statusIcon = '✅';
            let statusMessage = '';
            
            if (deadlineInfo.unitsCompleted >= deadlineInfo.unitsRequired) {
                statusMessage = `🎉 Congratulations! Already achieved ${deadlineInfo.unitsRequired} units!`;
            } else if (deadlineInfo.projectedUnits >= deadlineInfo.unitsRequired) {
                statusMessage = `💪 Keep current pace to graduate on time!`;
            } else if (deadlineInfo.paceNeeded < 3.0) {
                statusClass = 'needs-attention';
                statusIcon = '⚠️';
                statusMessage = `⚡ Increase pace to ${deadlineInfo.paceNeeded.toFixed(2)} u/wk to stay on track`;
            } else {
                statusClass = 'urgent';
                statusIcon = '🔴';
                statusMessage = `🚨 Urgent - Immediate intervention needed`;
            }
            
            document.getElementById('deadlineCountdownBox').innerHTML = `
                <div class="deadline-countdown-box ${statusClass}">
                    <div class="deadline-title">
                        ${statusIcon} Graduation Progress Tracker${deadlineInfo.enrollmentNote ? ` <span style="opacity: 0.8; font-size: 0.85em;">${deadlineInfo.enrollmentNote}</span>` : ''}
                    </div>
                    <div class="deadline-stats">
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.unitsCompleted}</div>
                            <div class="deadline-stat-label">Units Completed</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.unitsNeeded}</div>
                            <div class="deadline-stat-label">Units Needed (of ${deadlineInfo.unitsRequired})</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.weeksRemaining}</div>
                            <div class="deadline-stat-label">Weeks Until ${deadlineInfo.deadline}</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.projectedUnits}</div>
                            <div class="deadline-stat-label">Projected Total</div>
                        </div>
                    </div>
                    <div class="deadline-message">
                        <strong>Current Pace:</strong> ${deadlineInfo.currentPace.toFixed(2)} u/wk<br>
                        <strong>Needed Pace:</strong> ${deadlineInfo.paceNeeded.toFixed(2)} u/wk<br><br>
                        ${statusMessage}
                    </div>
                </div>
            `;
            
            // Metrics Grid
            const metrics = [
                { label: 'Completed Units', value: student.currentUnits, heatmap: false },
                { label: 'Ahead/Behind', value: (student.tracking > 0 ? '+' : '') + student.tracking, heatmap: false },
                { label: 'Velocity', value: student.velocity.toFixed(2) + ' u/wk', heatmap: true, type: 'velocity' },
                { label: 'Acceleration', value: (student.acceleration > 0 ? '+' : '') + student.acceleration.toFixed(2), heatmap: true, type: 'acceleration' },
                { label: 'Attendance', value: student.avgAttendance.toFixed(1) + '%', heatmap: true, type: 'attendance' },
                { label: 'Consistency', value: student.consistencyLabel, heatmap: false },
                { label: 'Days Since Activity', value: student.daysSince, heatmap: false },
                { label: 'Badges Earned', value: student.badges.length, heatmap: false }
            ];
            
            document.getElementById('studentMetricsGrid').innerHTML = metrics.map(m => `
                <div class="student-metric-card ${m.heatmap ? getHeatmapClass(m.type === 'velocity' ? student.velocity : m.type === 'acceleration' ? student.acceleration : student.avgAttendance, m.type) : ''}">
                    <div class="student-metric-label">${m.label}</div>
                    <div class="student-metric-value">${m.value}</div>
                </div>
            `).join('');
            
            // Progress Chart
            createStudentProgressChart(student);
            
            // Consistency Pattern - Smart Calendar-Aware Dots
            const renderPatternDots = (patternArray) => {
                // Split into two rows of 18 each
                const row1 = patternArray.slice(0, 18);
                const row2 = patternArray.slice(18, 36);
                
                const renderDot = (p) => {
                    const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    let tooltip = '';
                    
                    if (p.type === 'break') {
                        tooltip = `${weekDate}: Break week`;
                    } else if (p.type === 'missing') {
                        tooltip = `${weekDate}: No data (${p.weekType})`;
                    } else {
                        const status = p.type === 'strong' ? '✓ Met minimum' : 
                                     p.type === 'adjusted' ? '✓ Met adjusted' : 
                                     '✗ Below goal';
                        tooltip = `${weekDate}<br>${p.units.toFixed(1)} units (${p.weekType})<br>Goal: ${p.goal.toFixed(1)} ${status}`;
                    }
                    
                    return `<div class="pattern-dot ${p.type}">
                        <div class="pattern-dot-tooltip">${tooltip}</div>
                    </div>`;
                };
                
                let html = '<div class="pattern-dots-container">';
                html += '<div class="pattern-dots-row">' + row1.map(renderDot).join('') + '</div>';
                if (row2.length > 0) {
                    html += '<div class="pattern-dots-row">' + row2.map(renderDot).join('') + '</div>';
                }
                html += '</div>';
                
                return html;
            };
            
            const strongWeeks = student.patternDisplay.filter(p => p.type === 'strong').length;
            const adjustedWeeks = student.patternDisplay.filter(p => p.type === 'adjusted').length;
            const totalWorkWeeks = student.patternDisplay.filter(p => p.type !== 'break').length;
            
            document.getElementById('studentPatternDetail').innerHTML = `
                ${renderPatternDots(student.patternDisplay)}
                <span class="pattern-descriptor ${student.consistencyLabel.toLowerCase()}">${student.consistencyIcon} ${student.consistencyLabel}</span>
                
                <div class="pattern-legend">
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot strong"></div>
                        <span>Met Minimum (≥2.0 u/wk)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot adjusted"></div>
                        <span>Met Adjusted Goal (short week)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot below"></div>
                        <span>Below Goal</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot break"></div>
                        <span>Break Week (no school)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot missing"></div>
                        <span>No Data (no update that week)</span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <p><strong>Strong Weeks (≥2.0 units):</strong> ${strongWeeks} of ${totalWorkWeeks}</p>
                    <p><strong>Short Week Performance:</strong> ${adjustedWeeks} weeks met adjusted goal</p>
                    <p><strong>Consistency Rate:</strong> ${(((strongWeeks + adjustedWeeks) / totalWorkWeeks) * 100).toFixed(0)}%</p>
                </div>
            `;
            
            // Achievements with badges and dates
            if (student.badges.length > 0) {
                // For each achievement, find when it was first earned
                const badgesWithDates = student.badges.map(badge => {
                    let earnedDate = null;
                    
                    // Check each historical record to find first time achievement was met
                    for (let i = 0; i < student.records.length; i++) {
                        const record = student.records[i];
                        const tempStudent = {
                            ...student,
                            currentUnits: record.completed,
                            avgAttendance: student.records.slice(0, i+1).reduce((sum, r) => sum + r.attendance, 0) / (i+1),
                            records: student.records.slice(0, i+1)
                        };
                        
                        // Check if achievement condition was met at this point
                        if (badge.check(tempStudent)) {
                            earnedDate = record.date;
                            break;
                        }
                    }
                    
                    return {
                        ...badge,
                        earnedDate: earnedDate || student.records[student.records.length - 1].date
                    };
                });
                
                document.getElementById('studentAchievements').innerHTML = badgesWithDates.map(b => `
                    <li>
                        <div class="badge-item">
                            <span class="badge-icon">${b.icon}</span>
                            <span class="badge-text">
                                ${b.name}
                                <span style="display: block; font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${b.earnedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                </span>
                            </span>
                        </div>
                    </li>
                `).join('');
            } else {
                document.getElementById('studentAchievements').innerHTML = '<li>Working towards achievements - keep it up!</li>';
            }
            
            // Concerns
            const concerns = [];
            if (student.tier === 1) concerns.push('Crisis tier - immediate intervention needed');
            if (student.tier === 2) concerns.push('High risk - requires close monitoring');
            if (student.avgAttendance < 70) concerns.push('Low attendance - major concern');
            if (student.velocity < 1) concerns.push('Low velocity - may need additional support');
            if (student.acceleration < -1) concerns.push('Rapid decline in performance');
            if (student.daysSince > 14) concerns.push('No recent activity - follow up needed');
            if (student.consistencyRatio < 0.5) concerns.push('Inconsistent performance - needs support establishing routine');
            
            document.getElementById('studentConcerns').innerHTML = concerns.length > 0 ?
                concerns.map(c => `<li>${c}</li>`).join('') :
                '<li>No major concerns at this time - keep up the good work!</li>';
            
            // Render advisor notes
            renderStudentNotes(student);
        }
        
        function createStudentProgressChart(student) {
            let records = student.records;
            
            // Filter by semester if needed
            if (currentSemester === 'fall') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 7 && month <= 11;
                });
            } else if (currentSemester === 'spring') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 0 && month <= 4;
                });
            }
            
            const ctx = document.getElementById('studentProgressChart');
            
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
            
            const dates = records.map(r => new Date(r.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const completed = records.map(r => r.completed);
            
            // Calculate calendar-aware expected units
            // Must iterate through CALENDAR WEEKS, not upload records
            const expected = [];
            let cumulativeExpected = 0;
            
            if (!schoolCalendar) {
                // Fallback: use flat 2.0/week if no calendar
                records.forEach((record, index) => {
                    expected.push(index * 2.0);
                });
            } else {
                const enrollmentDate = new Date(records[0].week);
                const presentDate = new Date(records[records.length - 1].week);
                
                // Build expected for each upload record by counting calendar weeks up to that point
                records.forEach((record, recordIndex) => {
                    const recordDate = new Date(record.week);
                    let expectedUpToThisPoint = 0;
                    
                    // Iterate through calendar weeks from enrollment to this record
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after this record
                        if (weekStart < enrollmentDate || weekStart > recordDate) {
                            return;
                        }
                        
                        // Check if this is a break week
                        let isBreak = false;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (calWeek.start >= breakPeriod.start && calWeek.start <= breakPeriod.end) {
                                isBreak = true;
                                break;
                            }
                        }
                        
                        // Add goal for this week (0 if break, otherwise schoolDays * 0.4)
                        if (!isBreak) {
                            expectedUpToThisPoint += (calWeek.schoolDays * 0.4);
                        }
                    });
                    
                    expected.push(expectedUpToThisPoint);
                });
            }
            
            studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Units Completed',
                            data: completed,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Expected Units (Calendar-Aware)',
                            data: expected,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units'
                            }
                        }
                    }
                }
            });
        }
        
        function showFilteredList(studentNames, title, showTierChanges = false) {
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('filteredListView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            document.getElementById('filteredListHeader').innerHTML = `
                <div class="student-view-name">${title}</div>
                <div class="student-view-meta">${studentNames.length} Students</div>
            `;
            
            const students = dashboardData.students.filter(s => studentNames.includes(s.name));
            
            const tierNames = ['', 'Crisis', 'High Risk', 'Watch', 'On Track', 'Superstar'];
            
            document.getElementById('filteredTableBody').innerHTML = students.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                const tierChangeText = showTierChanges && s.tierChange > 0 ? 
                    `<br><small style="color: #059669;">${tierNames[s.firstTier]} → ${tierNames[s.tier]}</small>` : '';
                    
                return `
                <tr onclick="showStudentByIndex(${studentIndex})">
                    <td><span class="student-name-link">${formatStudentName(s.name)}${tierChangeText}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#941b1f'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showVelocityTrend() {
            // Create modal for velocity trend
            const modal = document.createElement('div');
            modal.id = 'velocityModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">Average Velocity Trend</h2>
                        <button onclick="document.getElementById('velocityModal').remove()" style="background: #941b1f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <canvas id="velocityTrendChart"></canvas>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Calculate average velocity for each date
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            const labels = [];
            const avgVelocities = [];
            
            sortedDates.forEach((date, dateIndex) => {
                labels.push(new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let totalVelocity = 0;
                let count = 0;
                
                students.forEach(student => {
                    // Calculate velocity up to this point
                    const recordsUpToDate = student.records.filter(r => new Date(r.week) <= new Date(date));
                    if (recordsUpToDate.length >= 2) {
                        const earliest = recordsUpToDate[0];
                        const latest = recordsUpToDate[recordsUpToDate.length - 1];
                        const weeks = recordsUpToDate.length - 1;
                        const velocity = (latest.completed - earliest.completed) / weeks;
                        totalVelocity += velocity;
                        count++;
                    }
                });
                
                avgVelocities.push(count > 0 ? totalVelocity / count : 0);
            });
            
            const ctx = document.getElementById('velocityTrendChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Average Velocity (u/wk)',
                        data: avgVelocities,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#667eea'
                    }, {
                        label: 'Target (2.0 u/wk)',
                        data: Array(labels.length).fill(2.0),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' u/wk';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Velocity (units/week)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    }
                }
            });
        }
        
        function backToMain() {
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('perfectWeekPrintable').classList.remove('active');
            document.getElementById('mainView').classList.add('active');
            currentAdvisor = null;
            currentStudent = null;
            currentFilters = { tier: 'all', trajectory: 'all', search: '' };
            
            // Clear sessionStorage when leaving student view
            sessionStorage.removeItem('currentStudentName');
            
            // Reset filters UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('active');
                }
            });
            
            // Clear search
            document.getElementById('searchBox').value = '';
            
            renderStudentTable();
        }
        
        function setupEventListeners() {
            // Search box - auto reset filters
            document.getElementById('searchBox').addEventListener('input', (e) => {
                // Reset filters when searching
                currentFilters.tier = 'all';
                currentFilters.trajectory = 'all';
                currentFilters.search = e.target.value;
                
                // Update filter button states
                document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });
                
                renderStudentTable();
            });
            
            // Filter buttons - main view
            document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#mainView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderStudentTable();
                });
            });
            
            // Filter buttons - advisor view
            document.querySelectorAll('#advisorView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#advisorView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderAdvisorStudentTable();
                });
            });
            
            // Sortable columns
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    if (currentAdvisor) {
                        renderAdvisorStudentTable();
                    } else {
                        renderStudentTable();
                    }
                });
            });
            
            // Semester filters on student view
            document.querySelectorAll('.semester-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.semester-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSemester = btn.dataset.semester;
                    if (currentStudent) {
                        createStudentProgressChart(currentStudent);
                    }
                });
            });
        }
        
        // ================== WEEK SWITCHING ==================
        
        // Store raw data globally for week switching
        let rawData = {};
        
        // ================== SMART RECOMMENDATIONS ==================
        async function generateAIRecommendations() {
            const modal = document.createElement('div');
            modal.id = 'recommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">🎯 Smart Intervention Recommendations</h2>
                        <button onclick="document.getElementById('recommendationsModal').remove()" style="background: #941b1f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <div id="aiRecommendationsContent">
                        ${generateSmartRecommendations()}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateSmartRecommendations() {
            const students = dashboardData.students;
            const summary = dashboardData.summary;
            
            // Priority students
            const crisisStudents = students.filter(s => s.tier === 1);
            const highRiskStudents = students.filter(s => s.tier === 2);
            const rapidDeclineStudents = students.filter(s => s.trajectory === 'rapid_decline');
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 80);
            
            let html = '<div style="line-height: 1.8;">';
            
            // School-wide recommendations
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">📊 School-Wide Priorities</h3>';
            
            const schoolWideRecs = [];
            
            if (summary.avgVelocity < 1.8) {
                schoolWideRecs.push(`<strong>Velocity Boost Needed:</strong> Class average is ${summary.avgVelocity.toFixed(2)} u/wk (target: 2.0). Consider school-wide pacing strategies.`);
            } else if (summary.avgVelocity >= 2.2) {
                schoolWideRecs.push(`<strong>Strong Momentum:</strong> Class average velocity of ${summary.avgVelocity.toFixed(2)} u/wk exceeds targets. Maintain current strategies.`);
            }
            
            if (summary.avgAttendance < 85) {
                schoolWideRecs.push(`<strong>Attendance Intervention:</strong> Average attendance at ${summary.avgAttendance.toFixed(1)}% (target: 85%+). Implement attendance improvement campaign.`);
            }
            
            const crisisPercent = ((summary.crisis + summary.highRisk) / summary.totalStudents * 100);
            if (crisisPercent > 15) {
                schoolWideRecs.push(`<strong>High Risk Alert:</strong> ${crisisPercent.toFixed(0)}% of students in crisis/high risk. Consider additional support resources.`);
            }
            
            if (summary.rapidDecline > 3) {
                schoolWideRecs.push(`<strong>Declining Trend:</strong> ${summary.rapidDecline} students showing rapid decline. Early intervention critical.`);
            }
            
            html += '<ul style="margin: 1rem 0;">';
            schoolWideRecs.slice(0, 3).forEach(rec => {
                html += `<li style="margin-bottom: 0.75rem;">${rec}</li>`;
            });
            html += '</ul>';
            
            // Individual student interventions
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-top: 2rem;">👥 Priority Student Interventions</h3>';
            
            const priorityStudents = [
                ...crisisStudents.slice(0, 3),
                ...rapidDeclineStudents.filter(s => !crisisStudents.includes(s)).slice(0, 2),
                ...highRiskStudents.filter(s => !crisisStudents.includes(s) && !rapidDeclineStudents.includes(s)).slice(0, 3)
            ].slice(0, 8);
            
            html += '<ul style="margin: 1rem 0;">';
            priorityStudents.forEach(s => {
                let reason = '';
                let action = '';
                
                if (s.tier === 1) {
                    reason = `Crisis tier (${s.tracking} units behind)`;
                    action = 'Immediate one-on-one support, attendance check, family contact';
                } else if (s.trajectory === 'rapid_decline') {
                    reason = `Rapid decline (${s.trajectoryLabel}, acceleration ${s.acceleration.toFixed(1)})`;
                    action = 'Identify cause of decline, adjust pacing plan, increase check-ins';
                } else if (s.avgAttendance < 75) {
                    reason = `Low attendance (${s.avgAttendance.toFixed(1)}%)`;
                    action = 'Attendance intervention, transportation/barriers check';
                } else {
                    reason = `High risk (${s.tracking} behind, ${s.velocity.toFixed(1)} u/wk)`;
                    action = 'Create catch-up plan, monitor weekly progress';
                }
                
                html += `<li style="margin-bottom: 1rem;">
                    <strong>${formatStudentName(s.name)}</strong> - ${reason}<br>
                    <span style="color: #059669; font-size: 0.9rem;">→ ${action}</span>
                </li>`;
            });
            html += '</ul>';
            
            // Quick wins
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-top: 2rem;">⚡ Quick Wins (Immediate Actions)</h3>';
            html += '<ul style="margin: 1rem 0;">';
            
            const quickWins = [];
            
            if (lowAttendanceStudents.length > 5) {
                quickWins.push(`Contact ${lowAttendanceStudents.slice(0, 5).map(s => s.name).join(', ')} about attendance barriers`);
            }
            
            const stuckStudents = students.filter(s => s.daysSince > 14);
            if (stuckStudents.length > 0) {
                quickWins.push(`${stuckStudents.length} students haven't completed units in 14+ days - immediate check-in needed`);
            }
            
            const nearPromotion = students.filter(s => s.tier === 3 && s.tracking >= -2);
            if (nearPromotion.length > 0) {
                quickWins.push(`${nearPromotion.length} students close to tier promotion - encourage final push`);
            }
            
            quickWins.forEach(win => {
                html += `<li style="margin-bottom: 0.75rem;">${win}</li>`;
            });
            
            html += '</ul>';
            
            // Summary stats
            html += `<div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">
                <strong>Analysis Summary:</strong><br>
                Total Students: ${summary.totalStudents} | 
                Crisis/High Risk: ${summary.crisis + summary.highRisk} (${crisisPercent.toFixed(0)}%) | 
                Superstars: ${summary.superstars} | 
                Avg Velocity: ${summary.avgVelocity.toFixed(2)} u/wk | 
                Avg Attendance: ${summary.avgAttendance.toFixed(1)}%
            </div>`;
            
            html += '<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; color: #999; font-size: 0.85rem;">';
            html += `Generated ${new Date().toLocaleString()} • Based on ${students.length} students • ${dashboardData.sortedDates.length} data points`;
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        // ================== TARGETED RECOMMENDATIONS ==================
        
        function generateStudentRecommendations() {
            if (!currentStudent) return;
            
            const s = currentStudent;
            const modal = document.createElement('div');
            modal.id = 'studentRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Generate student-specific action plan
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">📋 Action Plan for ${formatStudentName(s.name)}</h3>`;
            
            // Current Status
            html += '<div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Current Status:</strong> ${s.tierLabel} (Tier ${s.tier}) • ${s.trajectoryLabel} trajectory<br>`;
            html += `<strong>Performance:</strong> ${s.velocity.toFixed(2)} u/wk velocity • ${s.tracking > 0 ? '+' : ''}${s.tracking} units ${s.tracking >= 0 ? 'ahead' : 'behind'}<br>`;
            html += `<strong>Attendance:</strong> ${s.avgAttendance.toFixed(1)}% • <strong>Last Activity:</strong> ${s.daysSince} days ago`;
            html += '</div>';
            
            // Priority Actions
            html += '<h4 style="color: #667eea;">🎯 Priority Actions (Next 48 Hours)</h4><ul style="margin: 1rem 0;">';
            
            if (s.daysSince > 14) {
                html += `<li><strong>URGENT:</strong> Student hasn't completed units in ${s.daysSince} days. Call TODAY to check in and identify barriers.</li>`;
            }
            
            if (s.tier === 1) {
                html += '<li><strong>CRISIS TIER:</strong> Schedule immediate one-on-one meeting. Review barriers, adjust pacing plan, contact family if needed.</li>';
                html += `<li>Student is ${Math.abs(s.tracking)} units behind. Create catch-up plan: target ${Math.ceil(Math.abs(s.tracking) / 4)} units per week for next month.</li>`;
            } else if (s.tier === 2) {
                html += '<li><strong>HIGH RISK:</strong> Weekly check-ins required. Monitor daily attendance and unit completion.</li>';
                html += `<li>Currently ${Math.abs(s.tracking)} units behind. Break into achievable goals: 2-3 units per week.</li>`;
            }
            
            if (s.trajectory === 'rapid_decline') {
                html += '<li><strong>RAPID DECLINE DETECTED:</strong> Early velocity ' + s.earlyVelocity.toFixed(1) + ' → recent velocity ' + s.recentVelocity.toFixed(1) + '. Investigate what changed.</li>';
            } else if (s.trajectory === 'declining') {
                html += '<li><strong>LOSING MOMENTUM:</strong> Velocity decreasing. Address before it becomes critical.</li>';
            }
            
            if (s.avgAttendance < 80) {
                html += `<li><strong>ATTENDANCE CONCERN:</strong> ${s.avgAttendance.toFixed(1)}% attendance. Identify transportation, childcare, or other barriers.</li>`;
            }
            
            if (s.consistencyRatio < 0.5) {
                html += '<li><strong>INCONSISTENT PATTERN:</strong> Bursty work habits. Help establish daily routine and smaller goals.</li>';
            }
            
            html += '</ul>';
            
            // Positive Momentum
            if (s.trajectory === 'breakthrough' || s.trajectory === 'building' || s.tierChange > 0) {
                html += '<h4 style="color: #10b981;">✨ Celebrate Progress</h4><ul style="margin: 1rem 0;">';
                
                if (s.tierChange > 0) {
                    html += `<li>🎉 Promoted from Tier ${s.firstTier} to Tier ${s.tier}! Acknowledge this achievement.</li>`;
                }
                if (s.trajectory === 'breakthrough') {
                    html += `<li>🚀 Breakthrough momentum! Velocity increased from ${s.earlyVelocity.toFixed(1)} to ${s.recentVelocity.toFixed(1)} u/wk.</li>`;
                }
                if (s.badges.length >= 3) {
                    html += `<li>🏅 Earned ${s.badges.length} badges - recognize achievements publicly.</li>`;
                }
                
                html += '</ul>';
            }
            
            // Weekly Goals
            html += '<h4 style="color: #667eea;">📅 This Week\'s Goals</h4><ul style="margin: 1rem 0;">';
            
            const targetUnits = s.velocity < 1.5 ? 2 : Math.ceil(s.velocity * 1.2);
            html += `<li>Target: ${targetUnits} units completed by Friday</li>`;
            html += `<li>Attendance: Aim for ${s.avgAttendance < 85 ? '90%+' : '100%'} this week</li>`;
            html += '<li>Daily check-in at start of class period</li>';
            
            if (s.tier <= 2) {
                html += '<li>Mid-week progress check (Wednesday)</li>';
                html += '<li>End-of-week review meeting (Friday)</li>';
            }
            
            html += '</ul>';
            
            // Intervention Template
            html += '<h4 style="color: #667eea;">💬 Conversation Starters</h4>';
            html += '<div style="background: #eff6ff; padding: 1rem; border-left: 4px solid #3b82f6; border-radius: 4px; margin: 1rem 0;">';
            
            const firstName = formatStudentName(s.name).split(' ')[0];
            html += '<p style="margin: 0;"><em>"Hey ' + firstName + ', I noticed ';
            
            if (s.trajectory === 'breakthrough' || s.tierChange > 0) {
                html += 'you\'re really crushing it lately! Your hard work is paying off. What\'s been helping you stay on track?"</em></p>';
            } else if (s.daysSince > 14) {
                html += 'we haven\'t seen you complete units in a couple weeks. What\'s going on? How can I help remove any barriers?"</em></p>';
            } else if (s.tier <= 2) {
                html += 'you\'re working hard but we need to pick up the pace to get you caught up. Let\'s talk about what\'s getting in the way."</em></p>';
            } else {
                html += 'your progress this semester. Let\'s make sure we keep this momentum going. What support do you need from me?"</em></p>';
            }
            
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">🎯 Action Plan: ${formatStudentName(s.name)}</h2>
                        <button onclick="document.getElementById('studentRecommendationsModal').remove()" style="background: #941b1f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateAdvisorRecommendations() {
            if (!currentAdvisor) return;
            
            const students = dashboardData.advisorMap.get(currentAdvisor);
            const advisorName = formatAdvisorName(currentAdvisor);
            
            const modal = document.createElement('div');
            modal.id = 'advisorRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Calculate advisor-specific stats
            const crisisStudents = students.filter(s => s.tier === 1);
            const highRiskStudents = students.filter(s => s.tier === 2);
            const rapidDeclineStudents = students.filter(s => s.trajectory === 'rapid_decline');
            const decliningStudents = students.filter(s => s.trajectory === 'declining');
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 80);
            const inactiveStudents = students.filter(s => s.daysSince > 14);
            const breakthroughStudents = students.filter(s => s.trajectory === 'breakthrough');
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
            const avgAtt = students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length;
            const campusAvgVel = dashboardData.summary.avgVelocity;
            const campusAvgAtt = dashboardData.summary.avgAttendance;
            
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">👥 ${advisorName}'s Caseload Priorities</h3>`;
            
            // Caseload Overview
            html += '<div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Total Students:</strong> ${students.length}<br>`;
            html += `<strong>Your Avg Velocity:</strong> ${avgVel.toFixed(2)} u/wk (Campus: ${campusAvgVel.toFixed(2)})<br>`;
            html += `<strong>Your Avg Attendance:</strong> ${avgAtt.toFixed(1)}% (Campus: ${campusAvgAtt.toFixed(1)}%)<br>`;
            html += `<strong>Crisis/High Risk:</strong> ${crisisStudents.length + highRiskStudents.length} students (${((crisisStudents.length + highRiskStudents.length) / students.length * 100).toFixed(0)}%)`;
            html += '</div>';
            
            // Immediate Priorities
            html += '<h4 style="color: #941b1f;">🚨 Immediate Priorities (Next 48 Hours)</h4><ul style="margin: 1rem 0;">';
            
            if (crisisStudents.length > 0) {
                html += `<li><strong>${crisisStudents.length} CRISIS STUDENTS:</strong> ${crisisStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                html += '<li style="margin-left: 2rem; color: #666;">→ One-on-one meetings required within 24 hours</li>';
            }
            
            if (inactiveStudents.length > 0) {
                html += `<li><strong>${inactiveStudents.length} INACTIVE 14+ DAYS:</strong> ${inactiveStudents.slice(0, 5).map(s => formatStudentName(s.name)).join(', ')}${inactiveStudents.length > 5 ? ` (+${inactiveStudents.length - 5} more)` : ''}</li>`;
                html += '<li style="margin-left: 2rem; color: #666;">→ Phone calls today to re-engage</li>';
            }
            
            if (rapidDeclineStudents.length > 0) {
                html += `<li><strong>${rapidDeclineStudents.length} RAPID DECLINE:</strong> ${rapidDeclineStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                html += '<li style="margin-left: 2rem; color: #666;">→ Investigate cause of decline, daily check-ins</li>';
            }
            
            html += '</ul>';
            
            // This Week's Focus
            html += '<h4 style="color: #667eea;">📋 This Week\'s Focus</h4><ul style="margin: 1rem 0;">';
            
            if (highRiskStudents.length > 0) {
                html += `<li><strong>Monitor ${highRiskStudents.length} High Risk students:</strong> ${highRiskStudents.slice(0, 4).map(s => formatStudentName(s.name)).join(', ')}${highRiskStudents.length > 4 ? '...' : ''}</li>`;
            }
            
            if (decliningStudents.length > 0) {
                html += `<li><strong>${decliningStudents.length} students showing declining trajectory</strong> - catch them before they hit crisis</li>`;
            }
            
            if (lowAttendanceStudents.length > 0) {
                html += `<li><strong>${lowAttendanceStudents.length} students below 80% attendance</strong> - identify barriers this week</li>`;
            }
            
            const watchStudents = students.filter(s => s.tier === 3);
            if (watchStudents.length > 0) {
                html += `<li><strong>${watchStudents.length} Watch tier students</strong> - keep stable, prevent slipping to High Risk</li>`;
            }
            
            html += '</ul>';
            
            // Celebrate Successes
            if (breakthroughStudents.length > 0 || tierPromotions.length > 0) {
                html += '<h4 style="color: #10b981;">✨ Celebrate This Week</h4><ul style="margin: 1rem 0;">';
                
                if (tierPromotions.length > 0) {
                    html += `<li>🎉 ${tierPromotions.length} students earned tier promotions: ${tierPromotions.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                }
                
                if (breakthroughStudents.length > 0) {
                    html += `<li>🚀 ${breakthroughStudents.length} students hit breakthrough velocity: ${breakthroughStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                }
                
                html += '<li style="margin-left: 2rem; color: #666;">→ Public recognition builds momentum</li>';
                html += '</ul>';
            }
            
            // Comparison to Campus
            html += '<h4 style="color: #667eea;">📊 How You Compare to Campus</h4>';
            html += '<div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin: 1rem 0;">';
            
            if (avgVel > campusAvgVel) {
                html += `<div style="color: #10b981; margin-bottom: 0.5rem;">✅ Your velocity (${avgVel.toFixed(2)}) is above campus average (${campusAvgVel.toFixed(2)})</div>`;
            } else {
                html += `<div style="color: #f59e0b; margin-bottom: 0.5rem;">⚠️ Your velocity (${avgVel.toFixed(2)}) is below campus average (${campusAvgVel.toFixed(2)})</div>`;
                html += '<div style="margin-left: 1.5rem; font-size: 0.9rem; color: #666;">Consider: group pacing strategies, peer accountability partners</div>';
            }
            
            if (avgAtt > campusAvgAtt) {
                html += `<div style="color: #10b981;">✅ Your attendance (${avgAtt.toFixed(1)}%) is above campus average (${campusAvgAtt.toFixed(1)}%)</div>`;
            } else {
                html += `<div style="color: #f59e0b;">⚠️ Your attendance (${avgAtt.toFixed(1)}%) is below campus average (${campusAvgAtt.toFixed(1)}%)</div>`;
                html += '<div style="margin-left: 1.5rem; font-size: 0.9rem; color: #666;">Consider: morning check-in texts, transportation support</div>';
            }
            
            html += '</div>';
            
            // Time Budget
            html += '<h4 style="color: #667eea;">⏰ Suggested Time Allocation This Week</h4>';
            html += '<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">';
            
            const crisisTime = crisisStudents.length * 30;
            const highRiskTime = highRiskStudents.length * 15;
            const watchTime = watchStudents.length * 5;
            const totalTime = crisisTime + highRiskTime + watchTime;
            
            html += `<div style="margin-bottom: 0.5rem;"><strong>Crisis (${crisisStudents.length} students):</strong> ~${crisisTime} minutes (30 min each)</div>`;
            html += `<div style="margin-bottom: 0.5rem;"><strong>High Risk (${highRiskStudents.length} students):</strong> ~${highRiskTime} minutes (15 min each)</div>`;
            html += `<div style="margin-bottom: 0.5rem;"><strong>Watch (${watchStudents.length} students):</strong> ~${watchTime} minutes (5 min check-ins)</div>`;
            html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #ddd;"><strong>Total estimated time:</strong> ${Math.ceil(totalTime / 60)} hours ${totalTime % 60} minutes</div>`;
            
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">🎯 Advisor Priorities: ${advisorName}</h2>
                        <button onclick="document.getElementById('advisorRecommendationsModal').remove()" style="background: #941b1f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ================== PDF EXPORT ==================
        function exportToPDF() {
            // Hide action buttons temporarily
            const actionButtons = document.querySelector('div[style*="display: flex"]');
            if (actionButtons) actionButtons.style.display = 'none';
            
            // Trigger print dialog (user can save as PDF)
            window.print();
            
            // Restore buttons after print
            setTimeout(() => {
                if (actionButtons) actionButtons.style.display = 'flex';
            }, 100);
        }
        
        function exportPerfectWeekToPDF() {
            // Trigger print dialog - no-print class handles hiding buttons
            window.print();
        }
        
        // ================== ADVISOR NOTES FUNCTIONS ==================
        function openNoteLogger() {
            if (!currentStudent) return;
            
            // Get current student's info
            const studentId = currentStudent.name.split(',')[0].trim(); // Last name: "FLORES"
            const studentName = currentStudent.name; // Full name: "FLORES, MARIA"
            const today = new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            
            // Build pre-filled form URL
            const formUrl = `${FORM_BASE_URL}&${FORM_ENTRIES.studentId}=${encodeURIComponent(studentId)}&${FORM_ENTRIES.studentName}=${encodeURIComponent(studentName)}&${FORM_ENTRIES.date}=${encodeURIComponent(today)}`;
            
            // Open form in new window
            window.open(formUrl, '_blank', 'width=700,height=800');
        }
        
        function renderStudentNotes(student) {
            const notesContainer = document.getElementById('studentNotesDisplay');
            
            if (!notesContainer) return;
            
            // Get notes for this student - match on Student Name (full name)
            const studentNotes = advisorNotes.filter(note => {
                return note.studentName.toUpperCase().trim() === student.name.toUpperCase().trim();
            });
            
            if (studentNotes.length === 0) {
                notesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                        No notes logged yet. Click "Log Note" to add the first interaction note for this student.
                    </div>
                `;
                return;
            }
            
            // Sort notes by timestamp (newest first)
            studentNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Render notes
            const notesHtml = studentNotes.map(note => {
                const timestamp = new Date(note.timestamp).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                // Get display name for advisor
                const advisorDisplay = advisorDisplayNames[note.advisor] || note.advisor;
                
                // Color code by note type
                let noteTypeColor = '#667eea'; // default
                if (note.noteType === 'Intervention') noteTypeColor = '#f59e0b';
                if (note.noteType === 'Parent Contact') noteTypeColor = '#8b5cf6';
                if (note.noteType === 'Behavioral Note') noteTypeColor = '#ef4444';
                if (note.noteType === 'Academic Progress') noteTypeColor = '#10b981';
                
                return `
                    <div style="border-left: 4px solid ${noteTypeColor}; background: #f9fafb; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="font-weight: 600; color: ${noteTypeColor};">${note.noteType}</span>
                                <span style="color: #666; font-size: 0.9rem; margin-left: 1rem;">by ${advisorDisplay}</span>
                            </div>
                            <span style="color: #999; font-size: 0.85rem;">${timestamp}</span>
                        </div>
                        <div style="color: #333; line-height: 1.6;">${note.noteDetails}</div>
                    </div>
                `;
            }).join('');
            
            notesContainer.innerHTML = `
                <div style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
                    <strong>${studentNotes.length}</strong> interaction${studentNotes.length !== 1 ? 's' : ''} logged
                </div>
                ${notesHtml}
            `;
        }
        
        // ================== INITIALIZE ==================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
