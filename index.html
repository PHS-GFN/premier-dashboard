<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier High School - Gallery North Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-card.good { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.danger { border-left-color: #ef4444; }
        .stat-card.info { border-left-color: #3b82f6; }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
            margin: 0.5rem 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-desc {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        
        .stat-target {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Print styles for PDF export */
        @media print {
            body {
                background: white;
            }
            
            .header {
                background: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .dashboard-gauges,
            .wins-banner,
            .metrics-split,
            .advisor-spotlight,
            .highlights-section,
            .advisor-grid,
            .momentum-tracker-section,
            .waterfall-section,
            .table-wrapper {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .footer {
                position: fixed;
                bottom: 0;
                width: 100%;
            }
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }
        
        .main-view, .advisor-view, .student-view, .filtered-list-view {
            display: none;
        }
        
        .main-view.active, .advisor-view.active, .student-view.active, .filtered-list-view.active {
            display: block;
        }
        
        .back-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: #5568d3;
            transform: translateX(-5px);
        }
        
        .wins-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .wins-banner h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wins-list {
            display: grid;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .win-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .win-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        .metrics-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .metrics-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metrics-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .challenges h3 { color: #ef4444; }
        .celebrations h3 { color: #10b981; }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.95rem;
            color: #666;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .status-good { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-danger { color: #ef4444; }
        
        .advisor-spotlight {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .advisor-spotlight h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .spotlight-reason {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .advisor-spotlight-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .spotlight-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .spotlight-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .spotlight-stat:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        .spotlight-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .spotlight-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .highlights-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .highlights-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        .highlight-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .highlight-card.blue { border-left: 4px solid #3b82f6; background: #eff6ff; }
        .highlight-card.teal { border-left: 4px solid #14b8a6; background: #f0fdfa; }
        .highlight-card.yellow { border-left: 4px solid #f59e0b; background: #fffbeb; }
        
        .highlight-card h4 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #333;
        }
        
        .highlight-students {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .highlight-student {
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #667eea;
        }
        
        .highlight-student:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .highlight-student-meta {
            font-size: 0.85rem;
            color: #666;
            font-weight: normal;
        }
        
        .momentum-tracker-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .momentum-tracker-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .momentum-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .momentum-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .momentum-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .momentum-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .momentum-btn-change {
            font-size: 0.9rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }
        
        .momentum-btn-change.positive { color: #10b981; }
        .momentum-btn-change.negative { color: #ef4444; }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }
        
        .advisor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .advisor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        
        .advisor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .advisor-card-border {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }
        
        .advisor-card-border.grade-a { background: #10b981; }
        .advisor-card-border.grade-b { background: #3b82f6; }
        .advisor-card-border.grade-c { background: #f59e0b; }
        .advisor-card-border.grade-d { background: #ef4444; }
        .advisor-card-border.grade-f { background: #7f1d1d; }
        
        .advisor-card-content {
            padding: 1.5rem;
            padding-left: 2rem;
        }
        
        .advisor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .advisor-card-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .advisor-card-grade {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
        
        .advisor-card-grade.grade-a { background: #10b981; }
        .advisor-card-grade.grade-b { background: #3b82f6; }
        .advisor-card-grade.grade-c { background: #f59e0b; }
        .advisor-card-grade.grade-d { background: #ef4444; }
        .advisor-card-grade.grade-f { background: #7f1d1d; }
        
        .advisor-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .advisor-stat-item {
            padding: 0.5rem;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .advisor-stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .advisor-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .heatmap-very-good { background: #d1fae5 !important; color: #065f46; }
        .heatmap-good { background: #a7f3d0 !important; color: #047857; }
        .heatmap-neutral { background: #f3f4f6 !important; color: #374151; }
        .heatmap-warning { background: #fef3c7 !important; color: #92400e; }
        .heatmap-bad { background: #fecaca !important; color: #991b1b; }
        .heatmap-very-bad { background: #fca5a5 !important; color: #7f1d1d; }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .controls-row {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .search-box {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .student-table {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 1rem 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        th.sortable:hover {
            background: #e2e8f0;
        }
        
        td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        
        /* Specific column widths for better fit */
        th:nth-child(1), td:nth-child(1) { min-width: 180px; } /* Student Name */
        th:nth-child(2), td:nth-child(2) { width: 100px; } /* Risk Tier */
        th:nth-child(3), td:nth-child(3) { width: 90px; } /* Velocity */
        th:nth-child(4), td:nth-child(4) { width: 120px; } /* Trajectory */
        th:nth-child(5), td:nth-child(5) { width: 100px; } /* Acceleration */
        th:nth-child(6), td:nth-child(6) { min-width: 180px; } /* Pattern */
        th:nth-child(7), td:nth-child(7) { width: 80px; } /* Badges */
        th:nth-child(8), td:nth-child(8) { width: 100px; } /* Units */
        th:nth-child(9), td:nth-child(9) { width: 100px; } /* Ahead/Behind */
        th:nth-child(10), td:nth-child(10) { width: 100px; } /* Last Activity */
        th:nth-child(11), td:nth-child(11) { width: 100px; } /* Attendance */
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        .student-name-link {
            color: #667eea;
            cursor: pointer;
            font-weight: 500;
        }
        
        .student-name-link:hover {
            text-decoration: underline;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .tier-badge.tier-1 { background: #fee2e2; color: #991b1b; }
        .tier-badge.tier-2 { background: #fed7aa; color: #9a3412; }
        .tier-badge.tier-3 { background: #fef3c7; color: #92400e; }
        .tier-badge.tier-4 { background: #d1fae5; color: #065f46; }
        .tier-badge.tier-5 { background: #ddd6fe; color: #5b21b6; border: 2px solid #8b5cf6; }
        
        .trajectory-breakthrough { color: #10b981; font-size: 1.2rem; font-weight: bold; }
        .trajectory-building { color: #059669; font-weight: 600; }
        .trajectory-stable { color: #3b82f6; }
        .trajectory-declining { color: #f59e0b; font-weight: 600; }
        .trajectory-rapid_decline { color: #ef4444; font-size: 1.2rem; font-weight: bold; }
        
        .consistency-dots {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .consistency-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        .consistency-dot.filled {
            background: #333;
        }
        
        .consistency-dot.empty {
            background: white;
        }
        
        .consistency-label {
            margin-left: 0.5rem;
            font-size: 0.85rem;
            color: #666;
        }
        
        .student-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .student-view-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .student-view-meta {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .student-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .student-metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .student-metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .student-metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .student-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .student-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .semester-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .semester-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .semester-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .semester-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .achievement-list, .concern-list {
            list-style: none;
            padding: 0;
        }
        
        .achievement-list li, .concern-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .achievement-list li {
            border-left: 4px solid #10b981;
        }
        
        .concern-list li {
            border-left: 4px solid #ef4444;
        }
        
        .badge-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .badge-icon {
            font-size: 1.5rem;
        }
        
        .badge-text {
            font-size: 0.9rem;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Premier High School - Gallery North</h1>
        <div class="subtitle">Student Progress Dashboard</div>
        <div class="subtitle" id="dateRange" style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.85;"></div>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">
            üìä Loading data from Google Sheets...
        </div>

        <!-- Main Dashboard View -->
        <div id="mainView" class="main-view">
            <!-- Dashboard Stats -->
            <div class="dashboard-stats" id="dashboardStats"></div>
            
            <!-- Wins Banner -->
            <div class="wins-banner">
                <h2>üèÜ This Period's Wins</h2>
                <div class="wins-list" id="winsList"></div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center;">
                <button onclick="generateAIRecommendations()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üéØ Get Smart Recommendations
                </button>
                <button onclick="exportToPDF()" style="background: #10b981; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üìÑ Export to PDF
                </button>
            </div>

            <!-- This Week's Stars -->
            <div class="highlights-section">
                <h2>‚≠ê This Week's Stars</h2>
                <div class="highlights-grid" id="highlightsGrid"></div>
            </div>

            <!-- Celebrations & Challenges -->
            <div class="metrics-split">
                <div class="metrics-section celebrations">
                    <h3>‚ú® Celebrations</h3>
                    <div id="celebrationsContent"></div>
                </div>
                
                <div class="metrics-section challenges">
                    <h3>‚ö†Ô∏è Challenges</h3>
                    <div id="challengesContent"></div>
                </div>
            </div>

            <!-- Advisor Spotlight -->
            <div class="advisor-spotlight" id="advisorSpotlight"></div>

            <!-- Advisor Performance -->
            <div class="section-header">üë• Advisor Performance (Click to View Students)</div>
            <div class="advisor-grid" id="advisorGrid"></div>
            
            <!-- Momentum Tracker -->
            <div class="momentum-tracker-section">
                <h2>üéØ Student Momentum Tracker</h2>
                <div class="momentum-buttons" id="momentumButtons"></div>
            </div>
            
            <!-- Waterfall Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <span>üìä Student Performance Overview</span>
                </div>
                <canvas id="waterfallChart" height="100"></canvas>
            </div>

            <!-- Main Student Dashboard -->
            <div class="section-header">üë®‚Äçüéì All Students Dashboard</div>
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search students by name...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="5" data-type="tier">‚≠ê Superstars</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">üü¢ On Track</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">üü° Watch</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">üü† High Risk</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">üî¥ Crisis</button>
                    </div>
                </div>
                <div class="controls-row">
                    <strong>Trajectory:</strong>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" data-type="trajectory">All</button>
                        <button class="filter-btn" data-filter="breakthrough" data-type="trajectory">üöÄ Breakthrough</button>
                        <button class="filter-btn" data-filter="building" data-type="trajectory">üìà Building</button>
                        <button class="filter-btn" data-filter="stable" data-type="trajectory">üü¢ Stable</button>
                        <button class="filter-btn" data-filter="declining" data-type="trajectory">üìâ Declining</button>
                        <button class="filter-btn" data-filter="rapid_decline" data-type="trajectory">üîª Rapid Decline</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                <th class="sortable" data-sort="acceleration">Acceleration</th>
                                <th>Pattern</th>
                                <th>Badges</th>
                                <th class="sortable" data-sort="units">Completed Units</th>
                                <th class="sortable" data-sort="behind">Ahead/Behind</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Advisor View -->
        <div id="advisorView" class="advisor-view">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Dashboard</button>
            <div class="advisor-view-header" id="advisorViewHeader"></div>
            
            <div class="controls">
                <div class="controls-row">
                    <input type="text" class="search-box" id="advisorSearchBox" placeholder="üîç Search students...">
                </div>
                <div class="controls-row">
                    <strong>Risk Tiers:</strong>
                    <div class="filter-group" id="advisorTierFilters">
                        <button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
                        <button class="filter-btn" data-filter="1" data-type="tier">üî¥ Crisis</button>
                        <button class="filter-btn" data-filter="2" data-type="tier">üü† High Risk</button>
                        <button class="filter-btn" data-filter="3" data-type="tier">üü° Watch</button>
                        <button class="filter-btn" data-filter="4" data-type="tier">üü¢ On Track</button>
                    </div>
                </div>
            </div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="advisorStudentTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Student Name</th>
                                <th class="sortable" data-sort="tier">Risk Tier</th>
                                <th class="sortable" data-sort="velocity">Velocity</th>
                                <th class="sortable" data-sort="trajectory">Trajectory</th>
                                <th class="sortable" data-sort="acceleration">Acceleration</th>
                                <th>Pattern</th>
                                <th>Badges</th>
                                <th class="sortable" data-sort="units">Completed Units</th>
                                <th class="sortable" data-sort="behind">Ahead/Behind</th>
                                <th class="sortable" data-sort="days_since">Last Activity</th>
                                <th class="sortable" data-sort="attendance">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="advisorStudentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Student View -->
        <div id="studentView" class="student-view">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Dashboard</button>
            <div class="student-view-header" id="studentViewHeader"></div>
            
            <div class="student-metrics-grid" id="studentMetricsGrid"></div>
            
            <div class="student-section">
                <div class="student-section-title">üìà Progress Over Time</div>
                <div class="semester-filters">
                    <button class="semester-btn active" data-semester="ytd">School Year to Date</button>
                    <button class="semester-btn" data-semester="fall">Fall Semester</button>
                    <button class="semester-btn" data-semester="spring">Spring Semester</button>
                </div>
                <div class="student-chart-container">
                    <canvas id="studentProgressChart"></canvas>
                </div>
            </div>
            
            <div class="student-section">
                <div class="student-section-title">üéØ Consistency Pattern</div>
                <div id="studentPatternDetail"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                <div class="student-section">
                    <div class="student-section-title">üèÜ Achievements</div>
                    <ul class="achievement-list" id="studentAchievements"></ul>
                </div>
                
                <div class="student-section">
                    <div class="student-section-title">‚ö†Ô∏è Concerns & Recommendations</div>
                    <ul class="concern-list" id="studentConcerns"></ul>
                </div>
            </div>
        </div>

        <!-- Filtered List View -->
        <div id="filteredListView" class="filtered-list-view">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Dashboard</button>
            <div class="student-view-header" id="filteredListHeader"></div>
            
            <div class="student-table">
                <div class="table-wrapper">
                    <table id="filteredTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Risk Tier</th>
                                <th>Trajectory</th>
                                <th>Velocity</th>
                                <th>Ahead/Behind</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="filteredTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" id="lastUpdate">
        Last Updated: -<br>
        <small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>
    </div>

    <script>
        // ================== CONFIGURATION ==================
        const SHEET_ID = '1QZIDSV1l7mee6WUTgjeuKr6drmp97pDBF68jYD00ieA';
        const SHEET_NAME = 'Dashboard_Data';
        const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        
        // ================== GLOBAL STATE ==================
        let dashboardData = null;
        let previousData = null;
        let currentAdvisor = null;
        let currentStudent = null;
        let currentSemester = 'ytd';
        let currentFilters = {
            tier: 'all',
            trajectory: 'all',
            search: ''
        };
        let currentSort = {
            column: 'velocity',
            direction: 'desc'
        };
        let waterfallChart = null;
        let studentProgressChart = null;
        
        // ================== ACHIEVEMENT DEFINITIONS ==================
        const ACHIEVEMENTS = [
            { id: 'first_10', icon: 'üéØ', name: 'First 10 Units', check: s => s.currentUnits >= 10 },
            { id: '25_club', icon: 'üî•', name: '25 Units Club', check: s => s.currentUnits >= 25 },
            { id: '50_club', icon: '‚≠ê', name: '50 Units Club', check: s => s.currentUnits >= 50 },
            { id: '75_club', icon: 'üíé', name: '75 Units Club', check: s => s.currentUnits >= 75 },
            { id: '100_club', icon: 'üëë', name: '100 Units Club', check: s => s.currentUnits >= 100 },
            { id: 'speed_demon', icon: 'üöÄ', name: 'Speed Demon', check: s => s.velocity >= 3 },
            { id: 'consistent_climber', icon: 'üìà', name: 'Consistent Climber', check: s => s.acceleration > 0.5 && s.consistencyRatio > 0.75 },
            { id: 'sprint_finish', icon: '‚ö°', name: 'Sprint Finish', check: s => s.records.some((r, i) => i > 0 && (r.completed - s.records[i-1].completed) >= 5) },
            { id: 'perfect_attendance', icon: 'üíØ', name: 'Perfect Attendance', check: s => s.avgAttendance >= 99.5 },
            { id: 'excellent_attendance', icon: '‚≠ê', name: 'Excellent Attendance', check: s => s.avgAttendance >= 95 },
            { id: 'strong_attendance', icon: 'üéØ', name: 'Strong Attendance', check: s => s.avgAttendance >= 90 },
            { id: 'rock_solid', icon: 'üü¢', name: 'Rock Solid', check: s => s.consistencyRatio >= 0.9 },
            { id: 'steady_progress', icon: '‚≠ê', name: 'Steady Progress', check: s => s.consistencyRatio >= 0.75 },
            { id: 'tier_promotion', icon: 'üèÜ', name: 'Tier Promotion', check: s => s.tierChange > 0 },
            { id: 'comeback_kid', icon: 'üí™', name: 'Comeback Kid', check: s => s.trajectory === 'breakthrough' && s.tierChange > 0 },
            { id: 'on_target', icon: 'üéØ', name: 'On Target', check: s => Math.abs(s.tracking) <= 2 },
            { id: 'ahead_of_pace', icon: 'üî•', name: 'Ahead of Pace', check: s => s.tracking >= 5 },
            { id: 'sustained_improvement', icon: 'üìà', name: 'Sustained Improvement', check: s => s.acceleration > 0 && s.velocity > 2 }
        ];
        
        // ================== DATA LOADING ==================
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                const csvText = await response.text();
                const rawData = parseCSV(csvText);
                console.log(`Loaded ${rawData.length} rows from Google Sheets`);
                
                // Store previous week's data for comparison
                if (dashboardData) {
                    previousData = JSON.parse(JSON.stringify(dashboardData));
                }
                
                dashboardData = processData(rawData);
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    '‚ùå Error loading data. Please check your Google Sheets share settings.<br><small>Make sure "Anyone with the link can view" is enabled.</small>';
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (line[i] === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += line[i];
                }
            }
            result.push(current);
            return result;
        }
        
        // ================== DATA PROCESSING ==================
        function processData(data) {
            // Group data by student
            const studentMap = new Map();
            const allDates = new Set();
            
            data.forEach(row => {
                const name = row['Student Name'];
                if (!name) return;
                
                const weekDate = row.Week_Date;
                allDates.add(weekDate);
                
                if (!studentMap.has(name)) {
                    studentMap.set(name, []);
                }
                
                studentMap.get(name).push({
                    date: new Date(weekDate),
                    week: weekDate,
                    advisor: row.Advisor,
                    attendance: parseFloat(row['% Present']) || 0,
                    expected: parseFloat(row['Units Expected']) || 0,
                    completed: parseInt(row['# Units Completed']) || 0
                });
            });
            
            const sortedDates = Array.from(allDates).sort();
            const weekNumber = sortedDates.length;
            const spotlightWeek = ((weekNumber - 1) % 5) + 1;
            
            // Identify new and dropped students
            const recentDates = sortedDates.slice(-2); // Last 2 uploads
            const activeStudents = new Set();
            const newStudents = new Set();
            
            // Find students in recent data
            data.forEach(row => {
                const name = row['Student Name'];
                const weekDate = row.Week_Date;
                if (name && recentDates.includes(weekDate)) {
                    activeStudents.add(name);
                }
            });
            
            // Mark new students (first appearance is recent)
            studentMap.forEach((records, name) => {
                const firstAppearance = records[0].week;
                const firstAppearanceIndex = sortedDates.indexOf(firstAppearance);
                // New if appeared in last 3 uploads
                if (firstAppearanceIndex >= sortedDates.length - 3) {
                    newStudents.add(name);
                }
            });
            
            // Calculate metrics for each student
            const students = [];
            
            studentMap.forEach((records, name) => {
                records.sort((a, b) => a.date - b.date);
                
                if (records.length === 0) return;
                
                // Skip dropped students (not in last 2 uploads)
                if (!activeStudents.has(name)) return;
                
                const latest = records[records.length - 1];
                const earliest = records[0];
                const firstRecord = records[0];
                
                // Mark if this is a new student
                const isNew = newStudents.has(name);
                
                // For new students, adjust expected units to start from first appearance
                let adjustedExpected = latest.expected;
                if (isNew) {
                    // Expected should be based on weeks since they started
                    const weeksSinceStart = records.length - 1;
                    adjustedExpected = weeksSinceStart * 2; // 2 units per week expectation
                }
                
                // Calculate velocity
                const weeks = records.length > 1 ? records.length - 1 : 1;
                const unitsGained = latest.completed - earliest.completed;
                const velocity = weeks > 0 ? unitsGained / weeks : 0;
                
                // Calculate acceleration
                let acceleration = 0;
                let earlyVelocity = 0;
                let recentVelocity = 0;
                
                if (records.length >= 3) {
                    const midPoint = Math.floor(records.length / 2);
                    const firstHalf = records.slice(0, midPoint);
                    const secondHalf = records.slice(midPoint);
                    
                    earlyVelocity = firstHalf.length > 1 ? 
                        (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                    recentVelocity = secondHalf.length > 1 ?
                        (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                    
                    acceleration = recentVelocity - earlyVelocity;
                }
                
                // Calculate tracking
                const tracking = latest.completed - adjustedExpected;
                
                // Average attendance - MUST calculate before tier determination
                const avgAttendance = records.reduce((sum, r) => sum + r.attendance, 0) / records.length;
                
                // Determine tier (5 levels now)
                let tier = 4; // On Track (default)
                let tierLabel = 'On Track';
                
                // Check for Superstar first (highest tier)
                if (velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90) {
                    tier = 5;
                    tierLabel = 'Superstar';
                }
                // On Track
                else if (tracking >= -1 && avgAttendance >= 80) {
                    tier = 4;
                    tierLabel = 'On Track';
                }
                // Watch - slightly behind OR inconsistent attendance
                else if (tracking >= -4 || (tracking < -1 && avgAttendance >= 80)) {
                    tier = 3;
                    tierLabel = 'Watch';
                }
                // High Risk - moderately behind OR rapid decline
                else if (tracking >= -9 || (acceleration < -1.5 && tracking < 0)) {
                    tier = 2;
                    tierLabel = 'High Risk';
                }
                // Crisis - severely behind
                else {
                    tier = 1;
                    tierLabel = 'Crisis';
                }
                
                // Determine first tier for comparison
                const firstTracking = firstRecord.completed - firstRecord.expected;
                const firstAttendance = records[0].attendance;
                let firstTier = 4;
                
                if (velocity >= 2.5 && firstTracking >= 3 && firstAttendance >= 90) {
                    firstTier = 5;
                } else if (firstTracking >= -1 && firstAttendance >= 80) {
                    firstTier = 4;
                } else if (firstTracking >= -4) {
                    firstTier = 3;
                } else if (firstTracking >= -9) {
                    firstTier = 2;
                } else {
                    firstTier = 1;
                }
                
                const tierChange = tier - firstTier;
                
                // Determine trajectory - consider both acceleration AND current position
                let trajectory = 'stable';
                let trajectoryLabel = 'Stable';
                let trajectoryIcon = '‚û°Ô∏è';
                
                // Strong positive trajectory
                if (acceleration > 1.5 && velocity >= 1.5) {
                    trajectory = 'breakthrough';
                    trajectoryLabel = 'BLAST OFF!';
                    trajectoryIcon = 'üöÄ';
                } 
                // Building momentum
                else if (acceleration > 0.5) {
                    trajectory = 'building';
                    trajectoryLabel = 'Building';
                    trajectoryIcon = 'üìà';
                } 
                // Critical decline - only if behind or losing ground fast
                else if (acceleration < -1.5 && (tracking < -3 || velocity < 1.5)) {
                    trajectory = 'rapid_decline';
                    trajectoryLabel = 'URGENT!';
                    trajectoryIcon = '‚ö†Ô∏è';
                } 
                // Regular decline
                else if (acceleration < -0.5) {
                    trajectory = 'declining';
                    trajectoryLabel = 'Declining';
                    trajectoryIcon = 'üìâ';
                }
                // Otherwise stable
                
                // Days since last activity
                let daysSince = Math.floor((new Date() - latest.date) / (1000 * 60 * 60 * 24));
                
                // Check for last activity (when units actually changed)
                for (let i = records.length - 1; i > 0; i--) {
                    if (records[i].completed !== records[i - 1].completed) {
                        daysSince = Math.floor((new Date() - records[i].date) / (1000 * 60 * 60 * 24));
                        break;
                    }
                }
                
                // Consistency pattern (2+ units = goal hit)
                const consistencyPattern = records.map(r => {
                    const weeklyGain = r.completed - (records[records.indexOf(r) - 1]?.completed || 0);
                    return weeklyGain >= 2;
                });
                const activeWeeks = consistencyPattern.filter(Boolean).length;
                const consistencyRatio = activeWeeks / records.length;
                
                let consistencyLabel = 'Steady';
                let consistencyIcon = 'üü¢';
                if (consistencyRatio < 0.5) {
                    consistencyLabel = 'Inconsistent';
                    consistencyIcon = 'üî¥';
                } else if (consistencyRatio < 0.75) {
                    consistencyLabel = 'Bursty';
                    consistencyIcon = 'üü°';
                }
                
                // Pattern display (dots) - show current semester or last 12 weeks
                const now = new Date();
                const currentYear = now.getFullYear();
                
                // Determine current semester
                const fallStart = new Date(currentYear, 7, 12); // Aug 12
                const fallEnd = new Date(currentYear, 11, 19); // Dec 19
                const springStart = new Date(currentYear, 0, 6); // Jan 6
                const springEnd = new Date(currentYear, 5, 4); // Jun 4
                
                let semesterRecords = records;
                if (now >= fallStart && now <= fallEnd) {
                    // Fall semester
                    semesterRecords = records.filter(r => r.date >= fallStart && r.date <= fallEnd);
                } else if (now >= springStart && now <= springEnd) {
                    // Spring semester
                    semesterRecords = records.filter(r => r.date >= springStart && r.date <= springEnd);
                }
                
                // If no semester records or too many, show last 12
                let displayRecords = semesterRecords.length > 0 && semesterRecords.length <= 20 ? 
                    semesterRecords : records.slice(-12);
                
                const patternDisplay = displayRecords.map((r, i) => {
                    if (i === 0) return { filled: r.completed > 0, week: r.week };
                    const prevRecord = displayRecords[i - 1];
                    const weeklyGain = r.completed - prevRecord.completed;
                    return { filled: weeklyGain >= 2, week: r.week };
                });
                
                // Calculate superstars (high performers) - matches tier 5 criteria
                const isSuperstar = velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90;
                
                const student = {
                    name,
                    advisor: latest.advisor,
                    records,
                    latest,
                    velocity,
                    earlyVelocity,
                    recentVelocity,
                    acceleration,
                    tracking,
                    tier,
                    tierLabel,
                    firstTier,
                    tierChange,
                    trajectory,
                    trajectoryLabel,
                    trajectoryIcon,
                    avgAttendance,
                    unitsGained,
                    currentUnits: latest.completed,
                    currentBehind: tracking,
                    daysSince,
                    consistencyLabel,
                    consistencyIcon,
                    consistencyRatio,
                    patternDisplay,
                    isSuperstar,
                    isNew
                };
                
                // Calculate badges/achievements
                student.badges = ACHIEVEMENTS.filter(a => a.check(student));
                
                students.push(student);
            });
            
            // Calculate summary stats
            const summary = {
                totalStudents: students.length,
                avgVelocity: students.reduce((sum, s) => sum + s.velocity, 0) / students.length,
                avgAttendance: students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length,
                superstars: students.filter(s => s.tier === 5).length,
                onTrack: students.filter(s => s.tier === 4).length,
                watch: students.filter(s => s.tier === 3).length,
                highRisk: students.filter(s => s.tier === 2).length,
                crisis: students.filter(s => s.tier === 1).length,
                improving: students.filter(s => s.acceleration > 0).length,
                declining: students.filter(s => s.acceleration < 0).length,
                stable: students.filter(s => s.acceleration === 0).length,
                tierPromotions: students.filter(s => s.tierChange > 0).length,
                breakthrough: students.filter(s => s.trajectory === 'breakthrough').length,
                building: students.filter(s => s.trajectory === 'building').length,
                stableTrajectory: students.filter(s => s.trajectory === 'stable').length,
                decliningTrajectory: students.filter(s => s.trajectory === 'declining').length,
                rapidDecline: students.filter(s => s.trajectory === 'rapid_decline').length
            };
            
            // Find highlights
            const topGainers = [...students].sort((a, b) => b.unitsGained - a.unitsGained).slice(0, 3);
            const topAccel = [...students].filter(s => s.acceleration > 0).sort((a, b) => b.acceleration - a.acceleration).slice(0, 3);
            const perfectWeek = students.filter(s => s.avgAttendance >= 95 && s.velocity >= 2);
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            // Advisor stats with grading
            const advisorMap = new Map();
            students.forEach(s => {
                if (!advisorMap.has(s.advisor)) {
                    advisorMap.set(s.advisor, []);
                }
                advisorMap.get(s.advisor).push(s);
            });
            
            // Calculate advisor grades
            const advisorStats = [];
            advisorMap.forEach((students, name) => {
                const totalStudents = students.length;
                const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / totalStudents;
                const improving = students.filter(s => s.acceleration > 0).length;
                const crisis = students.filter(s => s.tier === 1).length;
                const highRisk = students.filter(s => s.tier === 2).length;
                const superstars = students.filter(s => s.isSuperstar).length;
                const avgAccel = students.reduce((sum, s) => sum + s.acceleration, 0) / totalStudents;
                const avgAtt = students.reduce((sum, s) => sum + s.avgAttendance, 0) / totalStudents;
                
                const crisisRatio = crisis / totalStudents;
                const superstarRatio = superstars / totalStudents;
                
                // Calculate score (0-100)
                let score = 0;
                score += (1 - Math.min(crisisRatio, 0.3) / 0.3) * 30; // 30% weight on low crisis
                score += Math.min(avgVel / 3, 1) * 25; // 25% weight on velocity (cap at 3)
                score += superstarRatio * 20; // 20% weight on superstars
                score += (avgAccel > 0 ? Math.min(avgAccel / 2, 1) : 0) * 15; // 15% weight on positive accel
                score += Math.min(avgAtt / 100, 1) * 10; // 10% weight on attendance
                
                advisorStats.push({
                    name,
                    students,
                    totalStudents,
                    avgVelocity: avgVel,
                    improving,
                    improvingPercent: (improving / totalStudents * 100),
                    crisis,
                    highRisk,
                    superstars,
                    avgAcceleration: avgAccel,
                    avgAttendance: avgAtt,
                    score
                });
            });
            
            // Assign grades based on percentile
            advisorStats.sort((a, b) => b.score - a.score);
            advisorStats.forEach((advisor, index) => {
                const percentile = index / advisorStats.length;
                if (percentile < 0.2) advisor.grade = 'A';
                else if (percentile < 0.5) advisor.grade = 'B';
                else if (percentile < 0.8) advisor.grade = 'C';
                else if (percentile < 0.95) advisor.grade = 'D';
                else advisor.grade = 'F';
            });
            
            // Rotating spotlight
            const spotlightCriteria = [
                { name: 'Fastest Progress Team', sort: (a, b) => b.avgVelocity - a.avgVelocity, reason: 'Highest average velocity' },
                { name: 'Most Stable Team', sort: (a, b) => (a.crisis / a.totalStudents) - (b.crisis / b.totalStudents), reason: 'Lowest crisis percentage' },
                { name: 'Most Improving Team', sort: (a, b) => b.avgAcceleration - a.avgAcceleration, reason: 'Best acceleration' },
                { name: 'Excellence Champion', sort: (a, b) => (b.superstars / b.totalStudents) - (a.superstars / a.totalStudents), reason: 'Highest percentage of high performers' },
                { name: 'Momentum Leader', sort: (a, b) => (b.improving / b.totalStudents) - (a.improving / a.totalStudents), reason: 'Most students improving' }
            ];
            
            const criterion = spotlightCriteria[spotlightWeek - 1];
            const sortedAdvisors = [...advisorStats].sort(criterion.sort);
            const topAdvisor = sortedAdvisors[0];
            topAdvisor.spotlightReason = criterion.reason;
            topAdvisor.spotlightTitle = criterion.name;
            
            return {
                students,
                summary,
                highlights: {
                    topGainers,
                    topAccel,
                    perfectWeek,
                    tierPromotions
                },
                advisorSpotlight: topAdvisor,
                advisorStats,
                advisorMap,
                weekNumber,
                sortedDates,
                generated: new Date().toLocaleString()
            };
        }
        
        // ================== UI INITIALIZATION ==================
        function initializeDashboard() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            // Set date range
            const firstDate = new Date(dashboardData.sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('dateRange').textContent = `Data Period: ${firstDate} - ${lastDate}`;
            
            renderDashboardStats();
            renderWinsBanner();
            renderChallengesCelebrations();
            renderAdvisorSpotlight();
            renderHighlights();
            renderAdvisorCards();
            renderMomentumTracker();
            createWaterfallChart();
            renderStudentTable();
            setupEventListeners();
            
            document.getElementById('lastUpdate').innerHTML = 
                `Last Updated: ${dashboardData.generated}<br><small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>`;
        }
        
        function renderDashboardStats() {
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            
            // Calculate key metrics
            const onPaceCount = students.filter(s => s.velocity >= 2.0).length;
            const onPacePercent = (onPaceCount / summary.totalStudents * 100);
            
            // Calculate semester progress
            const now = new Date();
            const currentYear = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
            const schoolYearStart = new Date(currentYear, 7, 12); // Aug 12
            const schoolYearEnd = new Date(currentYear + 1, 5, 4); // Jun 4 next year
            const totalDays = (schoolYearEnd - schoolYearStart) / (1000 * 60 * 60 * 24);
            const daysPassed = (now - schoolYearStart) / (1000 * 60 * 60 * 24);
            const semesterProgress = Math.min(Math.max((daysPassed / totalDays * 100), 0), 100);
            
            const avgVelocity = summary.avgVelocity;
            const avgAttendance = summary.avgAttendance;
            const crisisCount = summary.crisis + summary.highRisk;
            const crisisPercent = (crisisCount / summary.totalStudents * 100);
            const superstarCount = summary.superstars;
            
            // Determine card styles based on thresholds
            const onPaceStyle = onPacePercent >= 70 ? 'good' : onPacePercent >= 50 ? 'warning' : 'danger';
            const velocityStyle = avgVelocity >= 2.0 ? 'good' : avgVelocity >= 1.6 ? 'warning' : 'danger';
            const attendanceStyle = avgAttendance >= 85 ? 'good' : avgAttendance >= 80 ? 'warning' : 'danger';
            const crisisStyle = crisisPercent <= 10 ? 'good' : crisisPercent <= 20 ? 'warning' : 'danger';
            
            const stats = [
                {
                    icon: 'üéØ',
                    value: onPacePercent.toFixed(0) + '%',
                    label: 'On-Pace Rate',
                    desc: `${onPaceCount} of ${summary.totalStudents} students at 2+ u/wk`,
                    target: 'Target: 70%+',
                    style: onPaceStyle
                },
                {
                    icon: '‚ö°',
                    value: avgVelocity.toFixed(2),
                    label: 'Avg Velocity',
                    desc: 'Units per week across all students',
                    target: 'Target: 2.0 u/wk',
                    style: velocityStyle
                },
                {
                    icon: 'üìÖ',
                    value: avgAttendance.toFixed(1) + '%',
                    label: 'Attendance',
                    desc: 'Class average attendance rate',
                    target: 'Target: 85%+',
                    style: attendanceStyle
                },
                {
                    icon: '‚ö†Ô∏è',
                    value: crisisCount,
                    label: 'At-Risk',
                    desc: `${crisisPercent.toFixed(0)}% Crisis/High Risk students`,
                    target: 'Target: <10%',
                    style: crisisStyle
                },
                {
                    icon: '‚≠ê',
                    value: superstarCount,
                    label: 'Superstars',
                    desc: `${(superstarCount/summary.totalStudents*100).toFixed(0)}% exceeding all targets`,
                    target: '2.5+ u/wk, +3 ahead, 90%+ attend',
                    style: 'info'
                },
                {
                    icon: 'üìà',
                    value: semesterProgress.toFixed(0) + '%',
                    label: 'Year Progress',
                    desc: 'School year completion',
                    target: `${Math.floor(daysPassed)} of ${Math.floor(totalDays)} days`,
                    style: 'info'
                }
            ];
            
            document.getElementById('dashboardStats').innerHTML = stats.map(s => `
                <div class="stat-card ${s.style}">
                    <div class="stat-icon">${s.icon}</div>
                    <div class="stat-value">${s.value}</div>
                    <div class="stat-label">${s.label}</div>
                    <div class="stat-desc">${s.desc}</div>
                    <div class="stat-target">${s.target}</div>
                </div>
            `).join('');
        }
        
        function renderWinsBanner() {
            const highlights = dashboardData.highlights;
            const summary = dashboardData.summary;
            
            const wins = [
                { 
                    text: `‚úÖ ${summary.tierPromotions} students promoted to higher tier`,
                    students: highlights.tierPromotions.map(s => s.name),
                    filter: 'tierPromotions'
                },
                { 
                    text: `‚úÖ ${summary.improving} students improving their velocity`,
                    students: dashboardData.students.filter(s => s.acceleration > 0).map(s => s.name),
                    filter: 'improving'
                },
                { 
                    text: `‚úÖ ${highlights.topGainers.length} students with significant progress`,
                    students: highlights.topGainers.map(s => s.name),
                    filter: 'topGainers'
                },
                { 
                    text: `‚úÖ ${highlights.perfectWeek.length} students achieved "Perfect Week"`,
                    students: highlights.perfectWeek.map(s => s.name),
                    filter: 'perfectWeek'
                },
                { 
                    text: `‚úÖ ${summary.superstars} high-performing students`,
                    students: dashboardData.students.filter(s => s.isSuperstar).map(s => s.name),
                    filter: 'superstars'
                }
            ];
            
            // Store wins data globally for access
            window.winsData = wins;
            
            document.getElementById('winsList').innerHTML = wins.map((w, idx) => 
                `<div class="win-item" onclick="showWinsList(${idx})">${w.text}</div>`
            ).join('');
        }
        
        function showWinsList(index) {
            const win = window.winsData[index];
            const showTierChanges = win.filter === 'tierPromotions';
            showFilteredList(win.students, win.text, showTierChanges);
        }
        
        function renderChallengesCelebrations() {
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            const avgVel = summary.avgVelocity;
            const avgAtt = summary.avgAttendance;
            const crisisPercent = (summary.crisis / summary.totalStudents * 100);
            const highRiskPercent = (summary.highRisk / summary.totalStudents * 100);
            const onTrackPercent = (summary.onTrack / summary.totalStudents * 100);
            const improvingPercent = (summary.improving / summary.totalStudents * 100);
            
            // Build challenge candidates with significance scores
            const challengeCandidates = [
                { 
                    label: 'Crisis Students', 
                    value: summary.crisis + ` (${crisisPercent.toFixed(0)}%)`,
                    score: crisisPercent * 2,
                    students: students.filter(s => s.tier === 1).map(s => s.name)
                },
                { 
                    label: 'High Risk Students', 
                    value: summary.highRisk + ` (${highRiskPercent.toFixed(0)}%)`,
                    score: highRiskPercent * 1.5,
                    students: students.filter(s => s.tier === 2).map(s => s.name)
                },
                { 
                    label: 'Students Below Target', 
                    value: summary.watch + summary.highRisk + summary.crisis,
                    score: ((summary.watch + summary.highRisk + summary.crisis) / summary.totalStudents) * 100,
                    students: students.filter(s => s.tier <= 3).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel < 1.6 ? (2.0 - avgVel) * 50 : 0,
                    students: students.filter(s => s.velocity < 1.6).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt < 80 ? (85 - avgAtt) * 3 : 0,
                    students: students.filter(s => s.avgAttendance < 80).map(s => s.name)
                },
                { 
                    label: 'Students Declining', 
                    value: summary.declining + summary.rapidDecline,
                    score: ((summary.declining + summary.rapidDecline) / summary.totalStudents) * 80,
                    students: students.filter(s => s.acceleration < -0.5).map(s => s.name)
                },
                { 
                    label: 'Rapid Decline Students', 
                    value: summary.rapidDecline,
                    score: (summary.rapidDecline / summary.totalStudents) * 120,
                    students: students.filter(s => s.trajectory === 'rapid_decline').map(s => s.name)
                }
            ];
            
            // Build celebration candidates with significance scores
            const celebrationCandidates = [
                { 
                    label: 'Students On Track or Ahead', 
                    value: summary.onTrack,
                    score: onTrackPercent,
                    students: students.filter(s => s.tier === 4).map(s => s.name)
                },
                { 
                    label: 'Students Improving', 
                    value: summary.improving + ` (${improvingPercent.toFixed(0)}%)`,
                    score: improvingPercent * 1.5,
                    students: students.filter(s => s.acceleration > 0).map(s => s.name)
                },
                { 
                    label: 'Tier Promotions', 
                    value: summary.tierPromotions,
                    score: (summary.tierPromotions / summary.totalStudents) * 150,
                    students: students.filter(s => s.tierChange > 0).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel >= 2.0 ? (avgVel - 1.5) * 80 : 0,
                    students: students.filter(s => s.velocity >= 2.0).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt >= 85 ? (avgAtt - 80) * 3 : 0,
                    students: students.filter(s => s.avgAttendance >= 85).map(s => s.name)
                },
                { 
                    label: 'High Performers', 
                    value: summary.superstars + ` (${(summary.superstars/summary.totalStudents*100).toFixed(0)}%)`,
                    score: (summary.superstars / summary.totalStudents) * 120,
                    students: students.filter(s => s.isSuperstar).map(s => s.name)
                },
                { 
                    label: 'Breakthrough Students', 
                    value: summary.breakthrough,
                    score: (summary.breakthrough / summary.totalStudents) * 100,
                    students: students.filter(s => s.trajectory === 'breakthrough').map(s => s.name)
                }
            ];
            
            // Sort and pick top 4 with score > 0
            const topChallenges = challengeCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            const topCelebrations = celebrationCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            // Store for click handling
            window.challengesData = topChallenges;
            window.celebrationsData = topCelebrations;
            
            document.getElementById('challengesContent').innerHTML = topChallenges.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showChallengeDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-danger">${c.value}</span>
                </div>
            `).join('');
            
            document.getElementById('celebrationsContent').innerHTML = topCelebrations.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showCelebrationDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-good">${c.value}</span>
                </div>
            `).join('');
        }
        
        function showChallengeDetail(index) {
            const item = window.challengesData[index];
            if (item.students.length > 0) {
                showFilteredList(item.students, item.label);
            }
        }
        
        function showCelebrationDetail(index) {
            const item = window.celebrationsData[index];
            if (item.students.length > 0) {
                const showTierChanges = item.label.includes('Tier Promotions');
                showFilteredList(item.students, item.label, showTierChanges);
            }
        }
        
        function renderAdvisorSpotlight() {
            const spotlight = dashboardData.advisorSpotlight;
            if (!spotlight) return;
            
            // Store spotlight data globally
            window.spotlightData = {
                improvingStudents: spotlight.students.filter(s => s.acceleration > 0).map(s => s.name),
                crisisStudents: spotlight.students.filter(s => s.tier === 1).map(s => s.name)
            };
            
            document.getElementById('advisorSpotlight').innerHTML = `
                <h2>üåü ${spotlight.spotlightTitle}</h2>
                <div class="spotlight-reason">${spotlight.spotlightReason}</div>
                <div class="advisor-spotlight-name">${spotlight.name}</div>
                <div class="spotlight-stats">
                    <div class="spotlight-stat" onclick="showSpotlightImproving()">
                        <div class="spotlight-stat-value">${spotlight.improving}/${spotlight.totalStudents}</div>
                        <div class="spotlight-stat-label">Students Improving (${spotlight.improvingPercent.toFixed(0)}%)</div>
                    </div>
                    <div class="spotlight-stat" onclick="showSpotlightCrisis()">
                        <div class="spotlight-stat-value">${spotlight.crisis}</div>
                        <div class="spotlight-stat-label">Crisis Students</div>
                    </div>
                    <div class="spotlight-stat" onclick="showVelocityTrend()">
                        <div class="spotlight-stat-value">${spotlight.avgVelocity.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Velocity (u/wk)</div>
                    </div>
                    <div class="spotlight-stat">
                        <div class="spotlight-stat-value">${spotlight.avgAcceleration > 0 ? '+' : ''}${spotlight.avgAcceleration.toFixed(2)}</div>
                        <div class="spotlight-stat-label">Avg Acceleration</div>
                    </div>
                </div>
            `;
        }
        
        function showSpotlightImproving() {
            showFilteredList(window.spotlightData.improvingStudents, dashboardData.advisorSpotlight.improving + " Students Improving");
        }
        
        function showSpotlightCrisis() {
            showFilteredList(window.spotlightData.crisisStudents, "Crisis Students");
        }
        
        function renderHighlights() {
            const highlights = dashboardData.highlights;
            
            // Store highlights data globally
            window.highlightsData = {
                topGainers: highlights.topGainers,
                topAccel: highlights.topAccel,
                perfectWeek: highlights.perfectWeek
            };
            
            document.getElementById('highlightsGrid').innerHTML = `
                <div class="highlight-card blue">
                    <h4>üèÖ Biggest Gains</h4>
                    <div class="highlight-students">
                        ${highlights.topGainers.map((s, idx) => `
                            <div class="highlight-student" data-category="topGainers" data-index="${idx}">
                                ${s.name}<br>
                                <span class="highlight-student-meta">${s.unitsGained} units this period!</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card teal">
                    <h4>üöÄ Most Improved</h4>
                    <div class="highlight-students">
                        ${highlights.topAccel.map((s, idx) => `
                            <div class="highlight-student" data-category="topAccel" data-index="${idx}">
                                ${s.name}<br>
                                <span class="highlight-student-meta">${s.earlyVelocity.toFixed(1)} ‚Üí ${s.recentVelocity.toFixed(1)} u/wk (+${s.acceleration.toFixed(1)})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card yellow">
                    <h4>üíØ Perfect Week Club</h4>
                    <div class="highlight-students">
                        <div style="padding: 1rem; text-align: center; background: white; border-radius: 6px; border: 2px solid #f59e0b;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${highlights.perfectWeek.length}</div>
                            <div style="font-size: 0.85rem; color: #666;">students with great<br>units + perfect attendance!</div>
                        </div>
                        ${highlights.perfectWeek.slice(0, 3).map((s, idx) => `
                            <div class="highlight-student" data-category="perfectWeek" data-index="${idx}">
                                ${s.name}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add event listeners using delegation
            document.getElementById('highlightsGrid').addEventListener('click', function(e) {
                const highlightStudent = e.target.closest('.highlight-student');
                if (highlightStudent) {
                    const category = highlightStudent.dataset.category;
                    const index = parseInt(highlightStudent.dataset.index);
                    if (category && !isNaN(index)) {
                        showStudentFromHighlight(category, index);
                    }
                }
            });
        }
        
        function showStudentFromHighlight(category, index) {
            const student = window.highlightsData[category][index];
            showStudentView(student.name);
        }
        
        function renderAdvisorCards() {
            const advisorStats = dashboardData.advisorStats;
            
            document.getElementById('advisorGrid').innerHTML = advisorStats.map((advisor, idx) => `
                <div class="advisor-card" onclick="showAdvisorByIndex(${idx})"> 
                    <div class="advisor-card-border grade-${advisor.grade.toLowerCase()}"></div>
                    <div class="advisor-card-content">
                        <div class="advisor-card-header">
                            <div class="advisor-card-name">${advisor.name}</div>
                            <div class="advisor-card-grade grade-${advisor.grade.toLowerCase()}">${advisor.grade}</div>
                        </div>
                        <div class="advisor-card-stats">
                            <div class="advisor-stat-item">
                                <div class="advisor-stat-label">Students</div>
                                <div class="advisor-stat-value">${advisor.totalStudents}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgVelocity, 'velocity')}">
                                <div class="advisor-stat-label">Avg Velocity</div>
                                <div class="advisor-stat-value">${advisor.avgVelocity.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.crisis, 'crisis', advisor.totalStudents)}">
                                <div class="advisor-stat-label">Crisis Students</div>
                                <div class="advisor-stat-value">${advisor.crisis} (${(advisor.crisis/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.superstars / advisor.totalStudents, 'superstars')}">
                                <div class="advisor-stat-label">High Performers</div>
                                <div class="advisor-stat-value">${advisor.superstars} (${(advisor.superstars/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAcceleration, 'acceleration')}">
                                <div class="advisor-stat-label">Avg Acceleration</div>
                                <div class="advisor-stat-value">${advisor.avgAcceleration > 0 ? '+' : ''}${advisor.avgAcceleration.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAttendance, 'attendance')}">
                                <div class="advisor-stat-label">Avg Attendance</div>
                                <div class="advisor-stat-value">${advisor.avgAttendance.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAdvisorByIndex(index) {
            const advisor = dashboardData.advisorStats[index];
            showAdvisorView(advisor.name);
        }
        
        function getHeatmapClass(value, metric, total = null) {
            switch(metric) {
                case 'velocity':
                    if (value >= 2.5) return 'heatmap-very-good';
                    if (value >= 2.0) return 'heatmap-good';
                    if (value >= 1.5) return 'heatmap-neutral';
                    if (value >= 1.0) return 'heatmap-warning';
                    if (value >= 0.5) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'crisis':
                    const ratio = value / total;
                    if (ratio === 0) return 'heatmap-very-good';
                    if (ratio < 0.05) return 'heatmap-good';
                    if (ratio < 0.10) return 'heatmap-neutral';
                    if (ratio < 0.15) return 'heatmap-warning';
                    if (ratio < 0.25) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'superstars':
                    if (value >= 0.3) return 'heatmap-very-good';
                    if (value >= 0.2) return 'heatmap-good';
                    if (value >= 0.1) return 'heatmap-neutral';
                    if (value >= 0.05) return 'heatmap-warning';
                    if (value >= 0.02) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'acceleration':
                    if (value >= 1.0) return 'heatmap-very-good';
                    if (value >= 0.5) return 'heatmap-good';
                    if (value >= -0.2) return 'heatmap-neutral';
                    if (value >= -0.5) return 'heatmap-warning';
                    if (value >= -1.0) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'attendance':
                    if (value >= 95) return 'heatmap-very-good';
                    if (value >= 90) return 'heatmap-good';
                    if (value >= 80) return 'heatmap-neutral';
                    if (value >= 70) return 'heatmap-warning';
                    if (value >= 60) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                default:
                    return 'heatmap-neutral';
            }
        }
        
        function renderMomentumTracker() {
            const summary = dashboardData.summary;
            
            // Calculate changes from previous week by comparing last two dates in current data
            let changes = {};
            if (dashboardData.sortedDates.length >= 2) {
                const lastDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 1];
                const prevDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 2];
                
                // Calculate trajectory counts for previous date
                const prevCounts = {
                    breakthrough: 0, building: 0, stable: 0, declining: 0, rapidDecline: 0
                };
                
                dashboardData.students.forEach(student => {
                    const recordsUpToPrev = student.records.filter(r => r.week <= prevDate);
                    if (recordsUpToPrev.length >= 2) {
                        const earliest = recordsUpToPrev[0];
                        const latest = recordsUpToPrev[recordsUpToPrev.length - 1];
                        const midPoint = Math.floor(recordsUpToPrev.length / 2);
                        const firstHalf = recordsUpToPrev.slice(0, midPoint);
                        const secondHalf = recordsUpToPrev.slice(midPoint);
                        
                        const earlyVel = firstHalf.length > 1 ? 
                            (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                        const recentVel = secondHalf.length > 1 ?
                            (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                        
                        const accel = recentVel - earlyVel;
                        
                        if (accel > 1.5) prevCounts.breakthrough++;
                        else if (accel > 0.5) prevCounts.building++;
                        else if (accel < -1.5) prevCounts.rapidDecline++;
                        else if (accel < -0.5) prevCounts.declining++;
                        else prevCounts.stable++;
                    }
                });
                
                changes = {
                    breakthrough: summary.breakthrough - prevCounts.breakthrough,
                    building: summary.building - prevCounts.building,
                    stable: summary.stableTrajectory - prevCounts.stable,
                    declining: summary.decliningTrajectory - prevCounts.declining,
                    rapidDecline: summary.rapidDecline - prevCounts.rapidDecline
                };
            }
            
            const categories = [
                { icon: 'üöÄ', label: 'Breakthrough', count: summary.breakthrough, filter: 'breakthrough', change: changes.breakthrough, isGood: true },
                { icon: 'üìà', label: 'Building', count: summary.building, filter: 'building', change: changes.building, isGood: true },
                { icon: '‚û°Ô∏è', label: 'Stable', count: summary.stableTrajectory, filter: 'stable', change: changes.stable, isGood: null },
                { icon: 'üìâ', label: 'Declining', count: summary.decliningTrajectory, filter: 'declining', change: changes.declining, isGood: false },
                { icon: '‚ö†Ô∏è', label: 'Rapid Decline', count: summary.rapidDecline, filter: 'rapid_decline', change: changes.rapidDecline, isGood: false }
            ];
            
            document.getElementById('momentumButtons').innerHTML = categories.map(cat => {
                let changeClass = '';
                let changeHTML = '';
                
                if (cat.change !== undefined && cat.change !== 0) {
                    // For good trajectories: increase = good (green), decrease = bad (red)
                    // For bad trajectories: increase = bad (red), decrease = good (green)
                    // For neutral: no color
                    if (cat.isGood === true) {
                        changeClass = cat.change > 0 ? 'positive' : 'negative';
                    } else if (cat.isGood === false) {
                        changeClass = cat.change > 0 ? 'negative' : 'positive'; // INVERTED!
                    }
                    changeHTML = `<div class="momentum-btn-change ${changeClass}">${cat.change > 0 ? '+' : ''}${cat.change}</div>`;
                }
                
                return `
                    <div class="momentum-btn" onclick="filterByMomentum('${cat.filter}')">
                        <div class="momentum-btn-icon">${cat.icon}</div>
                        <div class="momentum-btn-label">${cat.label}</div>
                        <div class="momentum-btn-count">${cat.count}</div>
                        ${changeHTML}
                    </div>
                `;
            }).join('');
        }
        
        function filterByMomentum(trajectory) {
            const students = dashboardData.students.filter(s => s.trajectory === trajectory);
            const labels = {
                'breakthrough': 'Breakthrough Students',
                'building': 'Building Momentum Students',
                'stable': 'Stable Students',
                'declining': 'Declining Students',
                'rapid_decline': 'Rapid Decline Students'
            };
            showFilteredList(students.map(s => s.name), labels[trajectory]);
        }
        
        function createWaterfallChart() {
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            
            // Calculate for each date
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const onTrackData = [];
            const strugglingData = [];
            const netLine = [];
            
            sortedDates.forEach(date => {
                let onTrack = 0;
                let struggling = 0;
                
                students.forEach(student => {
                    const record = student.records.find(r => r.week === date);
                    if (record) {
                        const tracking = record.completed - record.expected;
                        if (tracking >= 0) {
                            onTrack++;
                        } else {
                            struggling++;
                        }
                    }
                });
                
                onTrackData.push(onTrack);
                strugglingData.push(struggling);
                netLine.push(onTrack - struggling); // Net difference
            });
            
            const ctx = document.getElementById('waterfallChart');
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }
            
            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'On Track or Ahead',
                            data: onTrackData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            label: 'Below Target',
                            data: strugglingData.map(v => -v), // Negative for stacking
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            type: 'line',
                            label: 'Net Balance',
                            data: netLine,
                            borderColor: '#333',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#333',
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Number of Students (Net Balance)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.type === 'line') {
                                        const val = context.parsed.y;
                                        label += (val > 0 ? '+' : '') + val + ' net';
                                    } else {
                                        label += Math.abs(context.parsed.y) + ' students';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showAdvisorView(advisorName) {
            currentAdvisor = advisorName;
            const students = dashboardData.advisorMap.get(advisorName);
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.add('active');
            
            const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
            const improving = students.filter(s => s.acceleration > 0).length;
            
            document.getElementById('advisorViewHeader').innerHTML = `
                <div class="student-view-header">
                    <div class="student-view-name">${advisorName}</div>
                    <div class="student-view-meta">
                        ${students.length} Students ‚Ä¢ Avg Velocity: ${avgVel.toFixed(2)} u/wk ‚Ä¢ ${improving} Improving
                    </div>
                </div>
            `;
            
            renderAdvisorStudentTable();
        }
        
        function renderStudentTable() {
            let filtered = dashboardData.students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            if (currentFilters.trajectory !== 'all') {
                filtered = filtered.filter(s => s.trajectory === currentFilters.trajectory);
            }
            if (currentFilters.search) {
                const search = currentFilters.search.toLowerCase();
                filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'name': aVal = a.name; bVal = b.name; break;
                    case 'tier': aVal = a.tier; bVal = b.tier; break;
                    case 'velocity': aVal = a.velocity; bVal = b.velocity; break;
                    case 'acceleration': aVal = a.acceleration; bVal = b.acceleration; break;
                    case 'behind': aVal = a.tracking; bVal = b.tracking; break;
                    case 'units': aVal = a.currentUnits; bVal = b.currentUnits; break;
                    case 'days_since': aVal = a.daysSince; bVal = b.daysSince; break;
                    case 'attendance': aVal = a.avgAttendance; bVal = b.avgAttendance; break;
                    default: aVal = a.velocity; bVal = b.velocity;
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            document.getElementById('studentTableBody').innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${s.name}${s.isNew ? ' <span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>${s.acceleration > 0 ? '+' : ''}${s.acceleration.toFixed(2)}</td>
                    <td>
                        <div class="consistency-dots">
                            ${s.patternDisplay.map(p => `<div class="consistency-dot ${p.filled ? 'filled' : 'empty'}"></div>`).join('')}
                            <span class="consistency-label">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td>${s.badges.slice(0, 3).map(b => b.icon).join(' ')}</td>
                    <td>${s.currentUnits}</td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#ef4444'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showStudentByIndex(index) {
            const student = dashboardData.students[index];
            if (student) showStudentView(student.name);
        }
        
        function renderAdvisorStudentTable() {
            const students = dashboardData.advisorMap.get(currentAdvisor);
            let filtered = students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            
            document.getElementById('advisorStudentTableBody').innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${s.name}${s.isNew ? ' <span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>${s.acceleration > 0 ? '+' : ''}${s.acceleration.toFixed(2)}</td>
                    <td>
                        <div class="consistency-dots">
                            ${s.patternDisplay.map(p => `<div class="consistency-dot ${p.filled ? 'filled' : 'empty'}"></div>`).join('')}
                            <span class="consistency-label">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td>${s.badges.slice(0, 3).map(b => b.icon).join(' ')}</td>
                    <td>${s.currentUnits}</td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#ef4444'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showStudentView(studentName) {
            const student = dashboardData.students.find(s => s.name === studentName);
            if (!student) return;
            
            currentStudent = student;
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('studentView').classList.add('active');
            
            renderStudentView(student);
        }
        
        function renderStudentView(student) {
            // Header
            document.getElementById('studentViewHeader').innerHTML = `
                <div class="student-view-name">${student.name}</div>
                <div class="student-view-meta">
                    ${student.tierLabel} ‚Ä¢ ${student.advisor}
                </div>
            `;
            
            // Metrics Grid
            const metrics = [
                { label: 'Completed Units', value: student.currentUnits, heatmap: false },
                { label: 'Ahead/Behind', value: (student.tracking > 0 ? '+' : '') + student.tracking, heatmap: false },
                { label: 'Velocity', value: student.velocity.toFixed(2) + ' u/wk', heatmap: true, type: 'velocity' },
                { label: 'Acceleration', value: (student.acceleration > 0 ? '+' : '') + student.acceleration.toFixed(2), heatmap: true, type: 'acceleration' },
                { label: 'Attendance', value: student.avgAttendance.toFixed(1) + '%', heatmap: true, type: 'attendance' },
                { label: 'Consistency', value: student.consistencyLabel, heatmap: false },
                { label: 'Days Since Activity', value: student.daysSince, heatmap: false },
                { label: 'Badges Earned', value: student.badges.length, heatmap: false }
            ];
            
            document.getElementById('studentMetricsGrid').innerHTML = metrics.map(m => `
                <div class="student-metric-card ${m.heatmap ? getHeatmapClass(m.type === 'velocity' ? student.velocity : m.type === 'acceleration' ? student.acceleration : student.avgAttendance, m.type) : ''}">
                    <div class="student-metric-label">${m.label}</div>
                    <div class="student-metric-value">${m.value}</div>
                </div>
            `).join('');
            
            // Progress Chart
            createStudentProgressChart(student);
            
            // Consistency Pattern
            document.getElementById('studentPatternDetail').innerHTML = `
                <div class="consistency-dots" style="margin-bottom: 1rem;">
                    ${student.patternDisplay.map(p => `<div class="consistency-dot ${p.filled ? 'filled' : 'empty'}"></div>`).join('')}
                    <span class="consistency-label">${student.consistencyIcon} ${student.consistencyLabel}</span>
                </div>
                <p><strong>Consistency Ratio:</strong> ${(student.consistencyRatio * 100).toFixed(0)}%</p>
                <p><strong>Weeks Meeting Goal (2+ units):</strong> ${student.patternDisplay.filter(p => p.filled).length} of ${student.records.length}</p>
            `;
            
            // Achievements with badges
            if (student.badges.length > 0) {
                document.getElementById('studentAchievements').innerHTML = student.badges.map(b => `
                    <li>
                        <div class="badge-item">
                            <span class="badge-icon">${b.icon}</span>
                            <span class="badge-text">${b.name}</span>
                        </div>
                    </li>
                `).join('');
            } else {
                document.getElementById('studentAchievements').innerHTML = '<li>Working towards achievements - keep it up!</li>';
            }
            
            // Concerns
            const concerns = [];
            if (student.tier === 1) concerns.push('Crisis tier - immediate intervention needed');
            if (student.tier === 2) concerns.push('High risk - requires close monitoring');
            if (student.avgAttendance < 70) concerns.push('Low attendance - major concern');
            if (student.velocity < 1) concerns.push('Low velocity - may need additional support');
            if (student.acceleration < -1) concerns.push('Rapid decline in performance');
            if (student.daysSince > 14) concerns.push('No recent activity - follow up needed');
            if (student.consistencyRatio < 0.5) concerns.push('Inconsistent performance - needs support establishing routine');
            
            document.getElementById('studentConcerns').innerHTML = concerns.length > 0 ?
                concerns.map(c => `<li>${c}</li>`).join('') :
                '<li>No major concerns at this time - keep up the good work!</li>';
        }
        
        function createStudentProgressChart(student) {
            let records = student.records;
            
            // Filter by semester if needed
            if (currentSemester === 'fall') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 7 && month <= 11;
                });
            } else if (currentSemester === 'spring') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 0 && month <= 4;
                });
            }
            
            const ctx = document.getElementById('studentProgressChart');
            
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
            
            const dates = records.map(r => new Date(r.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const completed = records.map(r => r.completed);
            const expected = records.map(r => r.expected);
            
            studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Units Completed',
                            data: completed,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Expected Units',
                            data: expected,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units'
                            }
                        }
                    }
                }
            });
        }
        
        function showFilteredList(studentNames, title, showTierChanges = false) {
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('filteredListView').classList.add('active');
            
            document.getElementById('filteredListHeader').innerHTML = `
                <div class="student-view-name">${title}</div>
                <div class="student-view-meta">${studentNames.length} Students</div>
            `;
            
            const students = dashboardData.students.filter(s => studentNames.includes(s.name));
            
            const tierNames = ['', 'Crisis', 'High Risk', 'Watch', 'On Track', 'Superstar'];
            
            document.getElementById('filteredTableBody').innerHTML = students.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                const tierChangeText = showTierChanges && s.tierChange > 0 ? 
                    `<br><small style="color: #059669;">${tierNames[s.firstTier]} ‚Üí ${tierNames[s.tier]}</small>` : '';
                    
                return `
                <tr onclick="showStudentByIndex(${studentIndex})">
                    <td><span class="student-name-link">${s.name}${tierChangeText}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? '#10b981' : '#ef4444'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showVelocityTrend() {
            // Create modal for velocity trend
            const modal = document.createElement('div');
            modal.id = 'velocityModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">Average Velocity Trend</h2>
                        <button onclick="document.getElementById('velocityModal').remove()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <canvas id="velocityTrendChart"></canvas>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Calculate average velocity for each date
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            const labels = [];
            const avgVelocities = [];
            
            sortedDates.forEach((date, dateIndex) => {
                labels.push(new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let totalVelocity = 0;
                let count = 0;
                
                students.forEach(student => {
                    // Calculate velocity up to this point
                    const recordsUpToDate = student.records.filter(r => new Date(r.week) <= new Date(date));
                    if (recordsUpToDate.length >= 2) {
                        const earliest = recordsUpToDate[0];
                        const latest = recordsUpToDate[recordsUpToDate.length - 1];
                        const weeks = recordsUpToDate.length - 1;
                        const velocity = (latest.completed - earliest.completed) / weeks;
                        totalVelocity += velocity;
                        count++;
                    }
                });
                
                avgVelocities.push(count > 0 ? totalVelocity / count : 0);
            });
            
            const ctx = document.getElementById('velocityTrendChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Average Velocity (u/wk)',
                        data: avgVelocities,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#667eea'
                    }, {
                        label: 'Target (2.0 u/wk)',
                        data: Array(labels.length).fill(2.0),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' u/wk';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Velocity (units/week)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    }
                }
            });
        }
        
        function backToMain() {
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('mainView').classList.add('active');
            currentAdvisor = null;
            currentStudent = null;
            currentFilters = { tier: 'all', trajectory: 'all', search: '' };
            
            // Reset filters UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('active');
                }
            });
            
            // Clear search
            document.getElementById('searchBox').value = '';
            
            renderStudentTable();
        }
        
        function setupEventListeners() {
            // Search box - auto reset filters
            document.getElementById('searchBox').addEventListener('input', (e) => {
                // Reset filters when searching
                currentFilters.tier = 'all';
                currentFilters.trajectory = 'all';
                currentFilters.search = e.target.value;
                
                // Update filter button states
                document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });
                
                renderStudentTable();
            });
            
            // Filter buttons - main view
            document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#mainView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderStudentTable();
                });
            });
            
            // Filter buttons - advisor view
            document.querySelectorAll('#advisorView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#advisorView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderAdvisorStudentTable();
                });
            });
            
            // Sortable columns
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    if (currentAdvisor) {
                        renderAdvisorStudentTable();
                    } else {
                        renderStudentTable();
                    }
                });
            });
            
            // Semester filters on student view
            document.querySelectorAll('.semester-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.semester-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSemester = btn.dataset.semester;
                    if (currentStudent) {
                        createStudentProgressChart(currentStudent);
                    }
                });
            });
        }
        
        // ================== SMART RECOMMENDATIONS ==================
        async function generateAIRecommendations() {
            const modal = document.createElement('div');
            modal.id = 'recommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">üéØ Smart Intervention Recommendations</h2>
                        <button onclick="document.getElementById('recommendationsModal').remove()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <div id="aiRecommendationsContent">
                        ${generateSmartRecommendations()}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateSmartRecommendations() {
            const students = dashboardData.students;
            const summary = dashboardData.summary;
            
            // Priority students
            const crisisStudents = students.filter(s => s.tier === 1);
            const highRiskStudents = students.filter(s => s.tier === 2);
            const rapidDeclineStudents = students.filter(s => s.trajectory === 'rapid_decline');
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 80);
            
            let html = '<div style="line-height: 1.8;">';
            
            // School-wide recommendations
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">üìä School-Wide Priorities</h3>';
            
            const schoolWideRecs = [];
            
            if (summary.avgVelocity < 1.8) {
                schoolWideRecs.push(`<strong>Velocity Boost Needed:</strong> Class average is ${summary.avgVelocity.toFixed(2)} u/wk (target: 2.0). Consider school-wide pacing strategies.`);
            } else if (summary.avgVelocity >= 2.2) {
                schoolWideRecs.push(`<strong>Strong Momentum:</strong> Class average velocity of ${summary.avgVelocity.toFixed(2)} u/wk exceeds targets. Maintain current strategies.`);
            }
            
            if (summary.avgAttendance < 85) {
                schoolWideRecs.push(`<strong>Attendance Intervention:</strong> Average attendance at ${summary.avgAttendance.toFixed(1)}% (target: 85%+). Implement attendance improvement campaign.`);
            }
            
            const crisisPercent = ((summary.crisis + summary.highRisk) / summary.totalStudents * 100);
            if (crisisPercent > 15) {
                schoolWideRecs.push(`<strong>High Risk Alert:</strong> ${crisisPercent.toFixed(0)}% of students in crisis/high risk. Consider additional support resources.`);
            }
            
            if (summary.rapidDecline > 3) {
                schoolWideRecs.push(`<strong>Declining Trend:</strong> ${summary.rapidDecline} students showing rapid decline. Early intervention critical.`);
            }
            
            html += '<ul style="margin: 1rem 0;">';
            schoolWideRecs.slice(0, 3).forEach(rec => {
                html += `<li style="margin-bottom: 0.75rem;">${rec}</li>`;
            });
            html += '</ul>';
            
            // Individual student interventions
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-top: 2rem;">üë• Priority Student Interventions</h3>';
            
            const priorityStudents = [
                ...crisisStudents.slice(0, 3),
                ...rapidDeclineStudents.filter(s => !crisisStudents.includes(s)).slice(0, 2),
                ...highRiskStudents.filter(s => !crisisStudents.includes(s) && !rapidDeclineStudents.includes(s)).slice(0, 3)
            ].slice(0, 8);
            
            html += '<ul style="margin: 1rem 0;">';
            priorityStudents.forEach(s => {
                let reason = '';
                let action = '';
                
                if (s.tier === 1) {
                    reason = `Crisis tier (${s.tracking} units behind)`;
                    action = 'Immediate one-on-one support, attendance check, family contact';
                } else if (s.trajectory === 'rapid_decline') {
                    reason = `Rapid decline (${s.trajectoryLabel}, acceleration ${s.acceleration.toFixed(1)})`;
                    action = 'Identify cause of decline, adjust pacing plan, increase check-ins';
                } else if (s.avgAttendance < 75) {
                    reason = `Low attendance (${s.avgAttendance.toFixed(1)}%)`;
                    action = 'Attendance intervention, transportation/barriers check';
                } else {
                    reason = `High risk (${s.tracking} behind, ${s.velocity.toFixed(1)} u/wk)`;
                    action = 'Create catch-up plan, monitor weekly progress';
                }
                
                html += `<li style="margin-bottom: 1rem;">
                    <strong>${s.name}</strong> - ${reason}<br>
                    <span style="color: #059669; font-size: 0.9rem;">‚Üí ${action}</span>
                </li>`;
            });
            html += '</ul>';
            
            // Quick wins
            html += '<h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-top: 2rem;">‚ö° Quick Wins (Immediate Actions)</h3>';
            html += '<ul style="margin: 1rem 0;">';
            
            const quickWins = [];
            
            if (lowAttendanceStudents.length > 5) {
                quickWins.push(`Contact ${lowAttendanceStudents.slice(0, 5).map(s => s.name).join(', ')} about attendance barriers`);
            }
            
            const stuckStudents = students.filter(s => s.daysSince > 14);
            if (stuckStudents.length > 0) {
                quickWins.push(`${stuckStudents.length} students haven't completed units in 14+ days - immediate check-in needed`);
            }
            
            const nearPromotion = students.filter(s => s.tier === 3 && s.tracking >= -2);
            if (nearPromotion.length > 0) {
                quickWins.push(`${nearPromotion.length} students close to tier promotion - encourage final push`);
            }
            
            quickWins.forEach(win => {
                html += `<li style="margin-bottom: 0.75rem;">${win}</li>`;
            });
            
            html += '</ul>';
            
            // Summary stats
            html += `<div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">
                <strong>Analysis Summary:</strong><br>
                Total Students: ${summary.totalStudents} | 
                Crisis/High Risk: ${summary.crisis + summary.highRisk} (${crisisPercent.toFixed(0)}%) | 
                Superstars: ${summary.superstars} | 
                Avg Velocity: ${summary.avgVelocity.toFixed(2)} u/wk | 
                Avg Attendance: ${summary.avgAttendance.toFixed(1)}%
            </div>`;
            
            html += '<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; color: #999; font-size: 0.85rem;">';
            html += `Generated ${new Date().toLocaleString()} ‚Ä¢ Based on ${students.length} students ‚Ä¢ ${dashboardData.sortedDates.length} data points`;
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        // ================== PDF EXPORT ==================
        function exportToPDF() {
            // Hide action buttons temporarily
            const actionButtons = document.querySelector('div[style*="display: flex"]');
            if (actionButtons) actionButtons.style.display = 'none';
            
            // Trigger print dialog (user can save as PDF)
            window.print();
            
            // Restore buttons after print
            setTimeout(() => {
                if (actionButtons) actionButtons.style.display = 'flex';
            }, 100);
        }
        
        // ================== INITIALIZE ==================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
